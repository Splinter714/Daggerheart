import{r as f,a as wt,R as Ke}from"./dndkit-57209f9c.js";import{F as dr,f as cr,a as ur,b as pr,c as Mt}from"./fa-b4bcccb0.js";import{D as mr,A as fr,C as Jt,X as nt,M as ct,P as Xe,a as hr,H as xr,L as gr,F as yr,S as gt,b as yt,T as Nt,c as zt,B as Wt}from"./lucide-e69a925c.js";(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const d of document.querySelectorAll('link[rel="modulepreload"]'))i(d);new MutationObserver(d=>{for(const l of d)if(l.type==="childList")for(const c of l.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function o(d){const l={};return d.integrity&&(l.integrity=d.integrity),d.referrerPolicy&&(l.referrerPolicy=d.referrerPolicy),d.crossOrigin==="use-credentials"?l.credentials="include":d.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function i(d){if(d.ep)return;d.ep=!0;const l=o(d);fetch(d.href,l)}})();var Yt={exports:{}},mt={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var vr=f,br=Symbol.for("react.element"),wr=Symbol.for("react.fragment"),Sr=Object.prototype.hasOwnProperty,Cr=vr.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,jr={key:!0,ref:!0,__self:!0,__source:!0};function Xt(e,a,o){var i,d={},l=null,c=null;o!==void 0&&(l=""+o),a.key!==void 0&&(l=""+a.key),a.ref!==void 0&&(c=a.ref);for(i in a)Sr.call(a,i)&&!jr.hasOwnProperty(i)&&(d[i]=a[i]);if(e&&e.defaultProps)for(i in a=e.defaultProps,a)d[i]===void 0&&(d[i]=a[i]);return{$$typeof:br,type:e,key:l,ref:c,props:d,_owner:Cr.current}}mt.Fragment=wr;mt.jsx=Xt;mt.jsxs=Xt;Yt.exports=mt;var t=Yt.exports,St={},Lt=wt;St.createRoot=Lt.createRoot,St.hydrateRoot=Lt.hydrateRoot;function qe(e){if(typeof localStorage>"u")return null;try{const a=localStorage.getItem(e);return a==null?null:JSON.parse(a)}catch{return null}}function Je(e,a){if(!(typeof localStorage>"u"))try{localStorage.setItem(e,JSON.stringify(a))}catch{}}function Qe(e){const a=typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random().toString(36).slice(2,10)}`;return e?`${e}-${a}`:a}function kr(e=[]){const[a,o]=f.useState(e),i=f.useRef(!0);return f.useEffect(()=>{if(i.current){i.current=!1;return}const p=qe("daggerheart-game-state")||{};Je("daggerheart-game-state",{...p,adversaries:a})},[a]),{adversaries:a,createAdversary:p=>{var h;const x=Qe("adv"),m=p.baseName||((h=p.name)==null?void 0:h.replace(/\s+\(\d+\)$/,""))||p.name||"Unknown",r=a.filter(S=>S.baseName===m);let s=1;if(r.length>0){const S=r.map($=>$.duplicateNumber||1);let b=1;for(;S.includes(b);)b++;s=b}const n={...p,id:x,baseName:m,duplicateNumber:s,name:`${m} (${s})`,hp:0,stress:0,isVisible:!0};o(S=>[...S,n])},createAdversariesBulk:p=>{const x=[],m={};p.forEach(r=>{var L;const s=r.baseName||((L=r.name)==null?void 0:L.replace(/\s+\(\d+\)$/,""))||r.name||"Unknown",h=a.filter(_=>_.baseName===s).length,S=m[s]||0,b=h+S+1;m[s]=S+1;const $={...r,id:Qe("adv"),baseName:s,duplicateNumber:b,name:`${s} (${b})`,hp:0,stress:0,isVisible:!0};x.push($)}),o(r=>[...r,...x])},updateAdversary:(p,x)=>{o(m=>m.map(r=>{if(r.id===p){const s={...r,...x};if(x.baseName!==void 0){const n=x.baseName,h=s.duplicateNumber||1;s.name=h===1?n:`${n} (${h})`}return s}return r}))},deleteAdversary:p=>{o(x=>x.filter(m=>m.id!==p))}}}function Er(e=[]){const[a,o]=f.useState(e),i=f.useRef(!0);return f.useEffect(()=>{if(i.current){i.current=!1;return}const m=qe("daggerheart-game-state")||{};Je("daggerheart-game-state",{...m,countdowns:a})},[a]),{countdowns:a,createCountdown:m=>{const r={id:Qe("countdown"),name:m.name||"Countdown",max:parseInt(m.max)||1,value:0,visible:!0,type:m.type||"standard",loop:m.loop||"none",source:m.source||"campaign"};o(s=>[...s,r])},updateCountdown:(m,r)=>{o(s=>s.map(n=>n.id===m?{...n,...r}:n))},deleteCountdown:m=>{o(r=>r.filter(s=>s.id!==m))},advanceCountdown:(m,r)=>{o(s=>s.map(n=>{if(n.id!==m)return n;let h=r;if(n.loop==="loop")h>n.max?h=(h-1)%n.max+1:h<0&&(h=n.max);else if(n.loop==="increasing"){if(h>n.max)return{...n,max:n.max+1,value:1};if(h<0)return{...n,max:Math.max(1,n.max-1),value:1};h=Math.max(0,h)}else if(n.loop==="decreasing"){if(h>n.max)return{...n,max:Math.max(1,n.max-1),value:1};if(h<0)return{...n,max:n.max+1,value:1};h=Math.min(n.max,h)}else h=Math.max(0,Math.min(h,n.max));return{...n,value:h}}))},incrementCountdown:(m,r=1)=>{o(s=>s.map(n=>{if(n.id!==m)return n;let h=n.value+r;if(n.loop==="loop")h>n.max&&(h=(h-1)%n.max+1);else if(n.loop==="increasing"){if(h>n.max)return{...n,max:n.max+1,value:1}}else if(n.loop==="decreasing"){if(h>n.max)return{...n,max:Math.max(1,n.max-1),value:1}}else h=Math.min(h,n.max);return{...n,value:h}}))},decrementCountdown:m=>{o(r=>r.map(s=>{if(s.id!==m)return s;let n=s.value-1;if(s.loop==="loop")n<0&&(n=s.max);else if(s.loop==="increasing"){if(n<0)return{...s,max:Math.max(1,s.max-1),value:s.max};n=Math.max(0,n)}else if(s.loop==="decreasing"){if(n<0)return{...s,max:s.max+1,value:1}}else n=Math.max(0,n);return{...s,value:n}}))}}}function Ar(e=[]){const[a,o]=f.useState(e),i=f.useRef(!0);return f.useEffect(()=>{if(i.current){i.current=!1;return}const u=qe("daggerheart-game-state")||{};Je("daggerheart-game-state",{...u,environments:a})},[a]),{environments:a,createEnvironment:u=>{const p=Qe("env"),m=(a||[]).filter(n=>n.name.replace(/\s+\(\d+\)$/,"")===u.name);let r=u.name||"Unknown";if(m.length===0)r=u.name;else if(m.length===1){const n=m[0],h=n.name.replace(/\s+\(\d+\)$/,""),S=a.map(b=>b.id===n.id?{...b,name:`${h} (1)`}:b);o(S),r=`${u.name} (2)`}else{const n=m.map(S=>{const b=S.name.match(/\((\d+)\)$/);return b?parseInt(b[1]):null}).filter(S=>S!==null);let h=1;for(;n.includes(h);)h++;r=`${u.name} (${h})`}const s={...u,id:p,name:r,isVisible:!0};o(n=>[...n,s])},updateEnvironment:(u,p)=>{o(x=>x.map(m=>m.id===u?{...m,...p}:m))},deleteEnvironment:u=>{o(p=>p.filter(x=>x.id!==u))}}}function Ir(e=[],a="Encounter"){const[o,i]=f.useState(e),[d,l]=f.useState(a),c=f.useRef(!0);return f.useEffect(()=>{if(c.current){c.current=!1;return}const r=qe("daggerheart-game-state")||{};Je("daggerheart-game-state",{...r,savedEncounters:o,currentEncounterName:d})},[o,d]),{savedEncounters:o,currentEncounterName:d,saveEncounter:r=>{if(r.id)return i(s=>s.map(n=>n.id===r.id?{...n,name:r.name||n.name,encounterItems:r.encounterItems||n.encounterItems,partySize:r.partySize||n.partySize,battlePointsAdjustments:r.battlePointsAdjustments||n.battlePointsAdjustments,updatedAt:new Date().toISOString()}:n)),r.id;{const s={id:Qe("encounter"),name:r.name||"Encounter",createdAt:new Date().toISOString(),encounterItems:r.encounterItems||[],partySize:r.partySize||4,battlePointsAdjustments:r.battlePointsAdjustments||{}};return i(n=>[...n,s]),s.id}},loadEncounter:r=>o.find(s=>s.id===r),deleteEncounter:r=>{i(s=>s.filter(n=>n.id!==r))},updateCurrentEncounterName:r=>{l(r||"Encounter")}}}function Tr(e={value:0,visible:!1},a=4){const[o,i]=f.useState(e),[d,l]=f.useState(a),c=f.useRef(!0);return f.useEffect(()=>{if(c.current){c.current=!1;return}const x=qe("daggerheart-game-state")||{};Je("daggerheart-game-state",{...x,fear:o,partySize:d})},[o,d]),{fear:o,partySize:d,updateFear:x=>{i(m=>({...m,value:x}))},updatePartySize:x=>{l(Math.max(1,x))}}}function Mr(){const[e,a]=f.useState({adversaries:[],environments:[]});return f.useEffect(()=>{const l=qe("daggerheart-custom-adversaries")||[],c=qe("daggerheart-custom-environments")||[];a({adversaries:l,environments:c})},[]),f.useEffect(()=>{Je("daggerheart-custom-adversaries",e.adversaries)},[e.adversaries]),f.useEffect(()=>{Je("daggerheart-custom-environments",e.environments)},[e.environments]),{customContent:e,addCustomAdversary:l=>{const c={...l,id:Qe("custom-adv"),source:l.source||"Homebrew",isCustom:!0};return a(u=>({...u,adversaries:[...u.adversaries,c]})),c.id},updateCustomAdversary:(l,c)=>{a(u=>({...u,adversaries:u.adversaries.map(p=>p.id===l?{...p,...c}:p)}))},deleteCustomAdversary:l=>{a(c=>({...c,adversaries:c.adversaries.filter(u=>u.id!==l)}))}}}const Qt=f.createContext(),Nr=({children:e})=>{const[a,o]=f.useState(!1),[i,d]=f.useState(()=>qe("daggerheart-game-state")||{fear:{value:0,visible:!1},countdowns:[],adversaries:[],environments:[],partySize:4,savedEncounters:[],currentEncounterName:"Encounter"}),l=Tr(i.fear,i.partySize),c=kr(i.adversaries||[]),u=Er(i.countdowns||[]),p=Ar(i.environments||[]),x=Ir(i.savedEncounters||[],i.currentEncounterName||"Encounter"),m=Mr();f.useEffect(()=>{o(!0)},[]);const s={gameState:{fear:l.fear,countdowns:u.countdowns,adversaries:c.adversaries,environments:p.environments,partySize:l.partySize,savedEncounters:x.savedEncounters,currentEncounterName:x.currentEncounterName},isLoaded:a,customContent:m.customContent,updateFear:l.updateFear,updatePartySize:l.updatePartySize,updateCurrentEncounterName:x.updateCurrentEncounterName,saveEncounter:x.saveEncounter,loadEncounter:x.loadEncounter,deleteEncounter:x.deleteEncounter,createCountdown:u.createCountdown,updateCountdown:u.updateCountdown,deleteCountdown:u.deleteCountdown,advanceCountdown:u.advanceCountdown,incrementCountdown:u.incrementCountdown,decrementCountdown:u.decrementCountdown,createAdversary:c.createAdversary,createAdversariesBulk:c.createAdversariesBulk,updateAdversary:c.updateAdversary,deleteAdversary:c.deleteAdversary,createEnvironment:p.createEnvironment,updateEnvironment:p.updateEnvironment,deleteEnvironment:p.deleteEnvironment,addCustomAdversary:m.addCustomAdversary,updateCustomAdversary:m.updateCustomAdversary,deleteCustomAdversary:m.deleteCustomAdversary};return t.jsx(Qt.Provider,{value:s,children:e})},ft=()=>{const e=f.useContext(Qt);if(!e)return console.warn("useGameState: Context not available yet, returning defaults"),{isLoaded:!1,fear:{value:0,visible:!1},countdowns:[],adversaries:[],environments:[],partySize:4,savedEncounters:[],customContent:{adversaries:[],environments:[]},updateFear:()=>{},updatePartySize:()=>{},updateCurrentEncounterName:()=>{},saveEncounter:()=>{},loadEncounter:()=>{},deleteEncounter:()=>{},createCountdown:()=>{},updateCountdown:()=>{},deleteCountdown:()=>{},advanceCountdown:()=>{},incrementCountdown:()=>{},decrementCountdown:()=>{},createAdversary:()=>{},updateAdversary:()=>{},deleteAdversary:()=>{},createEnvironment:()=>{},updateEnvironment:()=>{},deleteEnvironment:()=>{},addCustomAdversary:()=>{},updateCustomAdversary:()=>{},deleteCustomAdversary:()=>{},hasCountdowns:!1,hasAdversaries:!1,hasEnvironments:!1,getCountdownById:()=>null,getAdversaryById:()=>null,getEnvironmentById:()=>null};const{gameState:a,customContent:o,...i}=e;if(!a)return console.warn("useGameState: gameState not available, returning defaults"),{isLoaded:e.isLoaded||!1,fear:{value:0,visible:!1},countdowns:[],adversaries:[],environments:[],partySize:4,savedEncounters:[],customContent:{adversaries:[],environments:[]},updateFear:()=>{},updatePartySize:()=>{},updateCurrentEncounterName:()=>{},saveEncounter:()=>{},loadEncounter:()=>{},deleteEncounter:()=>{},createCountdown:()=>{},updateCountdown:()=>{},deleteCountdown:()=>{},advanceCountdown:()=>{},incrementCountdown:()=>{},decrementCountdown:()=>{},createAdversary:()=>{},updateAdversary:()=>{},deleteAdversary:()=>{},createEnvironment:()=>{},updateEnvironment:()=>{},deleteEnvironment:()=>{},addCustomAdversary:()=>{},updateCustomAdversary:()=>{},deleteCustomAdversary:()=>{},hasCountdowns:!1,hasAdversaries:!1,hasEnvironments:!1,getCountdownById:()=>null,getAdversaryById:()=>null,getEnvironmentById:()=>null};const{fear:d,countdowns:l,adversaries:c,environments:u,partySize:p,savedEncounters:x}=a;return{gameState:a,isLoaded:e.isLoaded,fear:d,countdowns:l,adversaries:c,environments:u,partySize:p,savedEncounters:x,customContent:o,...i,hasCountdowns:l.length>0,hasAdversaries:c.length>0,hasEnvironments:u.length>0,getCountdownById:m=>l.find(r=>r.id===m),getAdversaryById:m=>c.find(r=>r.id===m),getEnvironmentById:m=>u.find(r=>r.id===m)}},je=12,at=48,zr=()=>t.jsx("div",{className:"pwa-install-prompt",style:{}}),Ct=({tabContent:e,children:a,containerStyle:o={},tabStyle:i={},showTab:d=!0,tabBackgroundColor:l="var(--bg-primary)",tabBorderColor:c="var(--border)",tabJustifyContent:u="center",containerBackgroundColor:p,containerBorderColor:x,containerBorderRadius:m="8px",containerBoxShadow:r,containerOverflow:s="hidden",reserveTabSpace:n=!1,style:h={},...S})=>{const b={display:"flex",flexDirection:"column",position:"relative",height:"100%",width:"100%",borderRadius:m,overflow:s};p&&(b.backgroundColor=p),x&&(b.border=`2px solid ${x}`),r&&(b.boxShadow=r);const $={position:"relative",overflow:"visible",height:"100%",width:"100%",display:"flex",flexDirection:"column",boxSizing:"border-box"},L=n?"0":`-${at}px`,_=n&&d&&e?`${at}px`:"0";return t.jsxs("div",{style:{...$,...h},...S,children:[d&&e&&t.jsx("div",{style:{position:"absolute",top:L,left:"7px",right:"7px",width:"calc(100% - 14px)",display:"flex",alignItems:"center",gap:"0.5rem",justifyContent:u,flexShrink:0,zIndex:0,padding:"0.5rem 0.75rem",paddingBottom:"calc(0.5rem + 4px)",minHeight:`${at}px`,backgroundColor:l,border:`1.5px solid ${c}`,borderBottom:"none",borderRadius:"8px 8px 0 0",boxSizing:"border-box",marginBottom:"-4px",...i},children:e}),t.jsx("div",{style:{...b,...o,zIndex:1,marginTop:_},children:a})]})},Wr="modulepreload",Lr=function(e){return"/Daggerheart/"+e},Rt={},Ye=function(a,o,i){if(!o||o.length===0)return a();const d=document.getElementsByTagName("link");return Promise.all(o.map(l=>{if(l=Lr(l),l in Rt)return;Rt[l]=!0;const c=l.endsWith(".css"),u=c?'[rel="stylesheet"]':"";if(!!i)for(let m=d.length-1;m>=0;m--){const r=d[m];if(r.href===l&&(!c||r.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${l}"]${u}`))return;const x=document.createElement("link");if(x.rel=c?"stylesheet":Wr,c||(x.as="script",x.crossOrigin=""),x.href=l,document.head.appendChild(x),c)return new Promise((m,r)=>{x.addEventListener("load",m),x.addEventListener("error",()=>r(new Error(`Unable to preload CSS for ${l}`)))})})).then(()=>a()).catch(l=>{const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=l,window.dispatchEvent(c),!c.defaultPrevented)throw l})},Bt={Minion:{difficulty:e=>[9,12,15,18][e-1],thresholds:e=>({major:0,severe:0}),hpMax:e=>1,stressMax:e=>1,atk:e=>[-1,0,1,2][e-1],damage:e=>["2","5","8","11"][e-1],range:"Melee"},Standard:{difficulty:e=>[11,14,17,20][e-1],thresholds:e=>({major:[7,10,20,25][e-1],severe:[12,20,32,45][e-1]}),hpMax:e=>[4,5,6,7][e-1],stressMax:e=>[3,3,4,4][e-1],atk:e=>[1,2,3,4][e-1],damage:e=>["1d8+1","2d8+2","3d8+3","4d8+4"][e-1],range:"Melee"},Bruiser:{difficulty:e=>[11,14,17,20][e-1],thresholds:e=>({major:[8,14,22,38][e-1],severe:[15,28,40,70][e-1]}),hpMax:e=>[6,7,8,9][e-1],stressMax:e=>[4,4,5,5][e-1],atk:e=>[-1,0,1,2][e-1],damage:e=>["1d12+2","2d12+4","3d12+6","4d12+8"][e-1],range:"Melee"},Horde:{difficulty:e=>[10,13,16,19][e-1],thresholds:e=>({major:[7,10,20,25][e-1],severe:[12,20,32,45][e-1]}),hpMax:e=>[5,6,7,8][e-1],stressMax:e=>[3,3,4,4][e-1],atk:e=>[-1,0,1,2][e-1],damage:e=>["1d8+2","2d8+4","3d8+6","4d8+8"][e-1],range:"Melee"},Leader:{difficulty:e=>[11,14,17,20][e-1],thresholds:e=>({major:[7,13,21,35][e-1],severe:[14,26,38,65][e-1]}),hpMax:e=>[5,6,7,8][e-1],stressMax:e=>[5,5,6,6][e-1],atk:e=>[2,4,6,8][e-1],damage:e=>["1d10+2","2d10+4","3d10+6","4d10+8"][e-1],range:"Melee"},Ranged:{difficulty:e=>[10,13,16,19][e-1],thresholds:e=>({major:[4,8,18,22][e-1],severe:[7,16,30,42][e-1]}),hpMax:e=>[3,4,5,6][e-1],stressMax:e=>[3,3,4,4][e-1],atk:e=>[2,3,4,5][e-1],damage:e=>["1d8+2","2d8+4","3d8+6","4d8+8"][e-1],range:"Close"},Skulk:{difficulty:e=>[12,15,18,21][e-1],thresholds:e=>({major:[5,9,19,23][e-1],severe:[10,18,31,43][e-1]}),hpMax:e=>[4,5,6,7][e-1],stressMax:e=>[3,3,4,4][e-1],atk:e=>[2,3,4,5][e-1],damage:e=>["1d6+2","2d6+4","3d6+6","4d6+8"][e-1],range:"Melee"},Solo:{difficulty:e=>[12,15,18,21][e-1],thresholds:e=>({major:[7,13,21,35][e-1],severe:[14,26,38,65][e-1]}),hpMax:e=>[8,9,10,11][e-1],stressMax:e=>[5,5,6,6][e-1],atk:e=>[3,5,7,9][e-1],damage:e=>["1d10+3","2d10+6","3d10+9","4d10+12"][e-1],range:"Melee"},Support:{difficulty:e=>[11,14,17,20][e-1],thresholds:e=>({major:[5,9,19,23][e-1],severe:[10,18,31,43][e-1]}),hpMax:e=>[4,4,5,5][e-1],stressMax:e=>[4,4,5,5][e-1],atk:e=>[2,3,4,5][e-1],damage:e=>["1d4+2","2d4+4","3d4+6","4d4+8"][e-1],range:"Melee"},Social:{difficulty:e=>[11,14,17,20][e-1],thresholds:e=>({major:[5,9,19,23][e-1],severe:[10,18,31,43][e-1]}),hpMax:e=>[4,4,5,5][e-1],stressMax:e=>[4,4,5,5][e-1],atk:e=>[2,3,4,5][e-1],damage:e=>["1d4+2","2d4+4","3d4+6","4d4+8"][e-1],range:"Melee"}},tt=(e,a)=>{const o=Bt[a]||Bt.Standard;return{difficulty:o.difficulty(e),thresholds:o.thresholds(e),hpMax:o.hpMax(e),stressMax:o.stressMax(e),atk:o.atk(e),damage:o.damage(e),range:o.range}};let Zt={adversaries:[]},Dt=!1;const Rr=()=>({customAdversaries:JSON.parse(localStorage.getItem("daggerheart-custom-adversaries")||"[]")}),Br=async()=>{if(Dt)return;let e={adversaries:[]},a={adversaries:[]};try{const i=await Ye(()=>import("./adversaries-9c8932de.js"),[]);e=(i==null?void 0:i.default)||i}catch(i){console.warn("Failed to load adversaries.json:",i)}try{const i=await Ye(()=>import("./playtest-adversaries-4a099c10.js"),[]);a=(i==null?void 0:i.default)||i}catch(i){console.warn("Failed to load playtest-adversaries.json:",i)}const{customAdversaries:o}=Rr();Zt={...e,adversaries:[...e.adversaries||[],...a.adversaries||[],...o]},Dt=!0},kt=f.forwardRef(({onSave:e,onRefresh:a,onAddItem:o,editingAdversary:i,onCancelEdit:d,isStockAdversary:l=!1,autoFocus:c=!1,allAdversaries:u=[],embedded:p=!1,hideEmbeddedButtons:x=!1},m)=>{const r=f.useRef(null),s=f.useRef(null),[n,h]=f.useState(()=>{const C=tt(1,"Standard");return{name:"",tier:1,type:"Standard",description:"",motives:"",difficulty:C.difficulty,thresholds:C.thresholds,hpMax:C.hpMax,stressMax:C.stressMax,atk:C.atk,weapon:"",range:C.range,damage:C.damage,experience:[],features:[]}}),[S,b]=f.useState(!1),[$,L]=f.useState(!1),[_,z]=f.useState([]),[V,B]=f.useState(!1),[F,E]=f.useState([]);f.useEffect(()=>{(async()=>{await Br(),u.length>0?E(u):E(Zt.adversaries||[])})()},[u]),f.useEffect(()=>{c&&setTimeout(()=>{var C,v,j;i&&s.current?((C=s.current)==null||C.focus(),(v=s.current)==null||v.select()):r.current&&((j=r.current)==null||j.focus())},650)},[c,i]),f.useEffect(()=>{var C;if(i){const v=i.baseName||((C=i.name)==null?void 0:C.replace(/\s+\(\d+\)$/,""))||i.name||"";h({name:v,tier:i.tier||1,type:i.type||"Standard",description:i.description||"",motives:i.motives||"",difficulty:i.difficulty||11,thresholds:i.thresholds||{major:7,severe:12},hpMax:i.hpMax||3,stressMax:i.stressMax||1,atk:i.atk||1,weapon:i.weapon||"",range:i.range||"Melee",damage:i.damage||"",experience:i.experience||[],features:i.features||[]}),L(!1)}else{const v=tt(1,"Standard");h({name:"",tier:1,type:"Standard",description:"",motives:"",difficulty:v.difficulty,thresholds:v.thresholds,hpMax:v.hpMax,stressMax:v.stressMax,atk:v.atk,weapon:"",range:v.range,damage:v.damage,experience:[],features:[]}),L(!1)}},[i]),f.useEffect(()=>{if(!i&&!$){const C=tt(n.tier,n.type);h(v=>({...v,difficulty:C.difficulty,thresholds:C.thresholds,hpMax:C.hpMax,stressMax:C.stressMax,atk:C.atk,range:C.range,damage:C.damage}))}},[n.tier,n.type,i,$]);const y=C=>{if(h(v=>({...v,name:C})),C.trim().length>0){const v=F.filter(j=>{var w;return(((w=j.name)==null?void 0:w.replace(/\s+\(\d+\)$/,""))||j.name||"").toLowerCase().includes(C.toLowerCase())}).slice(0,5);z(v),B(v.length>0)}else z([]),B(!1)},H=async()=>{if(!n.name.trim()){alert("Please enter a name for the adversary");return}b(!0);try{const C=w=>(w||[]).filter(T=>T.name&&T.name.trim()!==""||T.modifier!==void 0&&T.modifier!==0),v=n.name.trim()||"Unknown",j=C(n.experience||[]),q={...n,experience:j,baseName:v,name:v,hp:i?i.hp:0,stress:i?i.stress:0,source:"Homebrew"};if(i){if(l){const{id:w,name:T,...k}=q;await e(k),alert("Custom adversary created successfully!")}else{const w={...q,name:q.baseName};await e(w,i.id),alert("Adversary updated successfully!")}d&&d()}else{await e(q),a&&await a();const w=tt(1,"Standard");h({name:"",tier:1,type:"Standard",description:"",motives:"",difficulty:w.difficulty,thresholds:w.thresholds,hpMax:w.hpMax,stressMax:w.stressMax,atk:w.atk,weapon:"",range:w.range,damage:w.damage,experience:[],features:[]}),L(!1),alert("Custom adversary created successfully!")}}catch(C){console.error("Error saving adversary:",C),alert("Error saving adversary. Please try again.")}finally{b(!1)}};f.useImperativeHandle(m,()=>({handleSave:H,isSaving:S,canSave:n.name.trim().length>0}));const Q={...n,id:"new-adversary",hp:0,stress:0,source:"Homebrew"},D=()=>S?i?l?"Creating...":"Saving...":"Creating...":i?l?"Save As Custom":"Save":"Create";return t.jsxs(t.Fragment,{children:[!p&&t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"1rem"},children:[t.jsx("h2",{style:{color:"var(--text-primary)",fontSize:"1.5rem",fontWeight:"600",margin:0},children:i?l?"Edit Adversary (Save As Custom)":"Edit Custom Adversary":"Create Custom Adversary"}),t.jsx("button",{onClick:H,disabled:S||!n.name.trim(),style:{padding:"0.75rem 1.5rem",backgroundColor:S||!n.name.trim()?"var(--gray-600)":"var(--purple)",border:"none",color:"white",borderRadius:"8px",cursor:S||!n.name.trim()?"not-allowed":"pointer",fontSize:"1rem",fontWeight:"600",opacity:S||!n.name.trim()?.6:1},children:D()})]}),p&&!x&&t.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",alignItems:"center",marginBottom:"0.5rem",padding:"0.5rem",borderBottom:"1px solid var(--border)"},children:[t.jsx("button",{onClick:H,disabled:S||!n.name.trim(),style:{padding:"0.5rem 1rem",backgroundColor:S||!n.name.trim()?"var(--gray-600)":"var(--purple)",border:"none",color:"white",borderRadius:"6px",cursor:S||!n.name.trim()?"not-allowed":"pointer",fontSize:"0.875rem",fontWeight:"600",opacity:S||!n.name.trim()?.6:1,marginRight:"0.5rem"},children:D()}),d&&t.jsx("button",{onClick:d,style:{padding:"0.5rem 1rem",backgroundColor:"transparent",border:"1px solid var(--border)",color:"var(--text-primary)",borderRadius:"6px",cursor:"pointer",fontSize:"0.875rem",fontWeight:"600"},children:"Cancel"})]}),!i&&t.jsxs("div",{style:{marginBottom:"1rem",position:"relative"},children:[t.jsx("input",{ref:r,type:"text",value:n.name,onChange:C=>{const v=C.target.value;h(j=>({...j,name:v})),y(v)},placeholder:"Adversary name",style:{width:"100%",padding:"0.75rem",border:"1px solid var(--border)",borderRadius:"8px",backgroundColor:"var(--bg-primary)",color:"var(--text-primary)",fontSize:"1rem",outline:"none"}}),V&&_.length>0&&t.jsx("div",{style:{position:"absolute",top:"100%",left:0,right:0,backgroundColor:"var(--bg-primary)",border:"1px solid var(--border)",borderRadius:"0 0 8px 8px",borderTop:"none",maxHeight:"200px",overflowY:"auto",zIndex:1e3,boxShadow:"0 4px 12px rgba(0, 0, 0, 0.3)"},children:_.map((C,v)=>{var q;const j=C.baseName||((q=C.name)==null?void 0:q.replace(/\s+\(\d+\)$/,""))||C.name;return t.jsxs("div",{onClick:()=>{h(w=>({...w,name:j,tier:C.tier||w.tier,type:C.type||w.type,difficulty:C.difficulty||w.difficulty,thresholds:C.thresholds||w.thresholds,hpMax:C.hpMax||w.hpMax,stressMax:C.stressMax||w.stressMax,atk:C.atk||w.atk,range:C.range||w.range,damage:C.damage||w.damage})),B(!1),L(!0),r.current&&r.current.blur()},style:{padding:"0.75rem",cursor:"pointer",borderBottom:v<_.length-1?"1px solid var(--border)":"none",transition:"background-color 0.2s"},onMouseEnter:w=>{w.target.style.backgroundColor="var(--bg-secondary)"},onMouseLeave:w=>{w.target.style.backgroundColor="transparent"},onMouseDown:w=>w.preventDefault(),children:[t.jsx("div",{style:{fontWeight:"600"},children:j}),t.jsxs("div",{style:{fontSize:"0.875rem",color:"var(--text-secondary)",marginTop:"2px"},children:[C.type," • Tier ",C.tier]})]},v)})})]}),t.jsx(pt,{item:Q,type:"adversary",mode:"edit",nameInputRef:i?s:void 0,autoFocusNameInput:c&&i,onUpdate:(C,v)=>{h(j=>({...j,...v}))}})]})});kt.displayName="CustomAdversaryCreator";const Dr=({feature:e,featureType:a,item:o,onUpdate:i,handleFeatureDeleteClick:d,deleteConfirmations:l,getFeatureKey:c})=>{const u=()=>(o.features||[]).filter(r=>r.type===a),p=r=>r.type===a&&r.name.trim(),x=r=>{try{const n=[...(o==null?void 0:o.features)||[]],h=u(),S=h.findIndex(b=>b===e);if(r==="up"&&S>0){const b=h[S],$=h[S-1];m(n,b,$)}else if(r==="down"&&S<h.length-1&&S>=0){const b=h[S],$=h[S+1];m(n,b,$)}}catch(s){console.error(`Error in ${a.toLowerCase()} ${r} button:`,s)}},m=(r,s,n)=>{if(!s||!n)return;const h=r.findIndex(b=>b===s),S=r.findIndex(b=>b===n);h>=0&&S>=0&&(r[h]=n,r[S]=s,i&&i(o.id,{features:r}))};return t.jsxs("div",{style:{display:"flex",flexDirection:"column",justifyContent:"space-between",alignItems:"center",alignSelf:"stretch"},children:[t.jsx("button",{onClick:()=>x("up"),disabled:u().findIndex(r=>r===e)===0,tabIndex:"-1",style:{width:"22px",height:"22px",padding:0,border:"1px solid var(--border)",borderRadius:"3px",backgroundColor:"var(--gray-700)",color:p(e)&&u().findIndex(r=>r===e)!==0&&e.name.trim()?"white":"var(--text-secondary)",cursor:p(e)&&u().findIndex(r=>r===e)!==0&&e.name.trim()?"pointer":"not-allowed",fontSize:"14px",lineHeight:"1",display:"flex",alignItems:"center",justifyContent:"center",minHeight:"22px",maxHeight:"22px"},children:"↑"}),t.jsx("button",{onClick:()=>d(e),disabled:!e.name.trim()&&!e.description.trim(),style:{width:"22px",height:"22px",padding:0,border:"1px solid var(--border)",borderRadius:"3px",backgroundColor:l[c(e)]?"var(--danger)":"var(--gray-700)",color:!e.name.trim()&&!e.description.trim()?"var(--text-secondary)":"white",cursor:!e.name.trim()&&!e.description.trim()?"not-allowed":"pointer",opacity:!e.name.trim()&&!e.description.trim()?.5:1,fontWeight:"600",fontSize:"12px",lineHeight:"1",transition:"background-color 0.2s",display:"flex",alignItems:"center",justifyContent:"center",minHeight:"22px",maxHeight:"22px"},children:"×"}),t.jsx("button",{onClick:()=>x("down"),disabled:u().findIndex(r=>r===e)===u().length-1,style:{width:"22px",height:"22px",padding:0,border:"1px solid var(--border)",borderRadius:"3px",backgroundColor:"var(--gray-700)",color:p(e)&&u().findIndex(r=>r===e)<u().length-1&&e.name.trim()?"white":"var(--text-secondary)",cursor:p(e)&&u().findIndex(r=>r===e)<u().length-1&&e.name.trim()?"pointer":"not-allowed",fontSize:"14px",lineHeight:"1",display:"flex",alignItems:"center",justifyContent:"center",minHeight:"22px",maxHeight:"22px"},children:"↓"})]})},ce="0.5rem",xe="0.5rem",$t="0.5rem",Ft=({title:e})=>t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:ce},children:[t.jsx("hr",{style:{flex:1,border:"none",borderTop:"1px solid var(--border)",margin:0}}),t.jsx("h4",{style:{margin:0,fontSize:"0.75rem",fontWeight:"500",color:"var(--text-secondary)",textTransform:"uppercase",letterSpacing:"0.5px"},children:e})]}),$r=({item:e,isEditMode:a,onUpdate:o,handleFeatureDeleteClick:i,deleteConfirmations:d,getFeatureKey:l})=>{const c=a||e.atk!==void 0&&e.weapon,u=e.features&&e.features.length>0||a;if(!c&&!u)return null;const p=(s,n,h)=>t.jsxs("div",{style:{display:"flex",gap:ce,padding:`${xe} ${ce}`,border:"1px solid var(--border)",borderRadius:"4px",backgroundColor:"var(--bg-secondary)",alignItems:"stretch"},children:[t.jsxs("div",{style:{flex:1,display:"flex",flexDirection:"column",gap:xe},children:[t.jsx("input",{type:"text",value:s.name||"",autoComplete:"off",autoCorrect:"off",autoCapitalize:"off",spellCheck:"false","data-lpignore":"true","data-form-type":"other",name:`feature-name-${h.toLowerCase()}`,onChange:S=>{const b=[...e.features||[]],$=b.findIndex(z=>z.type===h&&z===s);$>=0?b[$]={...b[$],name:S.target.value}:b.push({type:h,name:S.target.value,description:s.description||""});const L=b.filter(z=>z.type===h),_=L[L.length-1];_&&_.name.trim()&&b.push({type:h,name:"",description:""}),o&&o(e.id,{features:b})},placeholder:`${n} name`,style:{padding:`${xe} ${ce}`,border:"1px solid var(--border)",borderRadius:"4px",backgroundColor:"var(--bg-primary)",color:"var(--text-primary)",fontSize:"0.875rem",transition:"background-color 0.2s"}}),t.jsx("textarea",{value:s.description||"",onChange:S=>{const b=[...e.features||[]],$=b.findIndex(z=>z.type===h&&z===s);$>=0?b[$]={...b[$],description:S.target.value}:b.push({type:h,name:s.name||"",description:S.target.value});const L=b.filter(z=>z.type===h),_=L[L.length-1];_&&_.name.trim()&&b.push({type:h,name:"",description:""}),o&&o(e.id,{features:b})},placeholder:`${n} description`,style:{padding:`${xe} ${ce}`,border:"1px solid var(--border)",borderRadius:"4px",backgroundColor:"var(--bg-primary)",color:"var(--text-primary)",fontSize:"0.875rem",minHeight:"4.5rem",resize:"vertical"}})]}),t.jsx(Dr,{feature:s,featureType:h,item:e,onUpdate:o,handleFeatureDeleteClick:i,deleteConfirmations:d,getFeatureKey:l})]},s.id||`${h}-${s.name}-${s.description}-${Math.random()}`),x=(s,n)=>t.jsx("div",{style:{display:"flex",flexDirection:"column",gap:xe},children:s.map((h,S)=>t.jsxs("div",{style:{display:"flex",flexDirection:"column"},children:[t.jsx("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:t.jsx("span",{style:{fontWeight:600,color:"var(--text-primary)",fontSize:"0.9rem"},children:h.name})}),t.jsx("div",{style:{fontSize:"0.85rem",lineHeight:1.4,color:"var(--text-secondary)",marginLeft:$t},children:h.description||n})]},`${h.type}-${S}`))}),m=()=>a||e.atk!==void 0&&e.weapon?t.jsxs("div",{children:[t.jsx(Ft,{title:"Standard Attack"}),t.jsx("div",{style:{display:"flex",flexDirection:"column"},children:a?t.jsx("div",{style:{display:"flex",flexDirection:"column",gap:xe,padding:`${xe} ${ce}`,border:"1px solid var(--border)",borderRadius:"4px",backgroundColor:"var(--bg-secondary)"},children:t.jsxs("div",{style:{display:"flex",gap:ce,alignItems:"center"},children:[t.jsx("input",{type:"text",value:e.weapon||"",onChange:n=>o&&o(e.id,{weapon:n.target.value}),placeholder:"Standard attack name",style:{flex:1,padding:`${xe} ${ce}`,border:"1px solid var(--border)",borderRadius:"4px",backgroundColor:"var(--bg-primary)",color:"var(--text-primary)",fontSize:"0.875rem"}}),t.jsxs("select",{value:e.range||"",onChange:n=>o&&o(e.id,{range:n.target.value}),style:{flex:1,padding:`${xe} ${ce}`,border:"1px solid var(--border)",borderRadius:"4px",backgroundColor:"var(--bg-primary)",color:"var(--text-primary)",fontSize:"0.875rem",appearance:"none",backgroundImage:`url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e")`,backgroundRepeat:"no-repeat",backgroundPosition:"right 0.5rem center",backgroundSize:"1rem",paddingRight:"2rem"},children:[t.jsx("option",{value:""}),t.jsx("option",{value:"Melee",children:"Melee"}),t.jsx("option",{value:"Very Close",children:"Very Close"}),t.jsx("option",{value:"Close",children:"Close"}),t.jsx("option",{value:"Far",children:"Far"}),t.jsx("option",{value:"Very Far",children:"Very Far"})]}),t.jsx("input",{type:"text",value:e.damage||"",onChange:n=>o&&o(e.id,{damage:n.target.value}),placeholder:"Damage (e.g., 1d6+2)",style:{flex:1,padding:`${xe} ${ce}`,border:"1px solid var(--border)",borderRadius:"4px",backgroundColor:"var(--bg-primary)",color:"var(--text-primary)",fontSize:"0.875rem"}})]})}):t.jsxs("div",{style:{display:"flex",flexDirection:"column"},children:[t.jsx("span",{style:{fontWeight:600,color:"var(--text-primary)",fontSize:"0.9rem"},children:e.weapon}),t.jsxs("div",{style:{fontSize:"0.85rem",lineHeight:1.4,color:"var(--text-secondary)",marginLeft:$t},children:["Make an attack against a target within ",e.range||"Melee"," range. On a success, deal"," ",e.damage||"damage varies","."]})]})})]}):null,r=(s,n)=>{const h=(e.features||[]).filter(L=>L.type===s);if(!(h.length>0)&&!a)return null;const b=a&&h.length===0?[{type:s,name:"",description:""}]:h,$=s==="Action"&&!c;return t.jsxs("div",{style:$?{}:{marginTop:xe},children:[t.jsx(Ft,{title:n}),t.jsx("div",{style:{display:"flex",flexDirection:"column"},children:a?b.map(L=>p(L,n.slice(0,-1),s)):x(b,`Describe the ${n.toLowerCase()}`)})]})};return t.jsxs("div",{style:{paddingLeft:ce,paddingRight:ce},children:[m(),r("Action","Actions"),r("Passive","Passives"),r("Reaction","Reactions")]})},Pt={fear:{icon:cr,maxValue:12,containerStyle:{display:"flex",gap:"0.125rem",alignItems:"center",justifyContent:"center",width:"100%",height:"100%",padding:"0.125rem",maxWidth:"none"},pipStyle:{fontSize:"var(--text-lg)",fontWeight:600,transition:"color 0.3s ease",height:"1.5rem",width:"1.5rem",display:"inline-block",textAlign:"center",lineHeight:"1.5rem",flexShrink:0,imageRendering:"crisp-edges"},filledColor:"var(--purple)",emptyColor:"var(--gray-dark)",tooltipTitle:"Click anywhere in header to adjust fear:",tooltipInstructions:[{text:"Left of boundary:",description:"Click to decrease fear by 1"},{text:"Right of boundary:",description:"Click to increase fear by 1"}]},hp:{icon:ur,maxValue:20,containerStyle:{display:"inline-block",width:"auto",height:"100%",padding:"0.125rem",textAlign:"center"},pipStyle:{fontSize:"var(--text-sm)",fontWeight:600,transition:"color 0.3s ease",height:"1.5rem",width:"1.5rem",display:"inline-block",textAlign:"center",lineHeight:"1.5rem",flexShrink:0},filledColor:"var(--red)",emptyColor:"var(--text-secondary)",tooltipTitle:"Click anywhere to adjust HP:",tooltipInstructions:[{text:"Left of boundary:",description:"Click to decrease HP by 1"},{text:"Right of boundary:",description:"Click to increase HP by 1"}]},stress:{icon:pr,maxValue:12,containerStyle:{display:"inline-block",width:"auto",height:"100%",padding:"0.125rem",textAlign:"center"},pipStyle:{fontSize:"var(--text-sm)",fontWeight:600,transition:"color 0.3s ease",height:"1.5rem",width:"1.5rem",display:"inline-block",textAlign:"center",lineHeight:"1.5rem",flexShrink:0},filledColor:"var(--gold)",emptyColor:"var(--text-secondary)",tooltipTitle:"Click anywhere to adjust stress:",tooltipInstructions:[{text:"Left of boundary:",description:"Click to decrease stress by 1"},{text:"Right of boundary:",description:"Click to increase stress by 1"}]},countdown:{icon:Mt,maxValue:6,containerStyle:{display:"inline-block",width:"auto",height:"100%",padding:"0.125rem",textAlign:"center"},pipStyle:{fontSize:"var(--text-sm)",fontWeight:600,transition:"color 0.3s ease",height:"1.5rem",width:"1.5rem",display:"inline-block",textAlign:"center",lineHeight:"1.5rem",flexShrink:0},filledColor:"var(--text-secondary)",emptyColor:"var(--text-secondary)",tooltipTitle:"Click anywhere to adjust countdown:",tooltipInstructions:[{text:"Left of boundary:",description:"Click to decrease countdown by 1"},{text:"Right of boundary:",description:"Click to increase countdown by 1"}]},hpDots:{maxValue:20,containerStyle:{display:"flex",flexWrap:"wrap",gap:"1px",justifyContent:"center",alignItems:"center",maxWidth:"120px"},pipStyle:{width:"8px",height:"8px",borderRadius:"50%",border:"1px solid var(--border)",transition:"background-color 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease"},filledStyle:{background:"var(--red)",borderColor:"var(--red)",boxShadow:"0 0 4px rgba(239, 68, 68, 0.5)"},emptyStyle:{background:"var(--bg-primary)",borderColor:"var(--border)"},isDots:!0,tooltipTitle:"Click anywhere to adjust HP:",tooltipInstructions:[{text:"Left of boundary:",description:"Click to decrease HP by 1"},{text:"Right of boundary:",description:"Click to increase HP by 1"}]},stressDots:{maxValue:12,containerStyle:{display:"flex",flexWrap:"wrap",gap:"1px",justifyContent:"center",alignItems:"center",maxWidth:"120px"},pipStyle:{width:"8px",height:"8px",borderRadius:"50%",border:"1px solid var(--border)",transition:"background-color 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease"},filledStyle:{background:"var(--purple)",borderColor:"var(--purple)",boxShadow:"0 0 4px rgba(139, 92, 246, 0.5)"},emptyStyle:{background:"var(--bg-primary)",borderColor:"var(--border)"},isDots:!0,tooltipTitle:"Click anywhere to adjust stress:",tooltipInstructions:[{text:"Left of boundary:",description:"Click to decrease stress by 1"},{text:"Right of boundary:",description:"Click to increase stress by 1"}]},adversaryHP:{icon:mr,maxValue:20,containerStyle:{display:"flex",gap:"0px",flexWrap:"wrap",alignContent:"flex-start",rowGap:"0.03125rem",maxWidth:"100%"},pipStyle:{fontSize:"var(--text-sm)",fontWeight:600,transition:"none",cursor:"pointer",width:"1rem",height:"1rem",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},filledColor:"var(--red)",emptyColor:"var(--gray-400)",tooltipTitle:"Click to adjust HP:",tooltipInstructions:[{text:"Filled pip:",description:"Click to heal (reduce damage)"},{text:"Empty pip:",description:"Click to take damage"}]},adversaryStress:{icon:fr,maxValue:12,containerStyle:{display:"flex",gap:"0px",flexWrap:"wrap",alignContent:"flex-start",rowGap:"0.03125rem",maxWidth:"100%"},pipStyle:{fontSize:"var(--text-sm)",fontWeight:600,transition:"none",cursor:"pointer",width:"1rem",height:"1rem",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},filledColor:"var(--gold)",emptyColor:"var(--gray-400)",tooltipTitle:"Click to adjust stress:",tooltipInstructions:[{text:"Filled pip:",description:"Click to reduce stress"},{text:"Empty pip:",description:"Click to increase stress"}]},countdownDistributed:{icon:Mt,maxValue:6,containerStyle:{display:"inline-block",width:"auto",height:"100%",padding:"0.125rem",textAlign:"center"},pipStyle:{fontSize:"var(--text-sm)",fontWeight:600,transition:"color 0.3s ease",height:"1.5rem",width:"1.5rem",display:"inline-block",textAlign:"center",lineHeight:"1.5rem",flexShrink:0},filledColor:"var(--text-secondary)",emptyColor:"var(--text-secondary)",tooltipTitle:"Countdown progress:",tooltipInstructions:[{text:"Progress:",description:"Current countdown value"}]}},ut=({type:e="fear",value:a=0,maxValue:o,onChange:i,size:d="lg",showTooltip:l=!0,containerStyle:c={},pipStyle:u={},countdownType:p=null,distributedGroups:x=null,onPipClick:m=null,enableBoundaryClick:r=!1,clickContainerWidth:s="auto",centerPips:n=!0})=>{const[h,S]=f.useState(!1),b=Pt[e]||Pt.fear,$=o||b.maxValue,L=Math.max(0,Math.min($,a));let _=b.filledColor;e==="countdown"&&p&&(["progress","dynamic-progress","simple-hope"].includes(p)?_="var(--gold)":["consequence","dynamic-consequence","simple-fear"].includes(p)?_="var(--purple)":["long-term","standard"].includes(p)&&(_="var(--text-secondary)"));const z=(y,H)=>{if(m)m(y,H);else if(i){const Q=y+1;i(Q)}},V=y=>{if(!r||!i||m)return;y.currentTarget.getBoundingClientRect();const H=y.currentTarget.querySelector(".pip-container");if(!H)return;const Q=H.getBoundingClientRect(),D=y.clientX-Q.left;if(D<0){L>0&&i(L-1);return}if(D>Q.width){L<$&&i(L+1);return}const C=Q.width,v=C*.05,j=C-2*v,q=D-v,w=L/$,T=j*w;q<T?L>0&&i(L-1):L<$&&i(L+1)},F=(()=>{if(!x||e!=="countdownDistributed")return[{start:0,end:$,groupIndex:0}];let y=0;return x.map((H,Q)=>{const D={start:y,end:y+H,groupIndex:Q};return y+=H,D})})(),E=()=>t.jsxs(t.Fragment,{children:[F.map(y=>t.jsx(Ke.Fragment,{children:[...Array(y.end-y.start)].map((H,Q)=>{const D=y.start+Q,C=D<L;if(b.isDots)return t.jsx("div",{style:{...b.pipStyle,...C?b.filledStyle:b.emptyStyle,...u,cursor:i||m?"pointer":"default"},onClick:r?void 0:()=>z(D,C),title:`${D+1} of ${$}`},D);{const v=b.icon,j=v&&typeof v=="object"&&v.iconName,q=C?_:b.emptyColor;return t.jsx("span",{className:`fear-pip ${C?"filled":"empty"}`,style:{...b.pipStyle,color:q,cursor:i||m?"pointer":"default",...u},onClick:r?void 0:()=>z(D,C),title:`${D+1} of ${$}`,children:j?t.jsx(dr,{icon:v,size:d}):t.jsx(v,{size:d==="lg"?18:16})},D)}})},y.groupIndex)),l&&t.jsx("div",{style:{position:"relative",cursor:"help",pointerEvents:"none"},children:t.jsxs("div",{style:{position:"absolute",bottom:"100%",left:"50%",transform:h?"translateX(-50%) translateY(-5px)":"translateX(-50%)",background:"rgba(15, 23, 42, 0.95)",border:"1px solid var(--gray)",borderRadius:"var(--radius-md)",padding:"var(--space-md)",minWidth:"250px",zIndex:1e3,opacity:h?1:0,visibility:h?"visible":"hidden",transition:"all 0.2s ease",boxShadow:"0 10px 25px rgba(0, 0, 0, 0.5)"},children:[t.jsx("div",{style:{fontWeight:600,color:"var(--gray-200)",marginBottom:"0.75rem",fontSize:"var(--text-sm)"},children:b.tooltipTitle}),b.tooltipInstructions.map((y,H)=>t.jsxs("div",{style:{marginBottom:"0.5rem",fontSize:"0.8rem",color:"var(--gray-300)",lineHeight:1.4},children:[t.jsx("strong",{style:{color:"var(--gray-200)"},children:y.text})," ",y.description]},H))]})})]});return t.jsx("div",{style:{width:s,height:"100%",cursor:i||m?"pointer":"default",touchAction:"manipulation",userSelect:"none",display:n?"flex":"block",alignItems:n?"center":"stretch",justifyContent:n?"center":"flex-start",...c},onClick:y=>{y.stopPropagation(),y.preventDefault(),r&&V(y)},onMouseEnter:()=>S(l),onMouseLeave:()=>S(!1),children:t.jsx("div",{className:"pip-container",style:{...b.containerStyle,width:"auto",height:"100%",padding:"0.125rem",textAlign:"center"},children:E()})})},Ht=({value:e})=>t.jsxs("div",{style:{position:"relative",display:"flex",alignItems:"center",justifyContent:"center",width:"44px",height:"32px",zIndex:3},children:[t.jsx("svg",{width:"40",height:"32",viewBox:"0 0 40 32",fill:"var(--bg-primary)",stroke:"var(--text-secondary)",strokeWidth:"1",strokeLinecap:"round",strokeLinejoin:"round",style:{position:"absolute",zIndex:1},children:t.jsx("path",{d:"M2 2h28l6 14-6 14H2l6-14-6-14z"})}),t.jsx("span",{style:{position:"absolute",fontSize:"0.8rem",fontWeight:500,color:"var(--text-primary)",textAlign:"center",zIndex:2,left:"50%",top:"50%",transform:"translate(-50%, -50%)"},children:e})]}),Fr=({item:e,instances:a=[],isEditMode:o,type:i,onUpdate:d,onApplyDamage:l,onApplyHealing:c,onApplyStressChange:u})=>{if(!(a&&a.length>0||e.type!=="Minion"&&(e.thresholds||o)))return null;const x=r=>{const s=(r.hp||0)>=(r.hpMax||1);return t.jsx("div",{"data-instance-id":r.id,children:t.jsxs("div",{style:{backgroundColor:s?"var(--gray-900)":"var(--bg-primary)",borderRadius:"6px",paddingTop:0,paddingBottom:0,paddingLeft:ce,paddingRight:ce,border:"1px solid",borderColor:s?"color-mix(in srgb, var(--gray-600) 40%, transparent)":"var(--text-secondary)",display:"flex",justifyContent:"flex-start",alignItems:"center",opacity:s?.7:1,position:"relative",transition:"all 0.2s ease",minHeight:"40px"},children:[s&&t.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,background:`repeating-linear-gradient(
                          45deg,
                          transparent 0px,
                          transparent 8px,
                          var(--gray-600) 9px,
                          var(--gray-600) 9px
                        )`,pointerEvents:"none",zIndex:1,borderRadius:"4px"}}),t.jsx("div",{style:{backgroundColor:s?"var(--gray-900)":"var(--bg-card)",border:"1px solid",borderColor:s?"color-mix(in srgb, var(--gray-600) 40%, transparent)":"var(--text-secondary)",borderRadius:"50%",width:"24px",height:"24px",display:"flex",alignItems:"center",justifyContent:"center",paddingTop:"1px",flexShrink:0,opacity:s?.5:1,marginRight:"0.375rem"},children:t.jsx("span",{style:{fontSize:"0.8rem",fontWeight:600,color:s?"var(--gray-400)":"var(--text-primary)"},children:r.duplicateNumber||1})}),t.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"flex-start",gap:"0.125rem"},children:[t.jsx("div",{style:{opacity:s?.3:1},children:t.jsx(ut,{type:"adversaryHP",value:r.hp||0,maxValue:r.hpMax||1,onPipClick:(n,h)=>{if(l&&i==="adversary"){const S=r.hp||0,b=r.hpMax||1;h?c==null||c(r.id,1,S):S<b&&l(r.id,1,S,b)}},containerStyle:{height:"auto",padding:"0"},pipStyle:{fontSize:"1rem",width:"1.25rem",height:"1.25rem"},size:"lg",showTooltip:!1})}),r.stressMax>0&&t.jsx("div",{style:{opacity:s?.3:1},children:t.jsx(ut,{type:"adversaryStress",value:r.stress||0,maxValue:r.stressMax,onPipClick:(n,h)=>{u&&i==="adversary"&&u(r.id,h?-1:1)},containerStyle:{height:"auto",padding:"0"},pipStyle:{fontSize:"1rem",width:"1.25rem",height:"1.25rem"},size:"lg",showTooltip:!1})})]})]})},r.id)},m=()=>{var r,s,n,h;return e.type==="Minion"||!e.thresholds&&!o?null:t.jsx("div",{style:{display:"flex",justifyContent:"center",paddingTop:"1px"},children:t.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",paddingTop:"1px",position:"relative"},children:[t.jsx("svg",{width:"300",height:"36",viewBox:"0 0 300 36",style:{position:"absolute",zIndex:1},children:t.jsx("rect",{x:"20",y:"6",width:"260",height:"24",fill:"var(--bg-primary)",stroke:"var(--text-secondary)",strokeWidth:"1",rx:"4"})}),t.jsx("div",{style:{position:"relative",zIndex:2,display:"flex",alignItems:"center",gap:"0.375rem"},children:o?t.jsxs("div",{style:{display:"flex",gap:"0.5rem",alignItems:"center",fontSize:"0.8rem"},children:[t.jsx(_t,{label:"Minor",value:(r=e.thresholds)==null?void 0:r.major,onChange:S=>qt("major",S,d,e)}),t.jsx(_t,{label:"Major",value:(s=e.thresholds)==null?void 0:s.severe,onChange:S=>qt("severe",S,d,e)})]}):t.jsxs(t.Fragment,{children:[t.jsx(it,{text:"Minor"}),t.jsx(Ht,{value:((n=e.thresholds)==null?void 0:n.major)||7}),t.jsx(it,{text:"Major"}),t.jsx(Ht,{value:((h=e.thresholds)==null?void 0:h.severe)||14}),t.jsx(it,{text:"Severe"})]})})]})})};return t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:xe,paddingLeft:ce,paddingRight:ce},children:[t.jsx(Pr,{title:"Status"}),o?t.jsx(Hr,{item:e,onUpdate:d}):t.jsx("div",{style:{display:"flex",flexDirection:"column",gap:xe},children:a.map(r=>x(r))}),m()]})},Pr=({title:e})=>t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:ce},children:[t.jsx("hr",{style:{flex:1,border:"none",borderTop:"1px solid var(--border)",margin:0}}),t.jsx("h4",{style:{margin:0,fontSize:"0.75rem",fontWeight:"500",color:"var(--text-secondary)",textTransform:"uppercase",letterSpacing:"0.5px"},children:e})]}),Hr=({item:e,onUpdate:a})=>t.jsx("div",{children:t.jsx("div",{style:{padding:`${xe} ${ce}`,backgroundColor:"var(--bg-secondary)",borderRadius:"8px",border:"1px solid var(--border)"},children:t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:xe},children:[t.jsx(Ot,{label:"HP",pipType:"adversaryHP",value:e.hpMax||"",onChange:o=>a&&a(e.id,{hpMax:o})}),t.jsx(Ot,{label:"Stress",pipType:"adversaryStress",value:e.stressMax||"",onChange:o=>a&&a(e.id,{stressMax:o})})]})})}),Ot=({label:e,pipType:a,value:o,onChange:i})=>t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:ce},children:[t.jsx("input",{type:"number",value:o,onChange:d=>{const l=parseInt(d.target.value)||1;i(l)},min:"1",max:"99",style:{width:"40px",padding:`${xe} ${ce}`,border:"1px solid var(--border)",borderRadius:"4px",backgroundColor:"var(--bg-primary)",color:"var(--text-primary)",fontSize:"0.875rem",textAlign:"center"}}),t.jsx(ut,{type:a,value:0,maxValue:o||1,showTooltip:!1}),t.jsx("span",{style:{fontSize:"0.75rem",color:"var(--text-secondary)",textTransform:"uppercase",minWidth:"40px"},children:e})]}),it=({text:e})=>t.jsx("span",{style:{color:"var(--text-primary)",fontSize:"0.6875rem",fontWeight:"500",textTransform:"uppercase"},children:e}),_t=({label:e,value:a,onChange:o})=>t.jsxs(t.Fragment,{children:[t.jsx(it,{text:e}),t.jsx("input",{type:"number",min:"1",max:"99",value:a||"",onChange:i=>{const d=i.target.value;(d===""||parseInt(d)>=1&&parseInt(d)<=99)&&o(d===""?null:parseInt(d))},style:{width:"30px",padding:`${xe} ${ce}`,border:"1px solid var(--border)",borderRadius:"4px",backgroundColor:"var(--bg-primary)",color:"var(--text-primary)",fontSize:"0.8rem",textAlign:"center"}})]}),qt=(e,a,o,i)=>{o&&o(i.id,{thresholds:{...i.thresholds,[e]:a}})},Or=({item:e,isEditMode:a,mode:o,onUpdate:i})=>a||o==="expanded"&&e.description&&e.description.trim()?t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:xe,paddingLeft:ce,paddingRight:ce,textAlign:"center"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:ce},children:[t.jsx("hr",{style:{flex:1,border:"none",borderTop:"1px solid var(--border)",margin:0}}),t.jsx("h4",{style:{margin:0,fontSize:"0.75rem",fontWeight:"500",color:"var(--text-secondary)",textTransform:"uppercase",letterSpacing:"0.5px"},children:"Description"})]}),a?t.jsx("textarea",{style:{width:"100%",minHeight:"100px",padding:`${xe} ${ce}`,border:"1px solid var(--border)",borderRadius:"0.5rem",backgroundColor:"var(--bg-primary)",color:"white",fontSize:"0.875rem",lineHeight:1.5,resize:"none",overflow:"hidden",fontFamily:"inherit"},value:e.description,onChange:l=>{l.target.style.height="auto",l.target.style.height=l.target.scrollHeight+"px",i&&i(e.id,{description:l.target.value})},placeholder:"Description..."}):t.jsx("div",{style:{fontSize:"0.875rem",fontStyle:"italic",color:"var(--text-secondary)",lineHeight:1.4,whiteSpace:"pre-wrap",padding:`${xe} 0`},children:e.description})]}):null,_r=({type:e,tier:a,isEditMode:o,onUpdate:i,itemId:d})=>{const c=(r=>{if(!r)return 0;const n=document.createElement("canvas").getContext("2d");return n.font="600 11px system-ui, -apple-system, sans-serif",n.measureText(r.toUpperCase()).width})(e),u=4,p=18,x=Math.max(50,c+u+p),m=x+15;return o?t.jsxs("div",{style:{position:"relative",display:"flex",alignItems:"center",gap:ce,height:"32px"},children:[t.jsxs("select",{value:e||"",onChange:r=>{i&&i(d,{type:r.target.value})},style:{backgroundColor:"var(--bg-primary)",border:"1px solid var(--text-secondary)",color:"var(--text-primary)",fontSize:"0.6875rem",fontWeight:"500",textTransform:"uppercase",outline:"none",borderRadius:"4px",padding:`${xe} ${ce}`,width:"95px",height:"24px"},children:[t.jsx("option",{value:"Standard",children:"Standard"}),t.jsx("option",{value:"Solo",children:"Solo"}),t.jsx("option",{value:"Bruiser",children:"Bruiser"}),t.jsx("option",{value:"Horde",children:"Horde"}),t.jsx("option",{value:"Minion",children:"Minion"}),t.jsx("option",{value:"Ranged",children:"Ranged"}),t.jsx("option",{value:"Leader",children:"Leader"}),t.jsx("option",{value:"Skulk",children:"Skulk"}),t.jsx("option",{value:"Social",children:"Social"}),t.jsx("option",{value:"Support",children:"Support"})]}),t.jsxs("div",{style:{position:"relative",width:"24px",height:"24px"},children:[t.jsx("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%) rotate(45deg)",width:"20px",height:"20px",backgroundColor:"var(--bg-primary)",border:"1px solid var(--text-secondary)",borderRadius:"2px"}}),t.jsx("input",{type:"text",value:a||"",onChange:r=>{const s=r.target.value.replace(/[^1-4]/g,"");s.length<=1&&i&&i(d,{tier:s===""?"":parseInt(s)})},onKeyDown:r=>{if(r.key==="ArrowUp"){r.preventDefault();const s=parseInt(a)||1;i&&i(d,{tier:Math.min(s+1,4)})}else if(r.key==="ArrowDown"){r.preventDefault();const s=parseInt(a)||1;i&&i(d,{tier:Math.max(s-1,1)})}},style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",backgroundColor:"transparent",border:"none",color:"var(--text-primary)",fontSize:"0.8rem",fontWeight:600,width:"24px",height:"24px",textAlign:"center",outline:"none",zIndex:1},maxLength:"1"})]})]}):t.jsxs("div",{style:{position:"relative",display:"inline-flex",alignItems:"center",justifyContent:"center",height:"32px",width:`${m}px`},children:[t.jsxs("svg",{width:m,height:"32",viewBox:`0 0 ${m} 32`,style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:1},children:[t.jsx("rect",{x:"1",y:"6",width:x-1,height:"20",fill:"var(--bg-primary)",stroke:"var(--text-secondary)",strokeWidth:"1",rx:"4",ry:"4"}),t.jsx("rect",{x:x-10,y:"6",width:"20",height:"20",fill:"var(--bg-primary)",stroke:"var(--text-secondary)",strokeWidth:"1",rx:"2",ry:"2",transform:`rotate(45 ${x-1} 16)`})]}),t.jsx("span",{style:{position:"absolute",top:"50%",left:"4px",transform:"translateY(-50%)",fontSize:"0.6875rem",fontWeight:"500",textTransform:"uppercase",color:"var(--text-primary)",zIndex:2,pointerEvents:"none"},children:e}),t.jsx("span",{style:{position:"absolute",top:"50%",left:`${x-.5}px`,transform:"translate(-50%, -50%)",fontSize:"0.8rem",fontWeight:600,color:"white",zIndex:2,pointerEvents:"none",textAlign:"center",lineHeight:1,display:"flex",alignItems:"center",justifyContent:"center",width:"20px",height:"20px"},children:a})]})},qr=({item:e,isEditMode:a,onUpdate:o,deleteConfirmations:i,setDeleteConfirmations:d})=>{const l=(m,r)=>`experience-${r}-${typeof m=="string"?m:m.name||"blank"}`,c=m=>Array.isArray(m)?m.filter(r=>{if(typeof r=="string")return r.trim().length>0;const s=r.name||"",n=r.modifier||0;return s.trim().length>0||n>0}):[],u=(m,r)=>{const s=l(m,r);if(i[s]){const n=[...e.experience||[]];n.splice(r,1);const h=c(n);o&&o(e.id,{experience:h}),d(S=>{const b={...S};return delete b[s],b})}else d(n=>({...n,[s]:!0})),setTimeout(()=>{d(n=>{const h={...n};return delete h[s],h})},3e3)},p=()=>{const m=e.experience||[],r=m.length===0?[{name:"",modifier:0}]:m;return t.jsx("div",{style:{display:"flex",flexDirection:"column",gap:xe},children:r.map((s,n)=>{var h,S,b,$,L,_,z,V,B,F,E,y,H,Q,D,C,v,j,q,w,T,k,A,K,M,P,re,O,ee,de,he,Le,be,Me,De;return t.jsxs("div",{style:{position:"relative"},children:[t.jsx("div",{style:{position:"absolute",left:0,top:"50%",transform:"translateY(-50%)",display:"flex",alignItems:"center",justifyContent:"center",paddingTop:"1px",width:"24px",height:"24px"},children:t.jsx("input",{type:"text",value:typeof s=="object"&&s.modifier>0?`+${s.modifier}`:"",onChange:te=>{const ge=[...e.experience||[]],ue=te.target.value.replace(/[^0-9+-]/g,""),Ie=ue===""||ue==="+"?0:parseInt(ue)||0,ke=Math.max(0,Ie);ge[n]={name:typeof s=="string"?s:s.name||"",modifier:ke};const ze=c(ge);o&&o(e.id,{experience:ze})},onKeyDown:te=>{if(te.key==="ArrowUp"||te.key==="ArrowDown"){te.preventDefault();const ge=[...e.experience||[]],ue=typeof s=="object"&&s.modifier||0,Ie=te.key==="ArrowUp"?1:-1;ge[n]={name:typeof s=="string"?s:s.name||"",modifier:Math.max(0,ue+Ie)};const ke=c(ge);o&&o(e.id,{experience:ke})}},style:{width:"24px",height:"24px",border:"1px solid var(--text-secondary)",borderRadius:"4px",backgroundColor:"transparent",display:"flex",alignItems:"center",justifyContent:"center",paddingTop:"1px",fontSize:"0.8rem",fontWeight:600,color:"var(--text-primary)",textAlign:"center",outline:"none"}})}),t.jsxs("div",{style:{marginLeft:"32px",display:"flex",alignItems:"center",gap:"0.5rem"},children:[t.jsx("input",{type:"text",value:typeof s=="string"?s:s.name||"",onChange:te=>{var ze;const ge=[...e.experience||[]],ue=typeof s=="object"&&s.modifier||0;ge[n]={name:te.target.value,modifier:ue};let Ie=c(ge);const ke=Ie[Ie.length-1];ke&&(typeof ke=="string"?ke.trim():(ze=ke.name)!=null&&ze.trim())&&(Ie=[...Ie,{name:"",modifier:0}]),o&&o(e.id,{experience:Ie})},placeholder:"Experience name",style:{flex:1,padding:`${xe} ${ce}`,border:"1px solid var(--border)",borderRadius:"4px",backgroundColor:"var(--bg-primary)",color:"var(--text-primary)",fontSize:"0.875rem",transition:"background-color 0.2s"}}),t.jsxs("div",{style:{display:"flex",gap:"0.125rem"},children:[t.jsx("button",{onClick:()=>{var ke,ze;const te=[...e.experience||[]],ge=typeof s=="string"?s.trim():(ke=s.name)==null?void 0:ke.trim(),ue=te[n-1],Ie=typeof ue=="string"?ue==null?void 0:ue.trim():(ze=ue==null?void 0:ue.name)==null?void 0:ze.trim();if(n>0&&n<te.length&&ge&&Ie){te[n]=ue,te[n-1]=s;const Pe=c(te);o&&o(e.id,{experience:Pe})}},disabled:n===0||!(typeof s=="string"?s.trim():(h=s.name)!=null&&h.trim())||!(typeof r[n-1]=="string"?r[n-1].trim():(b=(S=r[n-1])==null?void 0:S.name)!=null&&b.trim()),style:{width:"22px",height:"22px",padding:"0",border:"1px solid var(--border)",borderRadius:"3px",backgroundColor:n===0||!(typeof s=="string"?s.trim():($=s.name)!=null&&$.trim())||!(typeof r[n-1]=="string"?r[n-1].trim():(_=(L=r[n-1])==null?void 0:L.name)!=null&&_.trim())?"var(--gray-800)":"var(--gray-700)",color:n===0||!(typeof s=="string"?s.trim():(z=s.name)!=null&&z.trim())||!(typeof r[n-1]=="string"?r[n-1].trim():(B=(V=r[n-1])==null?void 0:V.name)!=null&&B.trim())?"var(--text-secondary)":"white",cursor:n===0||!(typeof s=="string"?s.trim():(F=s.name)!=null&&F.trim())||!(typeof r[n-1]=="string"?r[n-1].trim():(y=(E=r[n-1])==null?void 0:E.name)!=null&&y.trim())?"not-allowed":"pointer",opacity:n===0||!(typeof s=="string"?s.trim():(H=s.name)!=null&&H.trim())||!(typeof r[n-1]=="string"?r[n-1].trim():(D=(Q=r[n-1])==null?void 0:Q.name)!=null&&D.trim())?.5:1,fontWeight:"600",fontSize:"12px",lineHeight:"1",transition:"background-color 0.2s",display:"flex",alignItems:"center",justifyContent:"center"},title:"Move up",children:"↑"}),t.jsx("button",{onClick:()=>{var ke,ze;const te=[...e.experience||[]],ge=typeof s=="string"?s.trim():(ke=s.name)==null?void 0:ke.trim(),ue=te[n+1],Ie=typeof ue=="string"?ue==null?void 0:ue.trim():(ze=ue==null?void 0:ue.name)==null?void 0:ze.trim();if(n<te.length-1&&n>=0&&ge&&Ie){te[n]=ue,te[n+1]=s;const Pe=c(te);o&&o(e.id,{experience:Pe})}},disabled:n===r.length-1||!(typeof s=="string"?s.trim():(C=s.name)!=null&&C.trim())||!(typeof r[n+1]=="string"?r[n+1].trim():(j=(v=r[n+1])==null?void 0:v.name)!=null&&j.trim()),style:{width:"22px",height:"22px",padding:"0",border:"1px solid var(--border)",borderRadius:"3px",backgroundColor:n===r.length-1||!(typeof s=="string"?s.trim():(q=s.name)!=null&&q.trim())||!(typeof r[n+1]=="string"?r[n+1].trim():(T=(w=r[n+1])==null?void 0:w.name)!=null&&T.trim())?"var(--gray-800)":"var(--gray-700)",color:n===r.length-1||!(typeof s=="string"?s.trim():(k=s.name)!=null&&k.trim())||!(typeof r[n+1]=="string"?r[n+1].trim():(K=(A=r[n+1])==null?void 0:A.name)!=null&&K.trim())?"var(--text-secondary)":"white",cursor:n===r.length-1||!(typeof s=="string"?s.trim():(M=s.name)!=null&&M.trim())||!(typeof r[n+1]=="string"?r[n+1].trim():(re=(P=r[n+1])==null?void 0:P.name)!=null&&re.trim())?"not-allowed":"pointer",opacity:n===r.length-1||!(typeof s=="string"?s.trim():(O=s.name)!=null&&O.trim())||!(typeof r[n+1]=="string"?r[n+1].trim():(de=(ee=r[n+1])==null?void 0:ee.name)!=null&&de.trim())?.5:1,fontWeight:"600",fontSize:"12px",lineHeight:"1",transition:"background-color 0.2s",display:"flex",alignItems:"center",justifyContent:"center"},title:"Move down",children:"↓"}),t.jsx("button",{onClick:()=>u(s,n),disabled:!(typeof s=="string"?s.trim():(he=s.name)!=null&&he.trim()),style:{width:"22px",height:"22px",padding:"0",border:"1px solid var(--border)",borderRadius:"3px",backgroundColor:i[l(s,n)]?"var(--danger)":(typeof s=="string"?s.trim():(Le=s.name)!=null&&Le.trim())?"var(--gray-700)":"var(--gray-800)",color:(typeof s=="string"?s.trim():(be=s.name)!=null&&be.trim())?"white":"var(--text-secondary)",cursor:(typeof s=="string"?s.trim():(Me=s.name)!=null&&Me.trim())?"pointer":"not-allowed",opacity:(typeof s=="string"?s.trim():(De=s.name)!=null&&De.trim())?1:.5,fontWeight:"600",fontSize:"12px",lineHeight:"1",transition:"background-color 0.2s",display:"flex",alignItems:"center",justifyContent:"center"},title:i[l(s,n)]?"Click again to confirm delete":"Delete experience",children:"×"})]})]})]},n)})})},x=()=>!e.experience||e.experience.length===0?null:t.jsx("div",{style:{display:"flex",flexDirection:"column",gap:xe},children:e.experience.map((m,r)=>{if(typeof m=="string"){const s=m.match(/^(.+?)\s*([+-]?\d+)$/);if(s){const[,n,h]=s;return t.jsxs("div",{style:{position:"relative"},children:[t.jsx("div",{style:{position:"absolute",left:0,top:"50%",transform:"translateY(-50%)",display:"flex",alignItems:"center",justifyContent:"center",paddingTop:"1px",width:"24px",height:"24px"},children:t.jsx("div",{style:{width:"24px",height:"24px",border:"1px solid var(--text-secondary)",borderRadius:"4px",backgroundColor:"transparent",display:"flex",alignItems:"center",justifyContent:"center",paddingTop:"1px"},children:t.jsx("span",{style:{fontSize:"0.8rem",fontWeight:600,color:"var(--text-primary)"},children:h})})}),t.jsx("span",{style:{marginLeft:"32px"},children:n})]},r)}return t.jsx("div",{children:m},r)}return t.jsxs("div",{style:{position:"relative"},children:[t.jsx("div",{style:{position:"absolute",left:0,top:"50%",transform:"translateY(-50%)",display:"flex",alignItems:"center",justifyContent:"center",paddingTop:"1px",width:"24px",height:"24px"},children:t.jsx("div",{style:{width:"24px",height:"24px",border:"1px solid var(--text-secondary)",borderRadius:"4px",backgroundColor:"transparent",display:"flex",alignItems:"center",justifyContent:"center",paddingTop:"1px"},children:t.jsxs("span",{style:{fontSize:"0.8rem",fontWeight:600,color:"var(--text-primary)"},children:[m.modifier>=0?"+":"",m.modifier]})})}),t.jsx("span",{style:{marginLeft:"32px"},children:m.name})]},r)})});return t.jsx("div",{style:{paddingTop:"0"},children:a?p():t.jsx("div",{style:{fontSize:"0.875rem",lineHeight:1.4,color:"var(--text-secondary)"},children:x()})})},vt={background:"var(--bg-secondary)",border:"1px solid var(--border)",color:"var(--text-primary)",borderRadius:"4px",padding:"0",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",width:"32px",height:"32px",fontSize:"0.7rem",transition:"all 0.2s ease"},Vt={background:"var(--purple)",border:"1px solid var(--purple)",color:"white",borderRadius:"4px",padding:"0.375rem 0.75rem",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"0.375rem",fontSize:"0.875rem",fontWeight:"500",transition:"all 0.2s ease"},Vr=({showCustomCreator:e,onSaveCustomAdversary:a,item:o,onCancelEdit:i,onRemoveInstance:d,onAddInstance:l,instances:c,onEdit:u})=>e?t.jsxs(t.Fragment,{children:[t.jsxs("button",{onClick:p=>{p.stopPropagation(),a&&(a(o,o.id),i&&i())},style:Vt,onMouseEnter:p=>{p.currentTarget.style.opacity="0.9"},onMouseLeave:p=>{p.currentTarget.style.opacity="1"},title:"Save",children:[t.jsx(Jt,{size:16}),t.jsx("span",{children:"Save"})]}),i&&t.jsxs("button",{onClick:p=>{p.stopPropagation(),i()},style:{...Vt,background:"var(--bg-secondary)",border:"1px solid var(--border)",color:"var(--text-primary)"},onMouseEnter:p=>{p.currentTarget.style.backgroundColor="var(--bg-hover)",p.currentTarget.style.borderColor="var(--purple)"},onMouseLeave:p=>{p.currentTarget.style.backgroundColor="var(--bg-secondary)",p.currentTarget.style.borderColor="var(--border)"},title:"Cancel",children:[t.jsx(nt,{size:16}),t.jsx("span",{children:"Cancel"})]})]}):t.jsxs(t.Fragment,{children:[t.jsx("button",{onClick:p=>{p.stopPropagation(),d&&d(o.id)},style:vt,onMouseEnter:p=>{p.currentTarget.style.backgroundColor="var(--bg-hover)",p.currentTarget.style.borderColor="var(--purple)"},onMouseLeave:p=>{p.currentTarget.style.backgroundColor="var(--bg-secondary)",p.currentTarget.style.borderColor="var(--border)"},title:"Remove one",children:t.jsx(ct,{size:16})}),t.jsx("span",{style:{color:"var(--text-primary)",fontSize:"1rem",fontWeight:"500",minWidth:"24px",textAlign:"center"},children:c.length}),t.jsx("button",{onClick:p=>{p.stopPropagation(),l&&l(o)},style:vt,onMouseEnter:p=>{p.currentTarget.style.backgroundColor="var(--purple)",p.currentTarget.style.borderColor="var(--purple)",p.currentTarget.style.color="white"},onMouseLeave:p=>{p.currentTarget.style.backgroundColor="var(--bg-secondary)",p.currentTarget.style.borderColor="var(--border)",p.currentTarget.style.color="var(--text-primary)"},title:"Add another",children:t.jsx(Xe,{size:16})}),u&&t.jsx("button",{onClick:p=>{p.stopPropagation(),u(o.id)},style:{...vt,marginLeft:"0.25rem"},onMouseEnter:p=>{p.currentTarget.style.backgroundColor="var(--purple)",p.currentTarget.style.borderColor="var(--purple)",p.currentTarget.style.color="white"},onMouseLeave:p=>{p.currentTarget.style.backgroundColor="var(--bg-secondary)",p.currentTarget.style.borderColor="var(--border)",p.currentTarget.style.color="var(--text-primary)"},title:"Edit",children:t.jsx(hr,{size:16})})]}),Kr=e=>{const a=f.useRef(null),o=f.useRef(e.length),i=f.useRef(null),d=f.useRef(null),l=f.useRef(null);return f.useEffect(()=>{const c=a.current;if(!c)return;const u=()=>{i.current=c.scrollHeight,d.current=c.scrollTop};c.addEventListener("scroll",u,{passive:!0});const p=setInterval(u,100);return()=>{c.removeEventListener("scroll",u),clearInterval(p),l.current&&(cancelAnimationFrame(l.current),l.current=null)}},[]),f.useEffect(()=>()=>{const c=a.current;c&&(i.current=c.scrollHeight,d.current=c.scrollTop)},[e.length,e]),f.useLayoutEffect(()=>{const c=e.length,u=o.current,p=a.current;if(!p){o.current=c;return}if(c!==u){const x=i.current,m=d.current;if(!x||m===null){o.current=c;return}const r=p.scrollHeight,s=p.clientHeight;if(c>u){const n=r-s,h=p.scrollTop,S=n-h;if(Math.abs(S)>.5){l.current&&(cancelAnimationFrame(l.current),l.current=null);const b=400,$=performance.now(),L=_=>{const z=_-$,V=Math.min(z/b,1),B=1-V,F=1-B*B*B,E=h+S*F;p.scrollTop=E,V<1?l.current=requestAnimationFrame(L):(p.scrollTop=n,l.current=null)};l.current=requestAnimationFrame(L)}}}o.current=c},[e.length,e]),{scrollableContentRef:a}},Fe={transitions:{hoverIn:"all 0.1s ease",hoverOut:"all 0.3s ease"},card:{backgroundColor:"var(--bg-card)",borderRadius:"8px",padding:"8px",cursor:"pointer",transition:"all 0.1s ease",position:"relative",border:"none"},cardHover:{backgroundColor:"var(--bg-card-hover)"},cardDead:{opacity:.6,backgroundColor:"var(--gray-800)",borderColor:"var(--border)"},cardAtMax:{backgroundColor:"var(--success)",borderColor:"var(--success)"},rowMain:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px"},rowTitle:{fontSize:"16px",fontWeight:"600",color:"var(--text-primary)",margin:0},rowMeta:{display:"flex",gap:"8px",alignItems:"center"},badge:{padding:"2px 6px",borderRadius:"3px",fontSize:"0.6875rem",fontWeight:"500",textTransform:"uppercase"},typeBadge:{backgroundColor:"var(--purple)",color:"var(--text-primary)"},tierBadge:{backgroundColor:"var(--info)",color:"var(--text-primary)"}},Gr=({item:e,type:a,mode:o="expanded",onClick:i,onApplyDamage:d,onApplyHealing:l,onApplyStressChange:c,onUpdate:u,adversaries:p=[],isSelected:x=!1,instances:m=[],isEmbedded:r=!1,onAddInstance:s=null,onRemoveInstance:n=null,onEdit:h=null,showCustomCreator:S=!1,onSaveCustomAdversary:b=null,onCancelEdit:$=null,isStockAdversary:L=!1})=>{const{scrollableContentRef:_}=Kr(m),z=f.useRef(null),V=f.useRef(null),[B,F]=f.useState({});f.useEffect(()=>{if(S&&z.current){const w=setTimeout(()=>{var T,k;(T=z.current)==null||T.focus(),(k=z.current)==null||k.select()},650);return()=>clearTimeout(w)}},[S]);const E=w=>{const k=(e.features||[]).filter(A=>A.type===w.type).findIndex(A=>A===w);return`${w.type}-${k}-${w.name||"blank"}`},y=w=>{const T=E(w);if(B[T]){const k=e.features.filter(A=>A!==w);u&&u(e.id,{features:k}),F(A=>{const K={...A};return delete K[T],K})}else F(k=>({...k,[T]:!0})),setTimeout(()=>{F(k=>{const A={...k};return delete A[T],A})},3e3)},H=(w=!1)=>{let T={...Fe.card};if(x?T.transition="none":T.transition=Fe.transitions.hoverOut,w){const{marginTop:k,...A}=T;T=A}return x&&(T={...T,...Fe.cardHover}),a==="adversary"&&(e.hp||0)>=(e.hpMax||1)&&(T={...T,...Fe.cardDead}),T},Q=()=>{if(r)return"";let w="border rounded-lg";return x&&(w+=" border-hover"),w},D=()=>{var w;if(a==="adversary"||a==="adversaries"){const T=e.baseName||((w=e.name)==null?void 0:w.replace(/\s+\(\d+\)$/,""))||"",k=e.duplicateNumber||1,A=[...p];return p.some(P=>P.id===e.id)||A.push(e),A.filter(P=>P.baseName===T).length>1?`${T} (${k})`:T}return e.name},C=()=>{const w=[];return e.type&&w.push(t.jsx("span",{style:{...Fe.badge,...Fe.typeBadge},children:e.type},"type")),w},v=()=>{var K;const w=(e.hp||0)>=(e.hpMax||1),T=j==="edit"||S,k=a==="adversary",A=k?t.jsx(Vr,{showCustomCreator:S,onSaveCustomAdversary:b,item:e,onCancelEdit:$,onRemoveInstance:n,onAddInstance:s,instances:m,onEdit:h}):null;return t.jsx(Ct,{tabContent:A,showTab:k,tabBorderColor:x?"var(--purple)":"var(--border)",containerBackgroundColor:w?"var(--gray-900)":H(!0).backgroundColor,containerBorderColor:w?"color-mix(in srgb, var(--gray-600) 40%, transparent)":x?"var(--purple)":"var(--border)",containerBorderRadius:"8px",containerOverflow:"hidden",containerStyle:{padding:0,opacity:w?.7:1,height:"auto",maxHeight:k?"calc(100vh - 120px)":"calc(100vh - 68px)",minHeight:0},children:t.jsxs("div",{className:Q(),style:{...H(!0),padding:0,display:"flex",flexDirection:"column",position:"relative",height:"100%",minHeight:0,border:"none",borderRadius:0},onClick:i,children:[w&&t.jsx(t.Fragment,{children:t.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,background:`repeating-linear-gradient(
                45deg,
                transparent,
                transparent 8px,
                var(--gray-600) 1px,
                var(--gray-600) 9px
              )`,pointerEvents:"none",zIndex:9999}})}),t.jsx("div",{className:"border-b",style:{paddingTop:xe,paddingBottom:xe,paddingLeft:ce,paddingRight:ce,flexShrink:0,backgroundColor:"var(--bg-card)",borderRadius:"8px 8px 0 0",position:"relative",zIndex:w?1:"auto",borderBottomColor:x?"var(--purple)":"var(--border)"},children:t.jsx("div",{style:{display:"flex",flexDirection:"column",position:"relative",zIndex:w?1:"auto",padding:0,gap:0},children:t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[T?t.jsx("input",{ref:z,type:"text",value:e.name||"",onChange:M=>{u&&e.id&&u(e.id,{name:M.target.value})},style:{backgroundColor:"var(--bg-primary)",border:"1px solid var(--border)",borderRadius:"4px",color:"var(--text-primary)",fontSize:"1.1rem",fontWeight:"600",padding:`${xe} ${ce}`,width:"100%",maxWidth:"300px",paddingRight:"0.625rem"},placeholder:"Name"}):t.jsx("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",flex:1},children:t.jsx("h4",{style:{...Fe.rowTitle,color:w?"color-mix(in srgb, var(--gray-400) 80%, transparent)":Fe.rowTitle.color,textAlign:"left",margin:0,fontSize:"1.1rem",paddingRight:"6px",flex:1,textTransform:"uppercase"},children:((K=e.name)==null?void 0:K.replace(/\s+\(\d+\)$/,""))||e.name})}),(e.type||e.tier||T)&&t.jsx(_r,{type:e.type,tier:e.tier,isEditMode:T,onUpdate:u,itemId:e.id})]})})}),t.jsxs("div",{ref:_,style:{borderRadius:"0 0 8px 8px",flex:1,overflowY:"auto",overflowX:"hidden",minHeight:0},className:"invisible-scrollbar",children:[(e.motives||T)&&t.jsx("div",{style:{padding:`${xe} ${ce}`,textAlign:"center"},children:T?t.jsx("input",{type:"text",value:e.motives||"",onChange:M=>u&&u(e.id,{motives:M.target.value}),placeholder:"Motives...",style:{width:"100%",padding:`${xe} ${ce}`,border:"1px solid var(--border)",borderRadius:"4px",backgroundColor:"var(--bg-primary)",color:"var(--text-primary)",fontSize:"0.875rem",textAlign:"center"}}):t.jsxs("div",{style:{fontSize:"0.875rem",fontStyle:"italic",color:"var(--text-secondary)",lineHeight:1.4,textAlign:"center"},children:[e.motives,e.motives&&!e.motives.endsWith(".")?".":""]})}),(e.difficulty||e.atk!==void 0||e.thresholds&&e.type!=="Minion"||e.experience&&e.experience.length>0||T)&&t.jsxs("div",{style:{padding:"0.5rem 8px",display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[t.jsxs("div",{style:{display:"flex",flexDirection:"column"},children:[(e.difficulty||T)&&t.jsxs("div",{style:{position:"relative",marginBottom:"0.75rem"},children:[t.jsxs("div",{style:{position:"absolute",left:0,top:"50%",transform:"translateY(-50%)",display:"flex",alignItems:"center",justifyContent:"center",paddingTop:"1px",width:"36px"},children:[t.jsx(xr,{size:32,strokeWidth:1,style:{color:"var(--text-secondary)",transform:"rotate(0deg)"}}),T?t.jsx("input",{type:"text",value:e.difficulty||"",onChange:M=>{const P=M.target.value.replace(/[^0-9]/g,"");P.length<=2&&u&&u(e.id,{difficulty:parseInt(P)||0})},onKeyDown:M=>{if(M.key==="ArrowUp"){M.preventDefault();const P=parseInt(e.difficulty)||0;u&&u(e.id,{difficulty:Math.min(P+1,99)})}else if(M.key==="ArrowDown"){M.preventDefault();const P=parseInt(e.difficulty)||0;u&&u(e.id,{difficulty:Math.max(P-1,0)})}},style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -45%)",backgroundColor:"transparent",border:"none",color:"white",fontSize:"0.8rem",fontWeight:600,width:"20px",height:"20px",textAlign:"center",outline:"none"},maxLength:"2"}):t.jsx("span",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -45%)",fontSize:"0.8rem",fontWeight:600,color:"white",pointerEvents:"none"},children:e.difficulty})]}),t.jsx("div",{style:{fontSize:"0.875rem",lineHeight:1.4,color:"var(--text-secondary)",marginLeft:"44px"},children:"Difficulty"})]}),(e.atk!==void 0||T)&&t.jsxs("div",{style:{position:"relative",marginBottom:"0.75rem"},children:[t.jsxs("div",{style:{position:"absolute",left:0,top:"50%",transform:"translateY(-50%)",display:"flex",alignItems:"center",justifyContent:"center",paddingTop:"1px",width:"36px"},children:[t.jsx(gr,{size:38,strokeWidth:1,style:{color:"var(--text-secondary)",transform:"rotate(45deg)"}}),T?t.jsx("input",{type:"text",value:(()=>{if(typeof e.atk=="string"&&e.atk.includes("d"))return e.atk;const M=typeof e.atk=="string"?parseInt(e.atk.replace(/[^0-9-]/g,"")):e.atk||0;return M>=0?`+${M}`:M.toString()})(),onChange:M=>{const P=M.target.value;if(P.includes("d"))u&&u(e.id,{atk:P});else{const re=P.replace(/[^0-9+-]/g,"");if(re.length<=4){const O=parseInt(re.replace(/[^0-9-]/g,""))||0;u&&u(e.id,{atk:O})}}},onKeyDown:M=>{if(!(typeof e.atk=="string"&&e.atk.includes("d"))){if(M.key==="ArrowUp"){M.preventDefault();const re=(typeof e.atk=="string"?parseInt(e.atk.replace(/[^0-9-]/g,"")):e.atk||0)+1;u&&u(e.id,{atk:re})}else if(M.key==="ArrowDown"){M.preventDefault();const re=(typeof e.atk=="string"?parseInt(e.atk.replace(/[^0-9-]/g,"")):e.atk||0)-1;u&&u(e.id,{atk:re})}}},style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -45%)",backgroundColor:"transparent",border:"none",color:"white",fontSize:"0.8rem",fontWeight:600,width:"20px",height:"20px",textAlign:"center",outline:"none"},maxLength:"3"}):t.jsx("span",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -45%)",fontSize:"0.8rem",fontWeight:600,color:"white",pointerEvents:"none"},children:(()=>{if(typeof e.atk=="string"&&e.atk.includes("d"))return e.atk;const M=typeof e.atk=="string"?parseInt(e.atk.replace(/[^0-9-]/g,"")):e.atk;return M>=0?`+${M}`:M})()})]}),t.jsx("div",{style:{fontSize:"0.875rem",lineHeight:1.4,color:"var(--text-secondary)",marginLeft:"44px"},children:"Attack"})]})]}),t.jsx(qr,{item:e,isEditMode:T,onUpdate:u,deleteConfirmations:B,setDeleteConfirmations:F})]}),t.jsx($r,{item:e,isEditMode:T,onUpdate:u,handleFeatureDeleteClick:y,deleteConfirmations:B,getFeatureKey:E}),t.jsx(Fr,{item:e,instances:m,isEditMode:T,type:a,onUpdate:u,onApplyDamage:d,onApplyHealing:l,onApplyStressChange:c}),t.jsx(Or,{item:e,isEditMode:T,mode:o,onUpdate:u})]})]})})};if(S&&(a==="adversary"||a==="adversaries")){const w=a==="adversary",T=w?t.jsxs(t.Fragment,{children:[t.jsxs("button",{onClick:k=>{var A;k.stopPropagation(),(A=V.current)!=null&&A.handleSave&&V.current.handleSave()},style:{background:"var(--purple)",border:"1px solid var(--purple)",color:"white",borderRadius:"4px",padding:"0.375rem 0.75rem",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"0.375rem",fontSize:"0.875rem",fontWeight:"500",transition:"all 0.2s ease"},onMouseEnter:k=>{k.currentTarget.style.opacity="0.9"},onMouseLeave:k=>{k.currentTarget.style.opacity="1"},title:"Save",children:[t.jsx(Jt,{size:16}),t.jsx("span",{children:"Save"})]}),$&&t.jsxs("button",{onClick:k=>{k.stopPropagation(),$()},style:{background:"var(--bg-secondary)",border:"1px solid var(--border)",color:"var(--text-primary)",borderRadius:"4px",padding:"0.375rem 0.75rem",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"0.375rem",fontSize:"0.875rem",fontWeight:"500",transition:"all 0.2s ease"},onMouseEnter:k=>{k.currentTarget.style.backgroundColor="var(--bg-hover)",k.currentTarget.style.borderColor="var(--purple)"},onMouseLeave:k=>{k.currentTarget.style.backgroundColor="var(--bg-secondary)",k.currentTarget.style.borderColor="var(--border)"},title:"Cancel",children:[t.jsx(nt,{size:16}),t.jsx("span",{children:"Cancel"})]})]}):null;return t.jsx(Ct,{tabContent:T,containerStyle:{padding:0,height:"auto",maxHeight:w?"calc(100vh - 120px)":"calc(100vh - 68px)",minHeight:0},children:t.jsx(kt,{ref:V,editingAdversary:e,onSave:b,onCancelEdit:$,isStockAdversary:L,embedded:!0,hideEmbeddedButtons:!0,allAdversaries:p,autoFocus:!e.baseName||e.baseName.trim()===""||e.baseName==="Unknown"})})}const j=S?"edit":o;return(j==="expanded"||j==="edit")&&(a==="adversary"||a==="adversaries")?v():a==="adversary"||a==="adversaries"?null:t.jsxs("div",{className:Q(),style:H(!0),children:[t.jsxs("div",{style:Fe.rowMain,children:[t.jsx("h4",{style:Fe.rowTitle,children:D()}),t.jsx("div",{style:Fe.rowMeta,children:C()})]}),t.jsxs("p",{style:{color:"var(--text-secondary)",fontSize:"12px",margin:0},children:["Expanded view coming soon for ",a]})]})},pt=Gr,Jr="/Daggerheart/assets/daggerheart-logo-fe7815ad.svg",Ze={Minion:1,Social:1,Support:1,Horde:2,Ranged:2,Skulk:2,Standard:2,Leader:3,Bruiser:4,Solo:5},Ge={lessDifficult:-1,twoOrMoreSolos:-2,increasedDamage:-2,lowerTierAdversary:1,noBruisersHordesLeadersSolos:1,moreDangerous:2};function Ut(e){return 3*e+2}function er(e,a){return e.reduce((o,i)=>{if(i.type==="adversary"){const d=Ze[i.item.type]||2;return i.item.type==="Minion"?o+Math.ceil(i.quantity/a)*d:o+d*i.quantity}return o},0)}function tr(e){let a=0;return e.filter(d=>d.type==="adversary"&&d.item.type==="Solo"&&d.quantity>0).reduce((d,l)=>d+l.quantity,0)>=2&&(a+=Ge.twoOrMoreSolos),e.some(d=>d.type==="adversary"&&d.item.type&&["Bruiser","Horde","Leader","Solo"].includes(d.item.type)&&d.quantity>0)||(a+=Ge.noBruisersHordesLeadersSolos),a}function Yr(e,a={}){const o=Ut(e),i=Object.entries(a).filter(([d,l])=>l).reduce((d,[l,c])=>d+Ge[l],0);return o+i}let lt={adversaries:[]},dt={environments:[]},jt=!1;function Xr(){const e=JSON.parse(localStorage.getItem("daggerheart-custom-adversaries")||"[]"),a=JSON.parse(localStorage.getItem("daggerheart-custom-environments")||"[]");return{customAdversaries:e,customEnvironments:a}}async function rr(){if(jt)return{adversariesData:lt,environmentsData:dt};let e={adversaries:[]},a={environments:[]},o={adversaries:[]},i={environments:[]};try{const c=await Ye(()=>import("./adversaries-9c8932de.js"),[]);e=(c==null?void 0:c.default)||c}catch(c){console.warn("Failed to load adversaries.json:",c)}try{const c=await Ye(()=>import("./environments-c340637c.js"),[]);a=(c==null?void 0:c.default)||c}catch(c){console.warn("Failed to load environments.json:",c)}try{const c=await Ye(()=>import("./playtest-adversaries-4a099c10.js"),[]);o=(c==null?void 0:c.default)||c}catch(c){console.warn("Failed to load playtest-adversaries.json:",c)}try{const c=await Ye(()=>import("./playtest-environments-d9cdffb6.js"),[]);i=(c==null?void 0:c.default)||c}catch(c){console.warn("Failed to load playtest-environments.json:",c)}const{customAdversaries:d,customEnvironments:l}=Xr();return lt={...e,adversaries:[...e.adversaries||[],...o.adversaries||[],...d]},dt={...a,environments:[...a.environments||[],...i.environments||[],...l]},jt=!0,{adversariesData:lt,environmentsData:dt}}function Kt(){return jt=!1,rr()}const Qr=(e,a)=>{const[o,i]=f.useState("max-content"),d=f.useCallback(()=>{if(!a.current||e<=3)return"max-content";const l=a.current.offsetWidth,u=Math.floor(l/120);return u<=1?"max-content":e===4?"max-content max-content":e===5||e===6?u>=2?"max-content max-content":"max-content":e===7?u>=3?"max-content max-content max-content":u>=2?"max-content max-content":"max-content":"repeat(auto-fit, minmax(80px, max-content))"},[e,a]);return f.useEffect(()=>{const l=d();i(l);const c=new ResizeObserver(()=>{const u=d();i(u)});return a.current&&c.observe(a.current),()=>{c.disconnect()}},[d]),o},Zr=({encounter:e})=>{var d,l;const a=f.useRef(null),o=((d=e.encounterItems)==null?void 0:d.length)||0,i=Qr(o,a);return t.jsx("div",{ref:a,className:"saved-encounter-adversary-list",style:{flex:1,fontSize:"0.8rem",color:"var(--text-secondary)",lineHeight:"1.3",display:"grid",gridTemplateColumns:i,gap:"0.25rem 1rem",gridAutoRows:"min-content"},children:((l=e.encounterItems)==null?void 0:l.length)>0?e.encounterItems.map((c,u)=>{var x;const p=c.item.baseName||((x=c.item.name)==null?void 0:x.replace(/\s+\(\d+\)$/,""))||c.item.name;return t.jsxs("div",{style:{marginBottom:"0.125rem"},children:[c.quantity,"x ",p]},u)}):t.jsx("div",{children:"No adversaries"})})};let _e=lt,rt=dt;const Ur=async()=>{const e=await rr();_e=e.adversariesData,rt=e.environmentsData},en=(e,a=[],o=4,i=1,d=!1,l=null)=>{const[c,u]=f.useState(""),[p,x]=f.useState([{field:"tier",direction:"asc"},{field:"name",direction:"asc"}]),[m,r]=f.useState([]),[s,n]=f.useState(!0),[h,S]=f.useState([]),[b,$]=f.useState([]),[L,_]=f.useState(!1),[z,V]=f.useState(!1),B=f.useRef(null),F=f.useRef(null);f.useEffect(()=>{(async()=>{await Ur(),n(!1);let A=[];e==="adversary"?A=_e.adversaries||[]:e==="environment"&&(A=rt.environments||[]),r(A)})()},[e]),f.useEffect(()=>{e==="adversary"&&l&&(async()=>{const A=await Kt();_e=A.adversariesData,rt=A.environmentsData;let K=[];d?K=(_e.adversaries||[]).filter(M=>{var P;return M.source==="Homebrew"||((P=M.id)==null?void 0:P.startsWith("custom-"))}):K=_e.adversaries||[],r(K)})()},[l,e,d]);const E=k=>{const A=m.map(K=>K[k]).filter(Boolean);return[...new Set(A)].sort((K,M)=>typeof K=="number"&&typeof M=="number"?K-M:String(K).localeCompare(String(M)))},y=f.useCallback(async()=>{const k=await Kt();_e=k.adversariesData,rt=k.environmentsData;let A=[];e==="adversary"?d?A=(_e.adversaries||[]).filter(K=>{var M;return K.source==="Homebrew"||((M=K.id)==null?void 0:M.startsWith("custom-"))}):A=_e.adversaries||[]:e==="environment"&&(A=rt.environments||[]),r(A)},[e,d]);f.useEffect(()=>{y()},[d,y]);const H=E("tier"),Q=E("type"),D=f.useMemo(()=>{let k=m.filter(A=>{var O,ee;const M=(A.name||A.baseName||"").toLowerCase().includes(c.toLowerCase())||((O=A.type)==null?void 0:O.toLowerCase().includes(c.toLowerCase()))||((ee=A.description)==null?void 0:ee.toLowerCase().includes(c.toLowerCase())),P=h.length===0||h.includes(A.tier.toString()),re=b.length===0||b.includes(A.type);return M&&P&&re});return k.sort((A,K)=>{for(const M of p){const{field:P,direction:re}=M;let O=A[P],ee=K[P];if(P==="tier")O=parseInt(O)||0,ee=parseInt(ee)||0;else if(P==="atk")O=parseInt(O)||0,ee=parseInt(ee)||0;else if(P==="cost"){const de=he=>{if(e!=="adversary")return 0;const Le=Ze[he.type]||2;let be=0;const Me=a.filter(te=>te.type==="adversary"&&te.item.type==="Solo"&&te.quantity>0).reduce((te,ge)=>te+ge.quantity,0),De=a.filter(te=>te.type==="adversary"&&["Bruiser","Horde","Leader","Solo"].includes(te.item.type)&&te.quantity>0).reduce((te,ge)=>te+ge.quantity,0);return he.type==="Solo"&&Me===1&&(be+=2),["Bruiser","Horde","Leader","Solo"].includes(he.type)&&De===0&&(be+=1),Le+be};O=de(A),ee=de(K)}else if(P==="difficulty"){const de=parseInt(O),he=parseInt(ee);!isNaN(de)&&!isNaN(he)?(O=de,ee=he):!isNaN(de)&&isNaN(he)?(O=de,ee=999):isNaN(de)&&!isNaN(he)?(O=999,ee=he):(O=String(O||"").toLowerCase(),ee=String(ee||"").toLowerCase())}else typeof O=="string"&&typeof ee=="string"?(O=O.toLowerCase(),ee=ee.toLowerCase()):(O=String(O||"").toLowerCase(),ee=String(ee||"").toLowerCase());if(re==="asc"){if(O>ee)return 1;if(O<ee)return-1}else{if(O<ee)return 1;if(O>ee)return-1}}return 0}),k},[m,c,p,h,b,a,o,i]),C=k=>{x(A=>{const K=A.findIndex(M=>M.field===k);if(K>=0)if(K===0){const M=[...A];return M[0]={...M[0],direction:M[0].direction==="asc"?"desc":"asc"},M}else{const M=[...A];return M.splice(K,1)[0],[{field:k,direction:"asc"},...M]}else return[{field:k,direction:"asc"},...A]})},v=k=>{S(k==="clear"?[]:A=>A.includes(k)?A.filter(K=>K!==k):[...A,k])},j=k=>{$(k==="clear"?[]:A=>A.includes(k)?A.filter(K=>K!==k):[...A,k])},q=h.length>0,w=b.length>0;return f.useEffect(()=>{const k=K=>{const M=K.target.closest(".filter-dropdown"),P=K.target.closest(".header-filter-icon");M||P||(_(!1),V(!1))},A=K=>{K.key==="Escape"&&(_(!1),V(!1))};return document.addEventListener("pointerdown",k,!0),document.addEventListener("mousedown",k,!0),document.addEventListener("touchstart",k,!0),document.addEventListener("click",k,!0),document.addEventListener("keydown",A,!0),()=>{document.removeEventListener("pointerdown",k,!0),document.removeEventListener("mousedown",k,!0),document.removeEventListener("touchstart",k,!0),document.removeEventListener("click",k,!0),document.removeEventListener("keydown",A,!0)}},[_,V]),{searchTerm:c,setSearchTerm:u,sortFields:p,handleSort:C,filteredAndSortedData:D,loading:s,refreshData:y,selectedTiers:h,selectedTypes:b,showTierDropdown:L,setShowTierDropdown:_,showTypeDropdown:z,setShowTypeDropdown:V,tierFilterRef:B,typeFilterRef:F,uniqueTiers:H,uniqueTypes:Q,handleTierSelect:v,handleTypeSelect:j,isTierFiltered:q,isTypeFiltered:w,getDropdownStyle:k=>{if(!k.current)return{};const A=k.current.getBoundingClientRect();return{position:"fixed",top:A.bottom+4,left:A.left-100,zIndex:99999}}}},tn=({searchTerm:e,onSearchChange:a,type:o,partyControls:i,showCustomToggle:d=!1,onToggleCustom:l,filterCustom:c=!1,onExportCustomAdversaries:u,onImportCustomAdversaries:p,autoFocus:x=!1,onClose:m=null,placeholder:r="Search"})=>{const s=f.useRef(null);return f.useEffect(()=>{x&&s.current&&setTimeout(()=>{var n;(n=s.current)==null||n.focus()},100)},[x]),t.jsxs("div",{className:"browser-header",style:G.browserHeader,children:[t.jsx("div",{style:{display:"flex",alignItems:"center",flex:1,gap:"0.5rem"},children:t.jsx("input",{ref:s,type:"text",placeholder:r,value:e,onChange:n=>a(n.target.value),style:{...G.searchInput,flex:1,marginRight:0}})}),i&&t.jsx("div",{style:G.partyControls,children:i})]})},rn=({showCustomToggle:e=!1,onToggleCustom:a,filterCustom:o=!1,onExportCustomAdversaries:i,onImportCustomAdversaries:d})=>t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem",padding:"0.75rem 1rem",backgroundColor:"var(--bg-secondary)",borderBottom:"1px solid var(--border)",flexShrink:0},children:[e&&t.jsxs("button",{onClick:()=>a&&a(!o),style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.5rem 1rem",backgroundColor:o?"var(--purple)":"var(--bg-primary)",border:"1px solid var(--border)",borderRadius:"var(--radius-md)",color:o?"white":"var(--text-primary)",fontSize:"0.875rem",cursor:"pointer",transition:"all 0.2s ease",whiteSpace:"nowrap"},onMouseEnter:l=>{o||(l.target.style.backgroundColor="var(--bg-hover)",l.target.style.borderColor="var(--purple)")},onMouseLeave:l=>{o||(l.target.style.backgroundColor="var(--bg-primary)",l.target.style.borderColor="var(--border)")},children:[t.jsx("span",{children:o?"✓":"○"}),"Custom Only"]}),t.jsxs("button",{onClick:i,style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.5rem 1rem",backgroundColor:"var(--bg-primary)",border:"1px solid var(--border)",borderRadius:"var(--radius-md)",color:"var(--text-primary)",fontSize:"0.875rem",cursor:"pointer",transition:"all 0.2s ease",whiteSpace:"nowrap"},onMouseEnter:l=>{l.target.style.backgroundColor="var(--bg-hover)",l.target.style.borderColor="var(--purple)"},onMouseLeave:l=>{l.target.style.backgroundColor="var(--bg-primary)",l.target.style.borderColor="var(--border)"},children:[t.jsx("span",{children:"↓"}),"Export"]}),t.jsxs("button",{onClick:()=>document.getElementById("import-file-input").click(),style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.5rem 1rem",backgroundColor:"var(--bg-primary)",border:"1px solid var(--border)",borderRadius:"var(--radius-md)",color:"var(--text-primary)",fontSize:"0.875rem",cursor:"pointer",transition:"all 0.2s ease",whiteSpace:"nowrap"},onMouseEnter:l=>{l.target.style.backgroundColor="var(--bg-hover)",l.target.style.borderColor="var(--purple)"},onMouseLeave:l=>{l.target.style.backgroundColor="var(--bg-primary)",l.target.style.borderColor="var(--border)"},children:[t.jsx("span",{children:"↑"}),"Import"]}),t.jsx("input",{id:"import-file-input",type:"file",accept:".csv,.json",onChange:d,style:{display:"none"}})]}),nn=({sortFields:e,onSort:a,type:o,uniqueTiers:i,uniqueTypes:d,selectedTiers:l,selectedTypes:c,showTierDropdown:u,setShowTierDropdown:p,showTypeDropdown:x,setShowTypeDropdown:m,tierFilterRef:r,typeFilterRef:s,handleTierSelect:n,handleTypeSelect:h,isTierFiltered:S,isTypeFiltered:b,getDropdownStyle:$,costFilter:L,showCostDropdown:_,setShowCostDropdown:z,costFilterRef:V,handleCostFilterSelect:B,isCostFiltered:F})=>{const[E,y]=f.useState(null),Q=(()=>o==="adversary"?[{key:"name",label:"Name"},{key:"tier",label:"Tier",hasFilter:!0},{key:"type",label:"Type",hasFilter:!0,hasCostFilter:!0},{key:"source",label:"Src"}]:o==="environment"?[{key:"name",label:"Name"},{key:"tier",label:"Tier",hasFilter:!0},{key:"type",label:"Type",hasFilter:!0},{key:"difficulty",label:"Diff"}]:[])(),D=()=>{if(!_)return null;const v=[{value:"all",label:"All"},{value:"auto-grey",label:"Auto Grey"},{value:"auto-hide",label:"Auto Hide"}];return wt.createPortal(t.jsx("div",{className:"filter-dropdown",style:{...G.filterDropdown,...$(V),maxHeight:"60vh",overflow:"auto"},onMouseDown:j=>j.stopPropagation(),onClick:j=>j.stopPropagation(),children:v.map(j=>{const q=L===j.value;return t.jsxs("div",{style:{...G.filterOption,...q?G.filterOptionSelected:{}},onClick:()=>B(j.value),children:[t.jsx("span",{style:G.checkIcon,children:q?t.jsx(gt,{size:16}):t.jsx(yt,{size:16})}),t.jsx("span",{style:G.filterLabel,children:j.label})]},j.value)})}),document.body)},C=(v,j,q,w,T,k,A,K)=>{if(!T)return null;const M=()=>{(v==="tier"||v==="type")&&w("clear")};return wt.createPortal(t.jsxs("div",{className:"filter-dropdown",style:{...G.filterDropdown,...$(A),maxHeight:"60vh",overflow:"auto"},onMouseDown:P=>P.stopPropagation(),onClick:P=>P.stopPropagation(),children:[t.jsxs("div",{style:{...G.filterOption,...q.length===0?G.filterOptionSelected:{}},onClick:M,children:[t.jsx("span",{style:G.checkIcon,children:q.length===0?t.jsx(gt,{size:16}):t.jsx(yt,{size:16})}),t.jsx("span",{style:G.filterLabel,children:"All"})]}),j.map(P=>{const re=q.includes(P.toString());return t.jsxs("div",{style:{...G.filterOption,...re?G.filterOptionSelected:{}},onClick:()=>w(P.toString()),children:[t.jsx("span",{style:G.checkIcon,children:re?t.jsx(gt,{size:16}):t.jsx(yt,{size:16})}),t.jsx("span",{style:G.filterLabel,children:P})]},P)})]}),document.body)};return t.jsx("tr",{style:G.tableHeader,children:Q.map(v=>t.jsxs("th",{style:{...G.tableHeaderCell,...E===v.key?G.tableHeaderCellHover:{},position:"relative",...v.key==="name"?{width:"auto",minWidth:"0"}:{},...v.key==="tier"?{width:"40px",minWidth:"40px",maxWidth:"40px"}:{},...v.key==="type"?{width:"80px",minWidth:"80px",maxWidth:"80px"}:{},...v.key==="source"?{width:"40px",minWidth:"40px",maxWidth:"40px"}:{}},onClick:()=>a(v.key),onMouseEnter:()=>y(v.key),onMouseLeave:()=>y(null),children:[v.hasFilter?t.jsxs("div",{style:G.headerWithFilter,children:[t.jsx("span",{style:{cursor:"pointer"},onClick:j=>{j.stopPropagation(),a(v.key)},children:v.label}),t.jsxs("button",{ref:v.key==="tier"?r:v.key==="type"&&v.hasCostFilter?V:v.key==="type"?s:V,style:{...G.headerFilterIcon,...v.key==="tier"&&S?G.headerFilterIconActive:{},...v.key==="type"&&(b||F)?G.headerFilterIconActive:{},...v.key==="cost"&&F?G.headerFilterIconActive:{}},className:"header-filter-icon",onClick:j=>{j.stopPropagation(),v.key==="tier"?(p(!u),m(!1),z(!1)):v.key==="type"&&(v.hasCostFilter?(z(!_),p(!1),m(!1)):(m(!x),p(!1),z(!1)))},children:[t.jsx(yr,{size:14}),v.key==="tier"&&S||v.key==="type"&&(b||F)||v.key==="cost"&&F?t.jsx("span",{style:G.filterActiveDot}):null]})]}):v.label,v.key==="tier"&&C("tier",i,l,n,u,p,r),v.key==="type"&&!v.hasCostFilter&&C("type",d,c,h,x,m,s),v.key==="type"&&v.hasCostFilter&&D()]},v.key))})},sn=({item:e,onAdd:a,type:o,onRowClick:i,encounterItems:d=[],pcCount:l=4,playerTier:c=1,remainingBudget:u=0,costFilter:p="auto-grey",isFocused:x=!1,rowRef:m=null,onDeleteCustomAdversary:r=null,isDeleteConfirmed:s=!1})=>{const[n,h]=f.useState(!1),S=()=>{a(e)},b=()=>{if(o!=="adversary")return null;const _=Ze[e.type]||2;let z=0;const V=d.filter(F=>F.type==="adversary"&&F.item.type==="Solo"&&F.quantity>0).reduce((F,E)=>F+E.quantity,0),B=d.filter(F=>F.type==="adversary"&&["Bruiser","Horde","Leader","Solo"].includes(F.item.type)&&F.quantity>0).reduce((F,E)=>F+E.quantity,0);return e.type==="Solo"&&V===1&&(z+=2),["Bruiser","Horde","Leader","Solo"].includes(e.type)&&B===0&&(z+=1),_+z},L=(()=>{if(o==="adversary"){const _=b();Ze[e.type];const z=_>u||u<=0;if(p==="auto-hide"&&z)return null;const V=p==="auto-grey"&&z?{opacity:.5,color:"var(--text-secondary)"}:{};return e.description||e.motives?[[t.jsx("td",{style:{...G.rowCell,width:"auto",minWidth:"0",textAlign:"left",...V,borderBottom:"none",padding:"0.25rem 0.25rem 0 0.5rem",outline:"none"},children:t.jsx("div",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"100%",display:"flex",alignItems:"center",gap:"0.5rem"},children:t.jsx("div",{style:{flex:1,minWidth:0,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:t.jsx("div",{style:{fontWeight:"600"},children:e.name||e.baseName||""})})})},"name"),t.jsx("td",{style:{...G.rowCell,width:"40px",minWidth:"40px",maxWidth:"40px",textAlign:"center",...V,borderBottom:"none",padding:"0.25rem 0.25rem 0 0.25rem",outline:"none"},children:e.tier},"tier"),t.jsx("td",{style:{...G.rowCell,width:"80px",minWidth:"80px",maxWidth:"80px",textAlign:"center",...V,borderBottom:"none",padding:"0.25rem 0.25rem 0 0.25rem",outline:"none"},children:e.type},"type"),t.jsx("td",{style:{...G.rowCell,width:"40px",minWidth:"40px",maxWidth:"40px",textAlign:"center",...V,borderBottom:"none",outline:"none"},rowSpan:2,children:e.source==="Homebrew"||e.isCustom?(n||x||s)&&r?t.jsx("button",{onClick:B=>{B.stopPropagation(),r(e.id)},style:{background:s?"var(--danger)":"var(--bg-secondary)",border:"1px solid var(--border)",borderRadius:"4px",padding:"0.25rem",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:s?"var(--text-primary)":"var(--danger)",transition:"all 0.2s ease",flexShrink:0,width:"24px",height:"24px",margin:"0 auto"},title:s?"Click again to confirm delete":"Delete custom adversary",children:t.jsx(Nt,{size:14})}):t.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",width:"24px",height:"24px",margin:"0 auto"},children:t.jsx(zt,{size:14,style:{color:"var(--text-secondary)",opacity:.7},title:"Custom adversary"})}):t.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",width:"24px",height:"24px",margin:"0 auto"},children:t.jsx(Wt,{size:14,style:{color:"var(--text-secondary)",opacity:.7},title:"Stock adversary"})})},"source")],[t.jsx("td",{colSpan:3,style:{...G.rowCell,textAlign:"left",...V,padding:"0 0.25rem 0.25rem 0.5rem",borderTop:"none",borderBottom:"none",outline:"none"},children:t.jsx("div",{style:{fontSize:"0.85rem",color:"var(--text-secondary)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:e.description||e.motives||""})},"desc")]]:t.jsxs(t.Fragment,{children:[t.jsx("td",{style:{...G.rowCell,width:"auto",minWidth:"0",textAlign:"left",...V,paddingLeft:"0.5rem"},children:t.jsx("div",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"100%",display:"flex",alignItems:"center",gap:"0.5rem"},children:t.jsx("div",{style:{flex:1,minWidth:0,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:t.jsx("div",{style:{fontWeight:"600"},children:e.name||e.baseName||""})})})}),t.jsx("td",{style:{...G.rowCell,width:"40px",minWidth:"40px",maxWidth:"40px",textAlign:"center",...V},children:e.tier}),t.jsx("td",{style:{...G.rowCell,width:"80px",minWidth:"80px",maxWidth:"80px",textAlign:"center",...V},children:e.type}),t.jsx("td",{style:{...G.rowCell,width:"40px",minWidth:"40px",maxWidth:"40px",textAlign:"center",...V},children:e.source==="Homebrew"||e.isCustom?(n||x||s)&&r?t.jsx("button",{onClick:B=>{B.stopPropagation(),r(e.id)},style:{background:s?"var(--danger)":"var(--bg-secondary)",border:"1px solid var(--border)",borderRadius:"4px",padding:"0.25rem",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:s?"var(--text-primary)":"var(--danger)",transition:"all 0.2s ease",flexShrink:0,width:"24px",height:"24px",margin:"0 auto"},title:s?"Click again to confirm delete":"Delete custom adversary",children:t.jsx(Nt,{size:14})}):t.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",width:"24px",height:"24px",margin:"0 auto"},children:t.jsx(zt,{size:14,style:{color:"var(--text-secondary)",opacity:.7},title:"Custom adversary"})}):t.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",width:"24px",height:"24px",margin:"0 auto"},children:t.jsx(Wt,{size:14,style:{color:"var(--text-secondary)",opacity:.7},title:"Stock adversary"})})})]})}else if(o==="environment")return t.jsxs(t.Fragment,{children:[t.jsx("td",{style:{...G.rowCell,width:"auto",minWidth:"0",textAlign:"left"},children:e.name||e.baseName||""}),t.jsx("td",{style:{...G.rowCell,width:"80px",minWidth:"80px",maxWidth:"80px",textAlign:"center"},children:e.tier}),t.jsx("td",{style:{...G.rowCell,width:"100px",minWidth:"100px",maxWidth:"100px",textAlign:"center"},children:e.type}),t.jsx("td",{style:{...G.rowCell,width:"40px",minWidth:"40px",maxWidth:"40px",textAlign:"center"},children:e.difficulty})]});return null})();return L===null?null:Array.isArray(L)?t.jsx(t.Fragment,{children:L.map((_,z)=>t.jsx("tr",{ref:z===0?m:null,style:{...G.row,...n?G.rowHover:{},...x?G.rowFocused:{},...z===0?{borderBottom:"none"}:{},...z===1?{borderTop:"none",height:"auto",outline:"none"}:{}},onClick:()=>{o==="adversary"?S():i&&i(e,o)},onMouseEnter:()=>h(!0),onMouseLeave:()=>h(!1),children:_},z))}):t.jsx(t.Fragment,{children:t.jsx("tr",{ref:m,style:{...G.row,...n?G.rowHover:{},...x?G.rowFocused:{}},onClick:()=>{o==="adversary"?S():i&&i(e,o)},onMouseEnter:()=>h(!0),onMouseLeave:()=>h(!1),children:L})})},nr=({type:e,onAddItem:a,onCancel:o=null,onRowClick:i,encounterItems:d=[],pcCount:l=4,playerTier:c=1,partyControls:u=null,showContainer:p=!0,savedEncounters:x=[],onLoadEncounter:m,onDeleteEncounter:r,activeTab:s="adversaries",selectedCustomAdversaryId:n,onSelectCustomAdversary:h,onTabChange:S,selectedAdversary:b,onSelectAdversary:$,filterCustom:L=!1,showCustomToggle:_=!1,onToggleCustom:z,onExportCustomAdversaries:V,onImportCustomAdversaries:B,autoFocus:F=!1,hideImportExport:E=!1,onClose:y=null,searchPlaceholder:H="Search"})=>{const{addCustomAdversary:Q,updateCustomAdversary:D,deleteCustomAdversary:C,customContent:v,adversaries:j,deleteAdversary:q}=ft(),[w,T]=f.useState(null),[k,A]=f.useState("all"),[K,M]=f.useState(!1),[P,re]=f.useState({}),[O,ee]=f.useState({}),de=f.useRef({}),he=f.useRef({}),Le=f.useRef(null),[be,Me]=f.useState(-1),[De,te]=f.useState(null),ge=f.useRef({}),ue=()=>{try{const N=v.adversaries||[];if(N.length===0){alert("No custom adversaries to export.");return}const X=["name","tier","type","difficulty","threshold_major","threshold_severe","hp_max","stress_max","atk","weapon","range","damage","description","motives"],oe=N.map(le=>{var U,ye;return[le.name||"",le.tier||"",le.type||"",le.difficulty||"",((U=le.thresholds)==null?void 0:U.major)||"",((ye=le.thresholds)==null?void 0:ye.severe)||"",le.hpMax||"",le.stressMax||"",le.atk||"",le.weapon||"",le.range||"",le.damage||"",le.description||"",le.motives||""]}),Te=le=>{const U=String(le);return U.includes(",")||U.includes('"')||U.includes(`
`)?`"${U.replace(/"/g,'""')}"`:U},ve=[X.join(","),...oe.map(le=>le.map(Te).join(","))].join(`
`),we=new Blob([ve],{type:"text/csv;charset=utf-8;"}),Ee=URL.createObjectURL(we),ae=document.createElement("a");ae.href=Ee,ae.download=`daggerheart-custom-adversaries-${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(ae),ae.click(),document.body.removeChild(ae),URL.revokeObjectURL(Ee),console.log(`Exported ${N.length} custom adversaries to CSV`)}catch(N){console.error("Failed to export custom adversaries:",N),alert("Failed to export custom adversaries. Please try again.")}},Ie=N=>{const X=N.target.files[0];if(!X)return;const oe=X.name.endsWith(".csv"),Te=X.name.endsWith(".json");if(!oe&&!Te){alert("Please upload a CSV or JSON file."),N.target.value="";return}const ve=new FileReader;ve.onload=we=>{try{let Ee=[];if(oe){const ie=we.target.result.split(`
`).filter(We=>We.trim());if(ie.length<2)throw new Error("CSV file is empty or invalid.");const me=ie[0].split(",").map(We=>We.trim().replace(/^"|"$/g,""));for(let We=1;We<ie.length;We++){const fe=[];let Be="",He=!1;for(let Ne=0;Ne<ie[We].length;Ne++){const Oe=ie[We][Ne],lr=ie[We][Ne+1];Oe==='"'&&He&&lr==='"'?(Be+='"',Ne++):Oe==='"'?He=!He:Oe===","&&!He?(fe.push(Be.trim()),Be=""):Be+=Oe}fe.push(Be.trim());const ot={name:fe[me.indexOf("name")]||"",tier:parseInt(fe[me.indexOf("tier")])||1,type:fe[me.indexOf("type")]||"Standard",difficulty:parseInt(fe[me.indexOf("difficulty")])||11,thresholds:{major:parseInt(fe[me.indexOf("threshold_major")])||7,severe:parseInt(fe[me.indexOf("threshold_severe")])||12},hpMax:parseInt(fe[me.indexOf("hp_max")])||3,stressMax:parseInt(fe[me.indexOf("stress_max")])||1,atk:parseInt(fe[me.indexOf("atk")])||1,weapon:fe[me.indexOf("weapon")]||"",range:fe[me.indexOf("range")]||"Melee",damage:fe[me.indexOf("damage")]||"",description:fe[me.indexOf("description")]||"",motives:fe[me.indexOf("motives")]||"",source:"Homebrew"};ot.name&&Ee.push(ot)}}else if(Te){const Se=JSON.parse(we.target.result);if(!Se.customAdversaries||!Array.isArray(Se.customAdversaries))throw new Error("Invalid JSON format. Expected customAdversaries array.");Ee=Se.customAdversaries}const ae=v.adversaries||[],le=[...ae];let U=0,ye=0;Ee.forEach(Se=>{if(ae.some(me=>me.name===Se.name&&me.source===Se.source))ye++;else{const me={...Se,id:`custom-adv-${Date.now()}-${Math.random().toString(36).slice(2,10)}`,hp:0,stress:0};le.push(me),U++}}),U>0?(localStorage.setItem("daggerheart-custom-adversaries",JSON.stringify(le)),window.location.reload(),alert(`Import successful! Added ${U} new adversaries${ye>0?`, skipped ${ye} duplicates`:""}.`)):alert("No new adversaries were added. All imported adversaries already exist.")}catch(Ee){console.error("Failed to import custom adversaries:",Ee),alert(`Failed to import custom adversaries: ${Ee.message}`)}},ve.readAsText(X),N.target.value=""},ke=()=>{T(null)},ze=async(N,X)=>{X?D(X,N):Q(N)},Pe=N=>{P[N]?(r&&r(N),re(X=>{const oe={...X};return delete oe[N],oe}),de.current[N]&&(clearTimeout(de.current[N]),delete de.current[N])):(re(X=>({...X,[N]:!0})),de.current[N]&&clearTimeout(de.current[N]),de.current[N]=setTimeout(()=>{re(X=>{const oe={...X};return delete oe[N],oe}),delete de.current[N]},3e3))},Ue=N=>{O[N]?(j.filter(oe=>oe.customContentId===N).forEach(oe=>{q(oe.id)}),C(N),ee(oe=>{const Te={...oe};return delete Te[N],Te}),he.current[N]&&(clearTimeout(he.current[N]),delete he.current[N])):(ee(X=>({...X,[N]:!0})),he.current[N]&&clearTimeout(he.current[N]),he.current[N]=setTimeout(()=>{ee(X=>{const oe={...X};return delete oe[N],oe}),delete he.current[N]},3e3))};f.useEffect(()=>()=>{Object.values(de.current).forEach(N=>{clearTimeout(N)}),Object.values(he.current).forEach(N=>{clearTimeout(N)})},[]);const{searchTerm:$e,setSearchTerm:et,sortFields:g,handleSort:R,filteredAndSortedData:W,loading:Y,selectedTiers:I,selectedTypes:ne,showTierDropdown:pe,setShowTierDropdown:Z,showTypeDropdown:J,setShowTypeDropdown:se,tierFilterRef:Ce,typeFilterRef:Ae,uniqueTiers:Re,uniqueTypes:st,handleTierSelect:Ve,handleTypeSelect:ht,isTierFiltered:xt,isTypeFiltered:Et,getDropdownStyle:sr}=en(e,d,l,c,L,v),At=f.useRef($e),It=f.useRef(JSON.stringify(I)),Tt=f.useRef(JSON.stringify(ne));f.useEffect(()=>{const N=At.current!==$e,X=It.current!==JSON.stringify(I),oe=Tt.current!==JSON.stringify(ne);(N||X||oe)&&(Me(-1),te(null),At.current=$e,It.current=JSON.stringify(I),Tt.current=JSON.stringify(ne))},[$e,I,ne]),f.useEffect(()=>{if(s!=="adversaries")return;const N=X=>{const oe=document.activeElement;if(oe&&["INPUT","TEXTAREA","SELECT"].includes(oe.tagName))if(X.key==="ArrowDown"||X.key==="ArrowUp"||X.key==="Enter")(X.key!=="Enter"||oe.tagName!=="INPUT")&&oe.blur();else return;const Te=W.length-1;if(X.key==="ArrowDown")X.preventDefault(),Me(ve=>{var Ee;const we=ve<Te?ve+1:ve;return we>=0&&we<W.length&&(te(((Ee=W[we])==null?void 0:Ee.id)||null),ge.current[we]&&setTimeout(()=>{const ae=ge.current[we];if(ae){const le=ae.closest(".browser-content");if(le){const U=le.getBoundingClientRect(),ye=ae.getBoundingClientRect(),Se=ae.nextElementSibling,ie=Se&&Se.tagName==="TR"&&Se.querySelector("td[colspan]");let me=ye.height;ie&&(me+=Se.getBoundingClientRect().height);const We=ye.bottom-U.top,fe=U.height,Be=We>=fe-1,He=ye.bottom>U.bottom;if(Be||He){let Ne=ae.offsetTop+me-fe;const Oe=le.scrollHeight-fe;Ne=Math.min(Ne,Oe),Ne=Math.max(0,Ne),le.scrollTo({top:Ne,behavior:"smooth"})}}else ae.scrollIntoView({behavior:"smooth",block:"end"})}},0)),we});else if(X.key==="ArrowUp")X.preventDefault(),Me(ve=>{var Ee;if(ve<=0)return te(null),setTimeout(()=>{const ae=document.querySelector('.browser-header input[type="text"]');ae==null||ae.focus()},0),-1;const we=ve-1;return we>=0&&we<W.length?(te(((Ee=W[we])==null?void 0:Ee.id)||null),ge.current[we]&&setTimeout(()=>{const ae=ge.current[we];if(ae){const le=ae.closest(".browser-content");if(le){const U=le.getBoundingClientRect(),ye=ae.getBoundingClientRect(),Se=(()=>{const fe=ae.closest("table"),Be=fe==null?void 0:fe.querySelector("thead");return Be?Be.getBoundingClientRect().height:0})(),ie=ye.top-U.top,me=Math.abs(ie-Se)<=1;if(ye.top<U.top||me){const fe=ae.nextElementSibling,Be=fe&&fe.tagName==="TR"&&fe.querySelector("td[colspan]");let He=ye.height;Be&&(He+=fe.getBoundingClientRect().height);let Ne=ae.offsetTop-Se;const Oe=le.scrollHeight-le.clientHeight;Ne=Math.min(Ne,Oe),Ne=Math.max(0,Ne),le.scrollTo({top:Ne,behavior:"smooth"})}}else ae.scrollIntoView({behavior:"smooth",block:"start"})}},0)):te(null),we});else if(X.key==="Enter"&&be>=0&&be<=Te){X.preventDefault();const ve=W[be];ve&&a&&a(ve)}};return document.addEventListener("keydown",N),()=>{document.removeEventListener("keydown",N)}},[s,W,be,a]);const or=(()=>{const N=3*l+2,X=d.reduce((U,ye)=>{if(ye.type==="adversary"){const Se=Ze[ye.item.type]||2;if(ye.item.type==="Minion"){const ie=Math.ceil(ye.quantity/l);return U+ie*Se}else return U+ye.quantity*Se}return U},0);let oe=0;d.filter(U=>U.type==="adversary"&&U.item.type==="Solo"&&U.quantity>0).reduce((U,ye)=>U+ye.quantity,0)>=2&&(oe+=Ge.twoOrMoreSolos);const ve=d.some(U=>U.type==="adversary"&&U.item.type==="Bruiser"&&U.quantity>0),we=d.some(U=>U.type==="adversary"&&U.item.type==="Horde"&&U.quantity>0),Ee=d.some(U=>U.type==="adversary"&&U.item.type==="Leader"&&U.quantity>0),ae=d.some(U=>U.type==="adversary"&&U.item.type==="Solo"&&U.quantity>0);return!ve&&!we&&!Ee&&!ae&&(oe+=Ge.noBruisersHordesLeadersSolos),N+oe-X})(),ar=N=>{A(N),M(!1)},ir=k!=="all";return Y?t.jsx("div",{style:G.browser,children:t.jsx("div",{style:G.loading,children:"Loading..."})}):t.jsx(t.Fragment,{children:t.jsxs("div",{style:p?G.browserWrapper:G.browserWrapperNoContainer,children:[s==="adversaries"&&t.jsxs(t.Fragment,{children:[t.jsx(tn,{searchTerm:$e,onSearchChange:et,type:e,partyControls:u,autoFocus:F,onClose:y,placeholder:H}),!E&&t.jsx(rn,{showCustomToggle:_,onToggleCustom:z,filterCustom:L,onExportCustomAdversaries:ue,onImportCustomAdversaries:Ie}),t.jsx("div",{className:"browser-content invisible-scrollbar",style:G.browserContent,children:t.jsxs("table",{style:G.browserTable,children:[t.jsx("thead",{style:{position:"sticky",top:0,zIndex:10,backgroundColor:"var(--bg-primary)"},children:t.jsx(nn,{sortFields:g,onSort:R,type:e,uniqueTiers:Re,uniqueTypes:st,selectedTiers:I,selectedTypes:ne,showTierDropdown:pe,setShowTierDropdown:Z,showTypeDropdown:J,setShowTypeDropdown:se,tierFilterRef:Ce,typeFilterRef:Ae,handleTierSelect:Ve,handleTypeSelect:ht,isTierFiltered:xt,isTypeFiltered:Et,getDropdownStyle:sr,costFilter:k,showCostDropdown:K,setShowCostDropdown:M,costFilterRef:Le,handleCostFilterSelect:ar,isCostFiltered:ir})}),t.jsx("tbody",{children:W.map((N,X)=>t.jsx(sn,{item:N,onAdd:a,type:e,onRowClick:i,encounterItems:d,pcCount:l,playerTier:c,remainingBudget:or,costFilter:k,isFocused:De===N.id||be===X,onDeleteCustomAdversary:e==="adversary"?Ue:null,isDeleteConfirmed:O[N.id]||!1,rowRef:oe=>{oe?ge.current[X]=oe:delete ge.current[X]}},N.id))})]})})]}),s==="encounters"&&t.jsx("div",{style:{flex:1,overflowY:"auto",padding:"1rem"},children:x.length===0?t.jsx("div",{style:{color:"var(--text-secondary)",fontSize:"0.9rem",textAlign:"center",padding:"2rem 1rem"},children:"No saved encounters yet"}):t.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"0.5rem"},children:x.map(N=>t.jsxs("div",{onClick:()=>m&&m(N.id),className:"saved-encounter-card",style:{border:"1px solid var(--border)",borderRadius:"8px",padding:"8px",backgroundColor:"var(--bg-card)",transition:"background-color 0.2s ease",display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},children:[t.jsxs("div",{style:{minWidth:"100px",borderRight:"1px solid var(--text-secondary)",paddingRight:"1rem",display:"flex",flexDirection:"column",justifyContent:"center",minHeight:"60px"},children:[t.jsxs("div",{style:{fontSize:"0.8rem",color:"var(--text-primary)",marginBottom:"0.25rem"},children:["Tier: ",(()=>{var Te,ve,we,Ee;const X=((Ee=(we=(ve=(Te=N.encounterItems)==null?void 0:Te.filter(ae=>ae.type==="adversary"))==null?void 0:ve.map(ae=>ae.item.tier))==null?void 0:we.filter(ae=>ae!=null))==null?void 0:Ee.sort((ae,le)=>ae-le))||[];if(X.length===0)return"N/A";if(X.length===1)return X[0];const oe=[...new Set(X)];return oe.length===1?oe[0]:`${Math.min(...oe)}-${Math.max(...oe)}`})()]}),t.jsxs("div",{style:{fontSize:"0.8rem",color:"var(--text-primary)",marginBottom:"0.25rem"},children:["Party Size: ",N.partySize||4]}),t.jsxs("div",{style:{fontSize:"0.8rem",color:"var(--text-primary)"},children:["Balance: ",(()=>{const X=N.partySize||4,oe=3*X+2;let Te=0;const ve=N.encounterItems||[];ve.filter(ie=>ie.type==="adversary"&&ie.item.type==="Solo"&&ie.quantity>0).reduce((ie,me)=>ie+me.quantity,0)>=2&&(Te+=Ge.twoOrMoreSolos);const Ee=ve.some(ie=>ie.type==="adversary"&&ie.item.type==="Bruiser"&&ie.quantity>0),ae=ve.some(ie=>ie.type==="adversary"&&ie.item.type==="Horde"&&ie.quantity>0),le=ve.some(ie=>ie.type==="adversary"&&ie.item.type==="Leader"&&ie.quantity>0),U=ve.some(ie=>ie.type==="adversary"&&ie.item.type==="Solo"&&ie.quantity>0);!Ee&&!ae&&!le&&!U&&(Te+=Ge.noBruisersHordesLeadersSolos);const ye=oe+Te,Se=ve.reduce((ie,me)=>{if(me.type==="adversary"){const We=Ze[me.item.type]||2;if(me.item.type==="Minion"){const fe=Math.ceil(me.quantity/X);return ie+fe*We}else return ie+me.quantity*We}return ie},0);return Se>ye?`+${Se-ye}`:Se===ye?"0":`-${ye-Se}`})()]})]}),t.jsx("div",{style:{minWidth:"120px",borderRight:"1px solid var(--text-secondary)",paddingRight:"1rem",display:"flex",alignItems:"center",minHeight:"60px"},children:t.jsx("div",{style:{fontWeight:"500",color:"var(--text-primary)",fontSize:"0.9rem",wordWrap:"break-word",wordBreak:"break-word",width:"150px",maxWidth:"150px"},children:N.name})}),t.jsx(Zr,{encounter:N}),t.jsx("button",{onClick:X=>{X.stopPropagation(),Pe(N.id)},style:{background:P[N.id]?"var(--danger)":"var(--gray-600)",border:"none",color:"white",padding:"0.4rem 0.8rem",borderRadius:"4px",fontSize:"0.75rem",cursor:"pointer",minWidth:"60px",transition:"background-color 0.2s"},children:"Delete"})]},N.id))})}),s==="create"&&t.jsx("div",{style:{flex:1,overflowY:"auto",overflowX:"hidden",padding:"1rem",display:"flex",justifyContent:"center",alignItems:"flex-start",height:"100%",minHeight:0},children:t.jsx("div",{style:{maxWidth:"600px",width:"100%",height:"auto",display:"flex",flexDirection:"column",padding:"0",overflowY:"visible",overflowX:"hidden",minHeight:0},children:t.jsx(kt,{onSave:ze,onRefresh:()=>{},onAddItem:a,editingAdversary:w,onCancelEdit:ke,embedded:!1})})}),s==="info"&&t.jsxs("div",{style:{flex:1,overflowY:"auto",padding:"2rem"},children:[t.jsxs("div",{style:{marginBottom:"2rem",textAlign:"center"},children:[t.jsx("img",{src:Jr,alt:"Daggerheart Community Content Logo",style:{width:"100%",maxWidth:"300px",height:"auto",margin:"0 auto 1.5rem auto",display:"block"},onError:N=>{console.error("Failed to load Daggerheart logo:",N.target.src),N.target.style.display="none"}}),t.jsxs("div",{style:{fontSize:"0.875rem",lineHeight:1.6,color:"var(--text-secondary)",textAlign:"left",maxWidth:"600px",margin:"0 auto"},children:[t.jsx("p",{style:{marginTop:0},children:"This product includes materials from the Daggerheart System Reference Document 1.0, © Critical Role, LLC, under the terms of the Darrington Press Community Gaming (DPCGL) License."}),t.jsxs("p",{children:["More information can be found at ",t.jsx("a",{href:"https://www.daggerheart.com",target:"_blank",rel:"noopener noreferrer",style:{color:"var(--purple)",textDecoration:"underline"},children:"daggerheart.com"})]}),t.jsx("p",{style:{marginBottom:0},children:t.jsx("em",{children:"This project is unofficial and not endorsed by Darrington Press or Critical Role."})})]})]}),t.jsxs("div",{style:{maxWidth:"600px",margin:"0 auto",border:"1px solid var(--border)",borderRadius:"8px",overflow:"hidden"},children:[t.jsxs("button",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"1rem 1.5rem",color:"var(--text-primary)",border:"none",background:"var(--bg-secondary)",width:"100%",textAlign:"left",cursor:"pointer",transition:"background-color 0.2s ease",fontSize:"0.875rem",borderBottom:"1px solid var(--border)"},onMouseEnter:N=>{N.target.style.backgroundColor="var(--bg-hover)"},onMouseLeave:N=>{N.target.style.backgroundColor="var(--bg-secondary)"},onClick:N=>{N.stopPropagation(),window.open("https://github.com/Splinter714/Daggerheart","_blank")},children:[t.jsx("span",{children:"View on GitHub"}),t.jsx("span",{children:"→"})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",padding:"1rem 1.5rem",color:"var(--text-secondary)",background:"var(--bg-secondary)",fontSize:"0.875rem"},children:["Version ","0.4.19 (7b25af0)"]})]})]})]})})},G={browserWrapper:{display:"flex",flexDirection:"column",background:"var(--bg-primary)",borderRadius:"var(--radius-md)",border:"1px solid var(--border)",overflow:"hidden",height:"100%",width:"100%",position:"relative"},browserWrapperNoContainer:{display:"flex",flexDirection:"column",overflow:"hidden",height:"100%",width:"100%",position:"relative"},browserContent:{flex:1,overflowY:"auto",overflowX:"visible",padding:0,width:"100%",scrollbarWidth:"none",msOverflowStyle:"none",borderRadius:"0 0 8px 8px"},tableHeaderContainer:{flexShrink:0,position:"sticky",top:0,zIndex:15,backgroundColor:"var(--bg-secondary)"},browserTable:{width:"100%",minWidth:"100%",borderCollapse:"collapse",tableLayout:"fixed",background:"var(--bg-primary)",margin:0},browserHeader:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"16px",borderBottom:"1px solid var(--border)",backgroundColor:"var(--gray-900)",flexShrink:0,position:"sticky",top:0,zIndex:20},browserTitle:{margin:0,color:"var(--text-primary)",fontSize:"18px",fontWeight:"600"},closeButton:{background:"none",border:"none",color:"var(--text-primary)",fontSize:"24px",cursor:"pointer",padding:"4px 8px",borderRadius:"4px",transition:"background-color 0.2s"},searchInput:{flex:1,padding:"8px 12px",border:"1px solid var(--border)",borderRadius:"4px",backgroundColor:"var(--bg-primary)",color:"var(--text-primary)",fontSize:"16px",marginRight:"12px",transition:"all 0.2s ease"},partyControls:{display:"flex",alignItems:"center",gap:"12px",flexShrink:0},searchInputFocus:{outline:"none",borderColor:"var(--purple)",boxShadow:"0 0 0 3px rgba(139, 92, 246, 0.1)"},tableHeader:{background:"var(--gray-900)",borderBottom:"1px solid var(--border)",boxShadow:"0 1px 0 var(--border)",position:"sticky",top:"0",zIndex:10},tableHeaderCell:{backgroundColor:"var(--gray-900)",fontWeight:"700",borderBottom:"1px solid var(--border)",cursor:"pointer",userSelect:"none",minWidth:"100px",whiteSpace:"nowrap",padding:"4px 4px",color:"var(--text-primary)",textShadow:"0 1px 2px rgba(0, 0, 0, 0.3)",boxShadow:"0 1px 0 var(--border)",transition:"background-color 0.2s",position:"sticky",top:"0",zIndex:10},tableHeaderCellHover:{backgroundColor:"var(--bg-hover)"},sortIndicator:{fontSize:"12px",color:"var(--text-secondary)"},tableBody:{flex:1,overflowY:"auto",padding:"8px",backgroundColor:"var(--bg-primary)"},row:{height:"auto",minHeight:"35px",borderBottom:"1px solid var(--border)",transition:"background-color 0.2s ease",cursor:"pointer",backgroundColor:"var(--gray-900)"},rowHover:{backgroundColor:"var(--bg-secondary)"},rowFocused:{backgroundColor:"var(--bg-secondary)",boxShadow:"inset 0 0 0 2px var(--purple)"},expandedRow:{backgroundColor:"var(--bg-secondary)"},rowCell:{padding:"4px 4px",verticalAlign:"middle",color:"var(--text-primary)",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",borderBottom:"1px solid var(--border)"},rowCellName:{fontWeight:"500",minWidth:"150px"},rowCellCenter:{textAlign:"center",justifyContent:"center",minWidth:"80px"},rowActions:{width:"80px",textAlign:"center",padding:"4px 8px",borderBottom:"1px solid var(--border)"},addButton:{width:"2rem",height:"2rem",border:"1px solid var(--purple)",borderRadius:"var(--radius-sm)",background:"var(--purple)",color:"white",cursor:"pointer",transition:"all 0.2s ease",display:"inline-flex",alignItems:"center",justifyContent:"center",fontSize:"16px",fontWeight:"500"},expandedContent:{padding:"0",backgroundColor:"var(--bg-secondary)",borderBottom:"1px solid var(--border)"},columnName:{width:"auto",minWidth:"0",overflow:"hidden",textOverflow:"ellipsis",paddingLeft:"8px",textAlign:"left"},columnTier:{width:"80px",textAlign:"center",overflow:"visible",textOverflow:"unset"},columnType:{width:"100px",overflow:"hidden",textOverflow:"ellipsis",textAlign:"center"},columnDifficulty:{width:"40px",textAlign:"center",overflow:"visible",textOverflow:"unset"},columnAction:{width:"32px",minWidth:"24px",maxWidth:"24px",textAlign:"center",padding:"0",margin:"0",border:"none",verticalAlign:"middle",color:"var(--text-primary)",whiteSpace:"nowrap",overflow:"visible",textOverflow:"unset"},loading:{display:"flex",justifyContent:"center",alignItems:"center",height:"200px",color:"var(--text-primary)",fontSize:"16px"},mobileBrowser:{width:"95vw",height:"90vh",maxWidth:"none"},mobileSearchInput:{fontSize:"16px"},headerWithFilter:{display:"flex",alignItems:"center",justifyContent:"center",gap:"0px",position:"relative"},headerFilterIcon:{background:"none",border:"none",color:"var(--text-secondary)",cursor:"pointer",padding:"2px 4px",borderRadius:"var(--radius-sm)",display:"flex",alignItems:"center",justifyContent:"center",transition:"all 0.2s ease",position:"relative",marginLeft:"-2px"},headerFilterIconActive:{color:"var(--purple)"},filterIcon:{fontSize:"12px"},filterActiveDot:{position:"absolute",left:"50%",top:"2px",transform:"translateX(-50%)",width:"4px",height:"4px",borderRadius:"50%",background:"var(--purple)",pointerEvents:"none"},filterDropdown:{position:"fixed",background:"var(--bg-secondary)",border:"1px solid var(--border)",borderRadius:"var(--radius-md)",boxShadow:"0 8px 24px rgba(0, 0, 0, 0.25)",zIndex:99999,marginTop:"4px",overflow:"hidden",width:"max-content",minWidth:"120px",maxWidth:"200px"},filterOption:{padding:"8px 12px",cursor:"pointer",color:"var(--text-primary)",fontSize:"14px",display:"flex",alignItems:"center",gap:"8px",borderBottom:"1px solid rgba(255,255,255,0.06)",transition:"background-color 0.2s ease",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},filterOptionSelected:{backgroundColor:"var(--bg-hover)"},checkIcon:{width:"16px",height:"16px",display:"inline-flex",alignItems:"center",justifyContent:"center",color:"var(--text-secondary)",fontSize:"12px"},filterLabel:{flex:1}},on=({isOpen:e,onClose:a,onAddAdversary:o,onAddAdversariesBulk:i,onAddEnvironment:d,onDeleteAdversary:l,onDeleteEnvironment:c,onDeleteCountdown:u,adversaries:p=[],environments:x=[],countdowns:m=[],savedEncounters:r=[],onSaveEncounter:s,onLoadEncounter:n,onDeleteEncounter:h})=>{const{partySize:S,updatePartySize:b,currentEncounterName:$,updateCurrentEncounterName:L,customContent:_}=ft(),z=S,V=b,[B,F]=f.useState({lessDifficult:!1,increasedDamage:!1,moreDangerous:!1}),[E,y]=f.useState([]),[H,Q]=f.useState($||"Encounter"),[D,C]=f.useState("adversaries"),[v,j]=f.useState(null),[q,w]=f.useState(null),[T,k]=f.useState(null),[A,K]=f.useState(null),[M,P]=f.useState(!1);f.useEffect(()=>{e&&!v&&Q($||"Encounter")},[e,v,$]);const re=()=>q?H!==q.name||JSON.stringify(E)!==JSON.stringify(q.encounterItems)||z!==q.partySize||JSON.stringify(B)!==JSON.stringify(q.battlePointsAdjustments):!1,O=()=>{var g;if(E.length>0||(H||"").trim()!=="Encounter")return!0;if(v&&re()){if(q){const R=E.length,W=((g=q.encounterItems)==null?void 0:g.length)||0;if(R!==W||(H||"").trim()!==(q.name||""))return!0;const Y=JSON.stringify(B),I=JSON.stringify(q.battlePointsAdjustments||{});return Y!==I}return!0}return!1},ee=({onClick:g,children:R,variant:W="secondary",isConfirmation:Y=!1})=>{const I=W==="danger"||W==="secondary"&&Y,ne=W==="purple";return t.jsx("button",{onClick:g,style:{background:I?"var(--danger)":ne?"var(--purple)":"var(--bg-secondary)",border:ne?"none":"1px solid var(--border)",color:I||ne?"white":"var(--text-primary)",padding:"0.375rem 0.75rem",borderRadius:"4px",cursor:"pointer",transition:"background-color 0.2s",width:"70px",fontSize:"0.875rem"},children:R})},de=Ke.useRef(z),he=f.useCallback(g=>!g||g.length===0?null:r.find(W=>{var pe,Z;if(((pe=W.encounterItems)==null?void 0:pe.length)!==g.length)return!1;const Y=J=>{var se;return{type:J.type,quantity:J.quantity,item:{name:J.item.baseName||((se=J.item.name)==null?void 0:se.replace(/\s+\(\d+\)$/,""))||J.item.name,type:J.item.type,tier:J.item.tier}}},I=(Z=W.encounterItems)==null?void 0:Z.map(Y).sort((J,se)=>J.item.name.localeCompare(se.item.name)||J.item.type.localeCompare(se.item.type)),ne=g.map(Y).sort((J,se)=>J.item.name.localeCompare(se.item.name)||J.item.type.localeCompare(se.item.type));return JSON.stringify(I)===JSON.stringify(ne)})||null,[r]);Ke.useEffect(()=>{if(e&&p.length>0&&E.length===0){const g={};p.forEach(Y=>{var ne;const I=Y.baseName||((ne=Y.name)==null?void 0:ne.replace(/\s+\(\d+\)$/,""))||Y.name;g[I]||(g[I]={type:"adversary",item:Y,quantity:0}),g[I].quantity+=1});const R=Object.values(g);y(R);const W=he(R);W&&!v&&(j(W.id),w({name:W.name||"",encounterItems:W.encounterItems||[],partySize:W.partySize||4,battlePointsAdjustments:W.battlePointsAdjustments||{lessDifficult:!1,increasedDamage:!1,moreDangerous:!1}}),Q(W.name||"Encounter"),L(W.name||"Encounter"))}else e&&p.length===0&&E.length===0&&y([])},[e,he,v,L]);const Le=Ke.useMemo(()=>tr(E),[E]),be=Yr(z,B)+Le,Me=er(E,z);Ke.useEffect(()=>{const g=de.current;g!==z&&(y(R=>R.map(W=>{if(W.type==="adversary"&&W.item.type==="Minion"){const I=Math.ceil(W.quantity/g)*z;return{...W,quantity:I}}return W})),de.current=z)},[z]);const De=(g,R)=>{const W=E.findIndex(ne=>ne.item.id===g.id&&ne.type===R),Y=g.type==="Minion"?z:1;let I;W>=0?I=E.map((ne,pe)=>pe===W?{...ne,quantity:ne.quantity+Y}:ne):I=[...E,{item:g,type:R,quantity:Y}],y(I),te(I)},te=g=>{const R=p||[],W=[];g.forEach(Z=>{for(let J=0;J<Z.quantity;J++)Z.type==="adversary"&&W.push(Z.item)});const Y={};R.forEach(Z=>{var se;const J=Z.baseName||((se=Z.name)==null?void 0:se.replace(/\s+\(\d+\)$/,""))||Z.name;Y[J]||(Y[J]=[]),Y[J].push(Z)});const I={};W.forEach(Z=>{var se;const J=Z.baseName||((se=Z.name)==null?void 0:se.replace(/\s+\(\d+\)$/,""))||Z.name;I[J]||(I[J]=[]),I[J].push(Z)});const ne=[],pe=[];Object.keys(I).forEach(Z=>{var Ce;const J=((Ce=Y[Z])==null?void 0:Ce.length)||0,se=I[Z].length;if(se>J){const Ae=se-J;for(let Re=0;Re<Ae;Re++)ne.push(I[Z][0])}else if(se<J){const Ae=J-se,st=[...Y[Z]].sort((Ve,ht)=>{const xt=Ve.duplicateNumber||1;return(ht.duplicateNumber||1)-xt});for(let Ve=0;Ve<Ae;Ve++)pe.push(st[Ve].id)}}),Object.keys(Y).forEach(Z=>{I[Z]||[...Y[Z]].sort((Ce,Ae)=>{const Re=Ce.duplicateNumber||1;return(Ae.duplicateNumber||1)-Re}).forEach(Ce=>{pe.push(Ce.id)})}),pe.forEach(Z=>{l(Z)}),ne.length>0&&i(ne)},ge=(g,R)=>{const W=(()=>{const Y=E.findIndex(I=>I.item.id===g&&I.type===R);if(Y>=0){const I=E[Y];if(I.quantity===0)return E.filter((Z,J)=>J!==Y);const ne=I.item.type==="Minion"?z:1,pe=Math.max(0,I.quantity-ne);return E.map((Z,J)=>J===Y?{...Z,quantity:pe}:Z)}return E})();y(W),te(W)},ue=f.useCallback(()=>{if(E.length===0)return null;const g=(H||"").trim()||"Encounter",R=r.find(W=>{var ne,pe;if(W.name!==g||((ne=W.encounterItems)==null?void 0:ne.length)!==E.length)return!1;const Y=JSON.stringify((pe=W.encounterItems)==null?void 0:pe.sort()),I=JSON.stringify([...E].sort());return Y===I});return(R==null?void 0:R.id)||null},[r,H,E]),Ie=f.useCallback(()=>{let g=(H||"").trim(),R=v;if(R||(R=ue()),E.length===0&&(!g||g==="Encounter")&&R){h(R),j(null),w(null);return}const W={name:g,encounterItems:E,partySize:z,battlePointsAdjustments:B};if(R){W.id=R;const Y=s(W);j(Y)}else{const Y=s(W);j(Y)}w({name:g,encounterItems:E,partySize:z,battlePointsAdjustments:B})},[E,H,z,B,v,s,ue,h]);f.useEffect(()=>{if(v&&re()){const g=setTimeout(()=>{Ie()},2e3);return()=>clearTimeout(g)}else if(!v&&E.length>0&&H&&H.trim()!==""){const g=setTimeout(()=>{Ie()},2e3);return()=>clearTimeout(g)}},[E,v,H,B,z]);const ke=()=>{O()&&(y([]),Q("Encounter"),L("Encounter"),j(null),w(null),p.forEach(g=>{l(g.id)}),x.forEach(g=>{c(g.id)}),m.forEach(g=>{u(g.id)}))},ze=g=>{const R=n(g);if(R){const W=R.encounterItems||[];y(W),V(R.partySize||4),F(R.battlePointsAdjustments||{lessDifficult:!1,increasedDamage:!1,moreDangerous:!1}),Q(R.name||""),L(R.name||""),j(g),w({name:R.name||"",encounterItems:R.encounterItems||[],partySize:R.partySize||4,battlePointsAdjustments:R.battlePointsAdjustments||{lessDifficult:!1,increasedDamage:!1,moreDangerous:!1}}),te(W)}},Pe=g=>{h(g),v===g&&(y([]),Q("Encounter"),L("Encounter"),j(null),w(null),p.forEach(R=>{l(R.id)}),x.forEach(R=>{c(R.id)}),m.forEach(R=>{u(R.id)}))},Ue=()=>{try{const g={version:"1.0",exportDate:new Date().toISOString(),customAdversaries:_.adversaries||[]},R=JSON.stringify(g,null,2),W=new Blob([R],{type:"application/json"}),Y=URL.createObjectURL(W),I=document.createElement("a");I.href=Y,I.download=`daggerheart-custom-adversaries-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(I),I.click(),document.body.removeChild(I),URL.revokeObjectURL(Y),console.log("Custom adversaries exported successfully")}catch(g){console.error("Failed to export custom adversaries:",g),alert("Failed to export custom adversaries. Please try again.")}},$e=g=>{const R=g.target.files[0];if(!R)return;const W=new FileReader;W.onload=Y=>{try{const I=JSON.parse(Y.target.result);if(!I.customAdversaries||!Array.isArray(I.customAdversaries))throw new Error("Invalid file format. Expected customAdversaries array.");const ne=_.adversaries||[],pe=I.customAdversaries,Z=[...ne];let J=0;pe.forEach(se=>{ne.some(Ae=>Ae.name===se.name&&Ae.type===se.type)||(Z.push({...se,id:`custom-${Date.now()}-${Math.random().toString(36).slice(2,10)}`}),J++)}),updateCustomContent("adversary",null,Z),J>0?alert(`Successfully imported ${J} custom adversaries.`):alert("No new adversaries were added. All imported adversaries already exist.")}catch(I){console.error("Failed to import custom adversaries:",I),alert("Failed to import custom adversaries. Please check the file format and try again.")}},W.readAsText(R),g.target.value=""};if(!e)return null;const et=window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0||document.referrer.includes("android-app://");return t.jsx("div",{onClick:a,className:"encounter-builder-modal",style:{position:"fixed",top:0,left:0,right:0,bottom:et?"calc(60px + env(safe-area-inset-bottom) + 1rem)":"calc(60px + env(safe-area-inset-bottom))",backgroundColor:"rgba(0, 0, 0, 0.5)",backdropFilter:"blur(8px)",zIndex:1e3,display:"flex",alignItems:"flex-start",justifyContent:"center",padding:"12px"},children:t.jsxs("div",{onClick:g=>g.stopPropagation(),style:{backgroundColor:"var(--bg-primary)",border:"2px solid var(--border)",borderRadius:"12px",width:"100%",maxWidth:"1200px",height:"100%",maxHeight:"100%",display:"flex",flexDirection:"column",overflow:"hidden",boxShadow:"0 20px 40px rgba(0, 0, 0, 0.3)"},children:[t.jsxs("div",{className:"encounter-top-bar",style:{flex:"0 0 auto",display:"flex",alignItems:"center",height:"39px",backgroundColor:"var(--bg-primary)",borderBottom:"1px solid var(--border)"},children:[t.jsx("button",{onClick:()=>C("adversaries"),style:{flex:1,background:D==="adversaries"?"var(--gray-900)":"transparent",border:"none",color:"var(--text-primary)",padding:"0.75rem 1rem",cursor:"pointer",fontSize:"0.875rem",fontWeight:D==="adversaries"?"500":"400",transition:"all 0.2s ease",position:"relative",borderRight:"1px solid var(--border)"},children:"Builder"}),t.jsx("button",{onClick:()=>C("encounters"),style:{flex:1,background:D==="encounters"?"var(--gray-900)":"transparent",border:"none",color:"var(--text-primary)",padding:"0.75rem 1rem",cursor:"pointer",fontSize:"0.875rem",fontWeight:D==="encounters"?"500":"400",transition:"all 0.2s ease",position:"relative",borderRight:"1px solid var(--border)"},children:"Saved Encounters"}),t.jsx("button",{onClick:()=>C("create"),style:{flex:1,background:D==="create"?"var(--gray-900)":"transparent",border:"none",color:"var(--text-primary)",padding:"0.75rem 1rem",cursor:"pointer",fontSize:"0.875rem",fontWeight:D==="create"?"500":"400",transition:"all 0.2s ease",position:"relative",borderRight:"1px solid var(--border)"},children:"Create Adversary"}),t.jsx("button",{onClick:()=>C("info"),style:{flex:1,background:D==="info"?"var(--gray-900)":"transparent",border:"none",color:"var(--text-primary)",padding:"0.75rem 1rem",cursor:"pointer",fontSize:"0.875rem",fontWeight:D==="info"?"500":"400",transition:"all 0.2s ease",position:"relative"},children:"Info"})]}),t.jsxs("div",{className:"encounter-builder-content",style:{flex:1,display:"flex",overflow:"hidden"},children:[t.jsx("div",{style:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden",borderTop:"1px solid var(--border)"},children:t.jsx(nr,{type:"adversary",onAddItem:g=>De(g,"adversary"),encounterItems:E,pcCount:z,showContainer:!1,savedEncounters:r,onLoadEncounter:ze,onDeleteEncounter:Pe,activeTab:D,selectedCustomAdversaryId:T,onSelectCustomAdversary:k,onTabChange:C,selectedAdversary:A,onSelectAdversary:K,filterCustom:M,showCustomToggle:!0,onToggleCustom:P,onExportCustomAdversaries:Ue,onImportCustomAdversaries:$e})}),D!=="info"&&t.jsxs("div",{className:"encounter-right-panel",style:{flex:1,borderLeft:"1px solid var(--border)",display:"flex",flexDirection:"column",overflow:"hidden",position:"relative"},children:[A&&t.jsxs("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"var(--bg-primary)",zIndex:10,display:"flex",flexDirection:"column"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"0.75rem",borderBottom:"1px solid var(--border)",backgroundColor:"var(--bg-primary)",flexShrink:0},children:[t.jsx("h3",{style:{fontSize:"1rem",fontWeight:600,color:"var(--text-primary)",margin:0},children:"Adversary Preview"}),t.jsx("button",{onClick:()=>K(null),style:{background:"none",border:"none",color:"var(--text-secondary)",cursor:"pointer",padding:"0.25rem",borderRadius:"4px",display:"flex",alignItems:"center",justifyContent:"center",transition:"color 0.2s ease"},onMouseEnter:g=>g.target.style.color="var(--text-primary)",onMouseLeave:g=>g.target.style.color="var(--text-secondary)",title:"Close preview",children:t.jsx(nt,{size:16})})]}),t.jsx("div",{style:{flex:1,overflowY:"auto",padding:"0.75rem"},children:t.jsx(pt,{item:{...A,hp:0,stress:0,isVisible:!0},type:"adversary",mode:"expanded",instances:[{...A,hp:0,stress:0,isVisible:!0}],onUpdate:()=>{},onDelete:()=>{}})})]}),(D==="adversaries"||D==="encounters")&&t.jsx("div",{style:{padding:"0.75rem",backgroundColor:"var(--bg-primary)",flexShrink:0},children:t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",width:"100%"},children:[t.jsx("input",{type:"text",value:H,onChange:g=>{Q(g.target.value),L(g.target.value)},placeholder:"Encounter Name",style:{flex:1,padding:"8px 12px",border:"1px solid var(--border)",borderRadius:"4px",backgroundColor:"var(--bg-primary)",color:"var(--text-primary)",fontSize:"16px",textAlign:"left",outline:"none",transition:"all 0.2s ease"}}),t.jsx(ee,{onClick:ke,variant:"secondary",style:{whiteSpace:"nowrap",minWidth:"fit-content",flexShrink:0,opacity:O()?1:.5,cursor:O()?"pointer":"not-allowed"},children:"New"})]})}),(D==="adversaries"||D==="encounters")&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"encounter-receipt-buttons-vertical",style:{display:"none",padding:"0.75rem",borderBottom:"1px solid var(--border)",backgroundColor:"var(--bg-primary)"},children:t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",width:"100%"},children:[t.jsx("input",{type:"text",value:H,onChange:g=>{Q(g.target.value),L(g.target.value)},placeholder:"Encounter Name",style:{flex:1,padding:"8px 12px",border:"1px solid var(--border)",borderRadius:"4px",backgroundColor:"var(--bg-primary)",color:"var(--text-primary)",fontSize:"16px",textAlign:"left",outline:"none",transition:"all 0.2s ease"}}),t.jsx(ee,{onClick:ke,variant:"secondary",style:{whiteSpace:"nowrap",minWidth:"fit-content",flexShrink:0,opacity:O()?1:.5,cursor:O()?"pointer":"not-allowed"},children:"New"})]})}),t.jsx("div",{className:"receipt-content",style:{padding:"1rem",display:"flex",flexDirection:"column",height:"100%"},children:t.jsxs("div",{style:{flex:1,display:"flex",flexDirection:"column",justifyContent:"flex-start",overflowY:"auto",marginBottom:"0.75rem"},children:[t.jsxs("div",{className:"receipt-item",style:{display:"flex",alignItems:"center",padding:"0.25rem 0",borderBottom:"1px solid var(--border)",flexShrink:0},children:[t.jsxs("div",{className:"receipt-controls",style:{width:"60px",textAlign:"center",position:"relative"},children:[t.jsx("button",{onClick:()=>V(Math.max(1,z-1)),style:{background:"var(--bg-secondary)",border:"1px solid var(--border)",color:"var(--text-primary)",borderRadius:"3px",padding:"0",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",minWidth:"18px",height:"18px",fontSize:"0.7rem",position:"absolute",left:"0",top:"50%",transform:"translateY(-50%)"},children:t.jsx(ct,{size:10})}),t.jsx("span",{style:{color:"var(--text-secondary)",fontSize:"0.9rem"},children:z}),t.jsx("button",{onClick:()=>V(z+1),style:{background:"var(--bg-secondary)",border:"1px solid var(--border)",color:"var(--text-primary)",borderRadius:"3px",padding:"0",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",minWidth:"18px",height:"18px",fontSize:"0.7rem",position:"absolute",right:"0",top:"50%",transform:"translateY(-50%)"},children:t.jsx(Xe,{size:10})})]}),t.jsx("div",{style:{flex:1,marginLeft:"1rem"},children:t.jsx("span",{style:{color:"var(--text-primary)",fontSize:"0.9rem"},children:"Party Size"})}),t.jsx("div",{style:{width:"120px",textAlign:"right"}})]}),E.map(g=>{var R;return g.type!=="adversary"?null:t.jsxs("div",{className:"receipt-item",style:{display:"flex",alignItems:"center",padding:"0.25rem 0",borderBottom:"1px solid var(--border)",flexShrink:0},children:[t.jsxs("div",{className:"receipt-controls",style:{width:"60px",textAlign:"center",position:"relative"},children:[t.jsx("button",{onClick:()=>ge(g.item.id,g.type),style:{background:g.quantity===0?"var(--danger)":"var(--bg-secondary)",border:g.quantity===0?"none":"1px solid var(--border)",color:g.quantity===0?"white":"var(--text-primary)",borderRadius:"3px",padding:"0",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",minWidth:"18px",height:"18px",fontSize:"0.7rem",position:"absolute",left:"0",top:"50%",transform:"translateY(-50%)"},children:g.quantity===0?t.jsx(nt,{size:10}):t.jsx(ct,{size:10})}),t.jsx("span",{style:{color:"var(--text-secondary)",fontSize:"0.9rem"},children:g.quantity}),t.jsx("button",{onClick:()=>De(g.item,g.type),style:{background:"var(--bg-secondary)",border:"1px solid var(--border)",color:"var(--text-primary)",borderRadius:"3px",padding:"0",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",minWidth:"18px",height:"18px",fontSize:"0.7rem",position:"absolute",right:"0",top:"50%",transform:"translateY(-50%)"},children:t.jsx(Xe,{size:10})})]}),t.jsx("div",{style:{flex:1,marginLeft:"1rem"},children:t.jsx("span",{style:{color:"var(--text-primary)",fontSize:"0.9rem"},children:g.item.baseName||((R=g.item.name)==null?void 0:R.replace(/\s+\(\d+\)$/,""))||g.item.name})}),t.jsx("div",{style:{width:"80px",textAlign:"right"},children:t.jsx("span",{style:{color:"var(--text-secondary)",fontSize:"0.8rem"},children:g.item.type})})]},`${g.item.id}-${g.type}`)}),t.jsxs("div",{className:"receipt-item",style:{display:"flex",alignItems:"center",padding:"0.25rem 0",borderBottom:"1px solid var(--border)",flexShrink:0},children:[t.jsx("div",{style:{flex:1,display:"flex",alignItems:"center"},children:t.jsx("span",{style:{color:"var(--text-primary)",fontSize:"0.9rem"},children:"Balance"})}),t.jsx("div",{style:{width:"120px",textAlign:"right",display:"flex",alignItems:"center",justifyContent:"flex-end"},children:t.jsx("span",{style:{color:Me>be?"var(--danger)":Me===be?"var(--purple)":"var(--success)",fontWeight:600},children:Me>be?`+${Me-be}`:be-Me===0?"0":`-${be-Me}`})})]})]})})]}),D==="create"&&t.jsxs("div",{style:{padding:"1.5rem",overflowY:"auto",height:"100%"},children:[t.jsx("h3",{style:{fontSize:"1.125rem",fontWeight:600,color:"var(--text-primary)",marginTop:0,marginBottom:"1rem"},children:"Creating Adversaries"}),t.jsxs("div",{style:{fontSize:"0.875rem",lineHeight:1.6,color:"var(--text-secondary)",display:"flex",flexDirection:"column",gap:"1rem"},children:[t.jsx("p",{children:"Use the form to create custom adversaries for your encounters."}),t.jsxs("div",{children:[t.jsx("strong",{style:{color:"var(--text-primary)"},children:"Adversary Types:"}),t.jsxs("ul",{style:{margin:"0.5rem 0",paddingLeft:"1.5rem"},children:[t.jsxs("li",{children:[t.jsx("strong",{children:"Minion (1 BP):"})," Weak enemies in groups"]}),t.jsxs("li",{children:[t.jsx("strong",{children:"Standard (2 BP):"})," Average threat level"]}),t.jsxs("li",{children:[t.jsx("strong",{children:"Leader (3 BP):"})," Commands others"]}),t.jsxs("li",{children:[t.jsx("strong",{children:"Bruiser (4 BP):"})," High HP tank"]}),t.jsxs("li",{children:[t.jsx("strong",{children:"Solo (5 BP):"})," Boss-level threat"]})]})]}),t.jsxs("div",{children:[t.jsx("strong",{style:{color:"var(--text-primary)"},children:"Tips:"}),t.jsxs("ul",{style:{margin:"0.5rem 0",paddingLeft:"1.5rem"},children:[t.jsx("li",{children:"Match adversary tier to party level"}),t.jsx("li",{children:"Balance encounter difficulty with Battle Points"}),t.jsx("li",{children:"Mix adversary types for variety"}),t.jsx("li",{children:"Add features that create interesting choices"})]})]})]})]}),D==="myAdversaries"&&t.jsx("div",{style:{padding:"0.75rem",overflowY:"auto",height:"100%"},children:T?(()=>{var R;const g=(R=_==null?void 0:_.adversaries)==null?void 0:R.find(W=>W.id===T);return g?t.jsx(pt,{item:{...g,hp:0,stress:0,isVisible:!0},type:"adversary",mode:"expanded",instances:[{...g,hp:0,stress:0,isVisible:!0}],onUpdate:()=>{},onDelete:()=>{}}):t.jsx("div",{style:{fontSize:"0.875rem",color:"var(--text-secondary)",textAlign:"center",padding:"2rem 0"},children:"Adversary not found"})})():t.jsxs("div",{children:[t.jsx("h3",{style:{fontSize:"1.125rem",fontWeight:600,color:"var(--text-primary)",marginTop:0,marginBottom:"1rem"},children:"Adversary Preview"}),t.jsx("div",{style:{fontSize:"0.875rem",color:"var(--text-secondary)",textAlign:"center",padding:"2rem 0"},children:"Select an adversary to view details"})]})})]})]})]})})},an=({browserOpenAtPosition:e,handleCloseBrowser:a,handleOpenBrowser:o,getEntityGroups:i,fear:d,updateFear:l})=>{const c=f.useRef(!1),u=f.useRef(null),p=f.useRef(null),x=f.useMemo(()=>({"shift+space":()=>{if(e!==null)a();else{const r=i();o(r.length)}},escape:()=>{e!==null&&a()},"+":()=>{const r=(d==null?void 0:d.value)||0,s=Math.min(12,r+1);l(s)},"=":()=>{const r=(d==null?void 0:d.value)||0,s=Math.min(12,r+1);l(s)},"-":()=>{const r=(d==null?void 0:d.value)||0,s=Math.max(0,r-1);l(s)},_:()=>{const r=(d==null?void 0:d.value)||0,s=Math.max(0,r-1);l(s)}}),[e,a,o,i,d,l]),m=f.useCallback(r=>{var z;if(window.matchMedia("(max-width: 800px)").matches)return;const n=r.key===" "||r.key==="Space"||r.code==="Space";if(r.shiftKey&&n&&!r.ctrlKey&&!r.metaKey&&!r.altKey){if(console.log("[Keyboard] Shift+Space detected, toggling browser"),r.preventDefault(),r.stopPropagation(),r.stopImmediatePropagation(),e!==null)a();else{const V=i();o(V.length)}return}const S=document.activeElement;if(S&&["INPUT","TEXTAREA","SELECT"].includes(S.tagName)){const V=r.key==="Escape",B=r.shiftKey&&n&&!r.ctrlKey&&!r.metaKey&&!r.altKey;if(!V&&!B)return}const $=[];(r.ctrlKey||r.metaKey)&&$.push("ctrl"),r.shiftKey&&$.push("shift"),r.altKey&&$.push("alt");let L=r.key.toLowerCase();L===" "&&(L="space"),$.push(L);const _=$.join("+");if(x[_]){r.preventDefault(),x[_](r);return}if(!r.ctrlKey&&!r.metaKey&&!r.shiftKey&&!r.altKey&&x[L]){r.preventDefault(),x[L](r);return}if(!r.ctrlKey&&!r.metaKey&&!r.shiftKey&&!r.altKey&&(r.key==="ArrowLeft"||r.key==="ArrowRight")){const V=document.activeElement;if(V&&["INPUT","TEXTAREA","SELECT"].includes(V.tagName))return;const B=document.querySelector(".dashboard-scroll-container");if(B){r.preventDefault(),console.log("[Keyboard] Dashboard scroll requested:",{key:r.key,currentScrollLeft:B.scrollLeft,containerWidth:B.clientWidth,scrollWidth:B.scrollWidth,scrollInProgress:c.current,browserOpen:e!==null});const F=Array.from(B.children).filter(E=>getComputedStyle(E).scrollSnapAlign!=="none");if(console.log("[Keyboard] Found panels:",{totalPanels:F.length,panelDetails:F.map((E,y)=>({index:y,offsetLeft:E.offsetLeft,offsetWidth:E.offsetWidth,scrollSnapAlign:getComputedStyle(E).scrollSnapAlign}))}),F.length>0){const E=B.scrollLeft;let y=0,H=1/0;F.forEach((C,v)=>{const j=C.offsetLeft,q=Math.abs(j-E);q<H&&(H=q,y=v)}),console.log("[Keyboard] Panel detection:",{currentScroll:E,currentPanelIndex:y,currentPanelOffsetLeft:(z=F[y])==null?void 0:z.offsetLeft,minDistance:H,allPanels:F.map((C,v)=>({index:v,offsetLeft:C.offsetLeft,distance:Math.abs(C.offsetLeft-E)}))});const Q=r.key==="ArrowLeft"?-1:1,D=y+Q;if(console.log("[Keyboard] Scrolling decision:",{scrollDirection:Q,currentPanelIndex:y,nextPanelIndex:D,canScroll:D>=0&&D<F.length}),D>=0&&D<F.length){const C=F[D],v=C.offsetLeft;console.log("[Keyboard] Scrolling to panel:",{index:D,offsetLeft:C.offsetLeft,offsetWidth:C.offsetWidth,targetScrollPosition:v,currentScroll:E,scrollInProgress:c.current}),u.current&&(clearTimeout(u.current),u.current=null),p.current=D,c.current?(console.log("[Keyboard] Redirecting scroll to new target",{previousTarget:p.current,newTarget:D,targetScrollPosition:v}),B.scrollTo({left:v,behavior:"smooth"})):(c.current=!0,C.scrollIntoView({behavior:"smooth",block:"nearest",inline:"start"})),u.current=setTimeout(()=>{if(p.current===D){const j=B.scrollLeft,q=C.offsetLeft,w=Math.abs(j-q);w>.5&&(console.log("[Keyboard] Correcting misalignment:",{finalScroll:j,expectedScroll:q,misalignment:w}),B.scrollTo({left:q,behavior:"auto"})),c.current=!1,p.current=null,console.log("[Keyboard] Scroll after action:",{newScrollLeft:B.scrollLeft,targetScrollPosition:v,difference:B.scrollLeft-E,actualDifference:B.scrollLeft-v,misalignment:w})}u.current=null},600)}else console.log("[Keyboard] Cannot scroll - panel index out of bounds")}else{console.log("[Keyboard] No panels found, using fallback scroll");const E=B.firstElementChild;if(E){const y=E.offsetWidth,H=r.key==="ArrowLeft"?-1:1;B.scrollBy({left:y*H,behavior:"smooth"})}}}else console.log("[Keyboard] Scroll container not found")}},[x,e,a,o,i]);f.useEffect(()=>(document.addEventListener("keydown",m,!0),()=>{document.removeEventListener("keydown",m,!0)}),[m])},ln=({position:e="top",children:a,onClick:o,className:i="",style:d={}})=>{const l=e==="top",c=window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0||document.referrer.includes("android-app://"),u={background:"var(--bg-primary)",borderTop:l?"none":"1px solid var(--border)",borderBottom:l?"1px solid var(--border)":"none",padding:l?"0.25rem 0":"0.5rem",paddingBottom:l?"0.25rem":c?"calc(0.5rem + env(safe-area-inset-bottom) + 1rem)":"calc(0.5rem + env(safe-area-inset-bottom))",position:l?"relative":"sticky",[l?"top":"bottom"]:0,zIndex:l?10:100,order:l?1:3,flexShrink:0,touchAction:"manipulation",userSelect:"none",display:"flex",flexDirection:l?"column":"row",justifyContent:l?"stretch":"center",alignItems:l?"stretch":"center",gap:l?"0":"1rem",height:l?"auto":"60px",...d};return t.jsx("div",{className:i,style:u,onClick:o,children:a})},dn=({fearValue:e,onUpdateFear:a,onToggleBrowser:o,isBrowserOpen:i})=>t.jsx(ln,{position:"top",children:t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"1rem",width:"100%",justifyContent:"space-between",padding:"0 1rem"},children:[t.jsx(ut,{type:"fear",value:e,maxValue:12,onChange:a,showTooltip:!1,enableBoundaryClick:!0,clickContainerWidth:"100%",centerPips:!0}),t.jsx("button",{onClick:o,title:i?"Close Browser":"Add Adversaries",style:{width:"36px",height:"36px",padding:0,backgroundColor:i?"var(--purple)":"transparent",border:"1px solid var(--border)",borderRadius:"50%",color:i?"white":"var(--text-primary)",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",transition:"all 0.2s ease",flexShrink:0},onMouseEnter:d=>{i||(d.currentTarget.style.borderColor="var(--purple)",d.currentTarget.style.backgroundColor="var(--bg-secondary)")},onMouseLeave:d=>{i||(d.currentTarget.style.borderColor="var(--border)",d.currentTarget.style.backgroundColor="transparent")},children:t.jsx(Xe,{size:18})})]})}),cn=({isOpen:e,columnWidth:a,onClose:o,onCreateCustomAdversary:i,pcCount:d,updatePartySize:l,availableBattlePoints:c,spentBattlePoints:u,browserActiveTab:p,onTabChange:x,savedEncounters:m,loadEncounter:r,deleteEncounter:s,selectedCustomAdversaryId:n,onSelectCustomAdversary:h,onAddAdversaryFromBrowser:S})=>e?t.jsx("div",{style:{position:"absolute",top:`${je}px`,right:`${je}px`,bottom:`${je}px`,width:`${a}px`,zIndex:100,overflow:"visible"},children:t.jsx(Ct,{tabContent:t.jsxs(t.Fragment,{children:[t.jsxs("button",{onClick:i,style:{padding:"0.375rem 0.75rem",backgroundColor:"var(--purple)",border:"none",color:"white",borderRadius:"4px",cursor:"pointer",fontSize:"0.875rem",fontWeight:"600",display:"flex",alignItems:"center",gap:"0.5rem",transition:"opacity 0.2s ease"},onMouseEnter:b=>{b.currentTarget.style.opacity="0.9"},onMouseLeave:b=>{b.currentTarget.style.opacity="1"},children:[t.jsx(Xe,{size:16}),t.jsx("span",{children:"Add Custom"})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[t.jsx("span",{style:{color:"var(--text-primary)",fontSize:"0.875rem",fontWeight:"500"},children:"Party Size:"}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.25rem",border:"1px solid var(--border)",borderRadius:"4px",padding:"0.125rem 0.25rem",backgroundColor:"var(--bg-secondary)"},children:[t.jsx("button",{onClick:()=>l(Math.max(1,d-1)),style:{background:"transparent",border:"none",color:"var(--text-primary)",cursor:"pointer",padding:0,display:"flex",alignItems:"center",justifyContent:"center",minWidth:"18px",height:"18px",fontSize:"0.7rem"},onMouseEnter:b=>{b.currentTarget.style.color="var(--purple)"},onMouseLeave:b=>{b.currentTarget.style.color="var(--text-primary)"},children:t.jsx(ct,{size:12})}),t.jsx("span",{style:{color:"var(--text-primary)",fontSize:"0.875rem",fontWeight:"500",minWidth:"1.5rem",textAlign:"center"},children:d}),t.jsx("button",{onClick:()=>l(d+1),style:{background:"transparent",border:"none",color:"var(--text-primary)",cursor:"pointer",padding:0,display:"flex",alignItems:"center",justifyContent:"center",minWidth:"18px",height:"18px",fontSize:"0.7rem"},onMouseEnter:b=>{b.currentTarget.style.color="var(--purple)"},onMouseLeave:b=>{b.currentTarget.style.color="var(--text-primary)"},children:t.jsx(Xe,{size:12})})]})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[t.jsx("span",{style:{color:"var(--text-primary)",fontSize:"0.875rem",fontWeight:"500"},children:"Balance:"}),t.jsx("span",{style:{color:u>c?"var(--danger)":u===c?"var(--purple)":"var(--success)",fontWeight:600,fontSize:"0.875rem"},children:u>c?`+${u-c}`:c-u===0?"0":`-${c-u}`})]}),o&&t.jsx("button",{onClick:o,style:{background:"none",border:"none",color:"var(--text-secondary)",cursor:"pointer",padding:"0.25rem",borderRadius:"4px",display:"flex",alignItems:"center",justifyContent:"center",transition:"color 0.2s ease",flexShrink:0},onMouseEnter:b=>b.currentTarget.style.color="var(--text-primary)",onMouseLeave:b=>b.currentTarget.style.color="var(--text-secondary)",title:"Close browser",children:t.jsx(nt,{size:16})})]}),showTab:!0,tabBackgroundColor:"var(--bg-primary)",tabBorderColor:"var(--border)",tabJustifyContent:"space-between",containerBackgroundColor:"var(--bg-primary)",containerBorderColor:"var(--border)",containerBorderRadius:"8px",containerBoxShadow:"-4px 0 12px rgba(0, 0, 0, 0.3)",containerOverflow:"hidden",reserveTabSpace:!0,containerStyle:{height:"100%"},children:t.jsx("div",{style:{flex:1,overflowY:"auto",overflowX:"hidden",minHeight:0,display:"flex",flexDirection:"column",width:"100%",minWidth:0},children:t.jsx(nr,{type:"adversary",onAddItem:S,showContainer:!1,activeTab:p,onTabChange:x,pcCount:d,savedEncounters:m,onLoadEncounter:r,onDeleteEncounter:s,selectedCustomAdversaryId:n,onSelectCustomAdversary:h,autoFocus:!0,hideImportExport:!0,onClose:o,searchPlaceholder:"Search adversaries"})})})}):null,bt=({side:e="left",children:a,className:o="",style:i={}})=>{const d=e==="left",l={flex:1,minWidth:0,background:"var(--bg-primary)",overflowY:"auto",overflowX:d?"auto":"hidden",display:d?"block":"flex",flexDirection:d?"initial":"column",height:"100%",padding:d?"8px 0 8px 0":"0 8px 0 0",...i};return t.jsx("div",{className:o,style:l,children:a})},un=({entityGroups:e,columnWidth:a,scrollContainerRef:o,onScroll:i,newCards:d,removingCardSpacer:l,spacerShrinking:c,browserOpenAtPosition:u,editingAdversaryId:p,handleSaveCustomAdversary:x,handleCancelEdit:m,updateAdversary:r,updateEnvironment:s,updateCountdown:n,adversaries:h,handleEditAdversary:S,createAdversary:b,createAdversariesBulk:$,pcCount:L,smoothScrollTo:_,getEntityGroups:z,deleteAdversary:V,setRemovingCardSpacer:B,setSpacerShrinking:F})=>t.jsxs("div",{ref:o,className:"dashboard-scroll-container",onScroll:i,children:[e.length===0?null:(()=>{const E=[];if(e.forEach((y,H)=>{var D,C,v;if(l&&l.baseName===y.baseName&&y.type==="adversary"){E.push(t.jsx(bt,{style:{width:c?"0px":`${a}px`,flexShrink:0,flexGrow:0,flex:"none",paddingRight:"0",paddingTop:c?"0px":`${je}px`,paddingBottom:c?"0px":`${je}px`,scrollSnapAlign:"none",overflow:"hidden",display:"flex",flexDirection:"column",alignItems:"stretch",height:"100%",opacity:0,transition:"width 0.3s ease, padding-top 0.3s ease, padding-bottom 0.3s ease"}},`spacer-${l.baseName}`));return}E.push(t.jsx(bt,{className:H===0?"dashboard-column dashboard-column--first":H===e.length-1?"dashboard-column dashboard-column--last":"dashboard-column",style:{width:`${a}px`,flexShrink:0,flexGrow:0,flex:"none",paddingRight:"0",paddingTop:`${y.type==="adversary"?je+at:je}px`,paddingBottom:`${je}px`,scrollSnapAlign:"start",overflow:y.type==="adversary"?"visible":"hidden",display:"flex",flexDirection:"column",alignItems:"stretch",height:"auto",opacity:d.has(`${y.type}-${y.baseName}`)?0:1,transition:"opacity 0.2s ease"},children:t.jsx(pt,{type:y.type,item:{...y.instances[0],name:((D=y.instances[0])==null?void 0:D.name)||y.baseName,hp:0,stress:0,isDead:!1},mode:"expanded",instances:y.instances,showCustomCreator:y.type==="adversary"&&p&&y.instances.some(j=>j.id===p),onSaveCustomAdversary:y.type==="adversary"&&p&&y.instances.some(j=>j.id===p)?x:void 0,onCancelEdit:y.type==="adversary"&&p&&y.instances.some(j=>j.id===p)?m:void 0,isStockAdversary:y.type==="adversary"&&p&&y.instances.some(j=>j.id===p)?!((C=y.instances[0])!=null&&C.source)||((v=y.instances[0])==null?void 0:v.source)!=="Homebrew":!1,onApplyDamage:y.type==="adversary"?(j,q)=>{const w=y.instances.find(T=>T.id===j);w&&r(j,{hp:Math.min(w.hpMax||1,(w.hp||0)+q)})}:void 0,onApplyHealing:y.type==="adversary"?(j,q)=>{const w=y.instances.find(T=>T.id===j);w&&r(j,{hp:Math.max(0,(w.hp||0)-q)})}:void 0,onApplyStressChange:y.type==="adversary"?(j,q)=>{var w,T;return r(j,{stress:Math.max(0,Math.min(((w=y.instances.find(k=>k.id===j))==null?void 0:w.stressMax)||6,(((T=y.instances.find(k=>k.id===j))==null?void 0:T.stress)||0)+q))})}:void 0,onUpdate:y.type==="adversary"?r:y.type==="environment"?s:n,adversaries:h,showAddRemoveButtons:u!==null&&y.type==="adversary",onEdit:y.type==="adversary"?j=>S(j):void 0,onAddInstance:y.type==="adversary"?j=>{const q=j.type==="Minion",w=q?L:1;if(q&&w>1){const T=Array(w).fill(null).map(()=>({...j}));$(T)}else b(j);setTimeout(()=>{requestAnimationFrame(()=>{requestAnimationFrame(()=>{if(!o.current)return;const T=o.current,k=T.scrollLeft,A=T.clientWidth,K=u!==null?A-(a+je):A,P=z().findIndex(re=>re.baseName===y.baseName&&re.type==="adversary");if(P>=0){const re=je+P*(a+je),O=re+a,ee=10;re>=k-ee&&O<=k+K+ee||_(re,500)}})})},50)}:void 0,onRemoveInstance:y.type==="adversary"?()=>{const j=y.instances[0],w=(j==null?void 0:j.type)==="Minion"?L:1,T=y.instances.sort((M,P)=>{const re=M.duplicateNumber||1;return(P.duplicateNumber||1)-re}),A=Math.max(0,T.length-w)===0;if(T.length===0)return;const K=T.slice(0,w);if(A){const M=e.findIndex(O=>O.baseName===y.baseName&&O.type==="adversary"),P=M===0;let re=!1;if(o.current){const O=o.current,ee=O.scrollLeft,de=O.scrollWidth-O.clientWidth;re=Math.abs(ee-de)<1}B({baseName:y.baseName,groupIndex:M}),F(!1),P&&o.current&&(o.current.style.scrollSnapType="none"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{o.current&&o.current.offsetHeight,K.forEach(O=>{V(O.id)}),requestAnimationFrame(()=>{requestAnimationFrame(()=>{o.current&&o.current.offsetHeight,setTimeout(()=>{if(F(!0),re&&o.current){const O=performance.now(),ee=300,de=()=>{if(!o.current)return;const he=o.current,Le=he.scrollWidth-he.clientWidth;he.scrollLeft=Le,performance.now()-O<ee&&requestAnimationFrame(de)};requestAnimationFrame(de)}setTimeout(()=>{if(B(null),F(!1),P&&o.current&&(o.current.style.scrollSnapType="x mandatory"),re&&o.current){const O=o.current;O.scrollLeft=O.scrollWidth-O.clientWidth}},300)},50)})})})})}else K.forEach(M=>{V(M.id)})}:void 0})},`${y.type}-${y.baseName}`))}),l&&!E.some(y=>(y==null?void 0:y.key)===`spacer-${l.baseName}`)){const y=Math.min(l.groupIndex,E.length);E.splice(y,0,t.jsx(bt,{className:"dashboard-column",style:{width:c?"0px":`${a}px`,flexShrink:0,flexGrow:0,flex:"none",paddingRight:"0",paddingTop:c?"0px":`${je}px`,paddingBottom:c?"0px":`${je}px`,scrollSnapAlign:"none",overflow:"hidden",display:"flex",flexDirection:"column",alignItems:"stretch",height:"100%",opacity:0,transition:"width 0.3s ease, padding-top 0.3s ease, padding-bottom 0.3s ease"}},`spacer-${l.baseName}`))}return E})(),u!==null&&t.jsx("div",{style:{width:`${a}px`,flexShrink:0,flexGrow:0,flex:"none",height:"100%"}})]}),pn=(e=[])=>e.reduce((a,o)=>{var d;const i=o.baseName||((d=o.name)==null?void 0:d.replace(/\s+\(\d+\)$/,""))||o.name||"Unknown";return a[i]||(a[i]={type:"adversary",baseName:i,instances:[]}),a[i].instances.push(o),a},{}),mn=(e,a,o,i)=>{const d=f.useRef(a);f.useEffect(()=>{const l=d.current;if(l!==a&&l>0){const c=pn(e);Object.values(c).forEach(u=>{if(u.type!=="adversary"||u.instances.length===0)return;const p=u.instances[0];if(p.type!=="Minion")return;const x=u.instances.length,r=Math.ceil(x/l)*a;if(r!==x)if(r>x){const s=r-x,n=Array(s).fill(null).map(()=>({...p}));o(n)}else{const s=x-r;u.instances.slice(-s).forEach(h=>i(h.id))}}),d.current=a}else(l===0||d.current===0)&&(d.current=a)},[e,a,o,i])},Gt=e=>e===1?200:350,fn=e=>{if(e<=0)return{visibleColumns:1,columnWidth:Gt(1)};const a=e-je*2;let o={visibleColumns:1,columnWidth:a};for(let d=1;d<=5;d+=1){const l=(d-1)*je,c=(a-l)/d;c>=Gt(d)&&d*c+l<=a&&(o={visibleColumns:d,columnWidth:c})}return o.visibleColumns*o.columnWidth+(o.visibleColumns-1)*je>a&&(o={visibleColumns:1,columnWidth:a}),o},hn=()=>typeof window>"u"?0:window.innerWidth,xn=e=>{const[a,o]=f.useState(hn),i=f.useMemo(()=>fn(a),[a]);return f.useLayoutEffect(()=>{const d=()=>{e.current?o(e.current.clientWidth):typeof window<"u"&&o(window.innerWidth)};d();const l=()=>d();window.addEventListener("resize",l);let c;return typeof ResizeObserver<"u"&&e.current&&(c=new ResizeObserver(()=>{e.current&&o(e.current.clientWidth)}),c.observe(e.current)),()=>{window.removeEventListener("resize",l),c&&c.disconnect()}},[e]),{gap:je,columnWidth:i.columnWidth,visibleColumns:i.visibleColumns}};class gn extends Ke.Component{constructor(a){super(a),this.state={hasError:!1,error:null}}static getDerivedStateFromError(a){return{hasError:!0,error:a}}componentDidCatch(a,o){console.error("ErrorBoundary caught an error:",a,o)}render(){var a;return this.state.hasError?t.jsxs("div",{className:"p-md text-red",children:[t.jsx("h3",{children:"Something went wrong:"}),t.jsx("pre",{children:(a=this.state.error)==null?void 0:a.toString()}),t.jsx("button",{className:"btn-base btn-text",onClick:()=>this.setState({hasError:!1,error:null}),children:"Try again"})]}):this.props.children}}const yn=({scrollContainerRef:e,columnWidth:a,onCloseReset:o})=>{const[i,d]=f.useState(null),l=f.useCallback(u=>{if(d(u),e.current){const p=e.current,x=p.scrollLeft,m=p.scrollWidth-p.clientWidth,r=Math.abs(x-m)<1;p._scrollBeforeBrowserOpen=x,p._scrollWidthBeforeOpen=p.scrollWidth,p._wasAtMaxScrollBeforeBrowserOpen=r}},[e]),c=f.useCallback(()=>{if(e.current){const u=e.current;u._scrollBeforeBrowserClose=u.scrollLeft,u._scrollWidthBeforeClose=u.scrollWidth}d(null),o==null||o()},[e,o]);return f.useEffect(()=>{e.current&&requestAnimationFrame(i!==null?()=>{requestAnimationFrame(()=>{if(!e.current)return;const u=e.current,p=u._wasAtMaxScrollBeforeBrowserOpen,x=u._scrollBeforeBrowserOpen||0;u.scrollLeft=x,delete u._scrollBeforeBrowserOpen,delete u._wasAtMaxScrollBeforeBrowserOpen})}:()=>{requestAnimationFrame(()=>{if(!e.current)return;const u=e.current,p=u._scrollBeforeBrowserClose||0,x=u.scrollWidth-u.clientWidth,m=Math.min(p,x);u.scrollLeft=m,delete u._scrollBeforeBrowserClose})})},[i,a,e]),{browserOpenAtPosition:i,handleOpenBrowser:l,handleCloseBrowser:c}},vn=e=>f.useCallback((a,o=500)=>{if(!e.current)return;const i=e.current,d=i.scrollLeft,l=a-d;if(Math.abs(l)<1)return;i._horizontalScrollAnimationId&&(cancelAnimationFrame(i._horizontalScrollAnimationId),i._horizontalScrollAnimationId=null),window.getComputedStyle(i).scrollSnapType!=="none"&&(i.style.scrollSnapType="none");const p=performance.now(),x=m=>{const r=m-p,s=Math.min(r/o,1),n=1-s,h=1-n*n*n;if(i){const S=d+l*h;i.scrollLeft=S}s<1?i._horizontalScrollAnimationId=requestAnimationFrame(x):i&&(i.scrollLeft=a,i._horizontalScrollAnimationId=null)};i._horizontalScrollAnimationId=requestAnimationFrame(x)},[e]),bn=(e,a)=>{const o=f.useCallback(()=>{const d={};return e.forEach(l=>{var u;const c=l.baseName||((u=l.name)==null?void 0:u.replace(/\s+\(\d+\)$/,""))||l.name;d[c]||(d[c]={type:"adversary",baseName:c,instances:[]}),d[c].instances.push(l)}),a.forEach(l=>{d[`countdown-${l.id}`]={type:"countdown",baseName:l.name,instances:[l]}}),Object.values(d)},[e,a]);return{entityGroups:f.useMemo(()=>o(),[o]),getEntityGroups:o}},wn=({entityGroups:e,pcCount:a,scrollContainerRef:o,createAdversariesBulk:i,createAdversary:d,setNewCards:l,getEntityGroups:c,smoothScrollTo:u,browserOpenAtPosition:p,columnWidth:x})=>f.useCallback(m=>{var _,z,V;const r=m.baseName||((_=m.name)==null?void 0:_.replace(/\s+\(\d+\)$/,""))||m.name,n=!e.find(B=>B.baseName===r&&B.type==="adversary"),h=m.type==="Minion",S=h?a:1,b=((z=o.current)==null?void 0:z.scrollWidth)??0,$=((V=o.current)==null?void 0:V.scrollLeft)??0,L=o.current;if(L&&n&&window.getComputedStyle(L).scrollSnapType!=="none"&&(L.style.scrollSnapType="none"),h&&S>1){const B=Array(S).fill(null).map(()=>({...m}));i(B)}else d(m);if(n){const B=`adversary-${r}`;l(F=>new Set(F).add(B)),setTimeout(()=>{l(F=>{const E=new Set(F);return E.delete(B),E})},10)}setTimeout(()=>{requestAnimationFrame(()=>{requestAnimationFrame(()=>{if(!o.current)return;const B=o.current;if(!(B.scrollWidth<=B.clientWidth))if(n){const F=B.scrollWidth;setTimeout(()=>{if(!o.current)return;const E=o.current,y=()=>{if(!o.current)return;const H=o.current,Q=H.scrollWidth-H.clientWidth,D=Q-$;H.scrollWidth>b&&Math.abs(D)<1?u(Q+10,500):Math.abs(D)>1&&u(Q,500)};E.scrollWidth!==F?requestAnimationFrame(()=>{requestAnimationFrame(()=>{y()})}):y()},10)}else{const E=c().findIndex(y=>y.baseName===r&&y.type==="adversary");if(E>=0){const y=o.current,H=y.scrollLeft,Q=y.clientWidth,D=p!==null?Q-(x+je):Q,C=je+E*(x+je),v=C+x,j=10;C>=H-j&&v<=H+D+j||u(C,500)}}})})},50)},[p,x,i,d,e,c,a,o,l,u]);const Sn=()=>{const{adversaries:e,environments:a,countdowns:o,fear:i,savedEncounters:d,partySize:l,customContent:c,updatePartySize:u,updateFear:p,createAdversary:x,createAdversariesBulk:m,updateAdversary:r,deleteAdversary:s,addCustomAdversary:n,updateCustomAdversary:h,createEnvironment:S,updateEnvironment:b,deleteEnvironment:$,updateCountdown:L,deleteCountdown:_,saveEncounter:z,loadEncounter:V,deleteEncounter:B}=ft(),F=l||4,[E,y]=f.useState(!1),[H,Q]=f.useState(null),[D,C]=f.useState("adversaries"),[v,j]=f.useState(null),[q,w]=f.useState(new Set),[T,k]=f.useState(null),[A,K]=f.useState(!1),M=f.useRef(null);mn(e,F,m,s);const{columnWidth:P}=xn(M),{browserOpenAtPosition:re,handleOpenBrowser:O,handleCloseBrowser:ee}=yn({scrollContainerRef:M,columnWidth:P,onCloseReset:()=>C("adversaries")}),de=vn(M),he=f.useCallback(()=>{y(!1)},[]),{entityGroups:Le,getEntityGroups:be}=bn(e,o);an({browserOpenAtPosition:re,handleCloseBrowser:ee,handleOpenBrowser:O,getEntityGroups:be,fear:i,updateFear:p});const Me=wn({entityGroups:Le,pcCount:F,scrollContainerRef:M,createAdversariesBulk:m,createAdversary:x,setNewCards:w,getEntityGroups:be,smoothScrollTo:de,browserOpenAtPosition:re,columnWidth:P}),De=f.useCallback(()=>{const R="Standard",W=tt(1,R),Y={name:"",baseName:"",tier:1,type:R,description:"",motives:"",difficulty:W.difficulty,thresholds:W.thresholds,hpMax:W.hpMax,stressMax:W.stressMax,atk:W.atk,weapon:"",range:W.range,damage:W.damage,experience:[],features:[],source:"Homebrew",hp:0,stress:0,isVisible:!0};x(Y),setTimeout(()=>{const I=be();for(const ne of I)if(ne.type==="adversary"){const pe=ne.instances.find(Z=>Z.source==="Homebrew"&&(!Z.baseName||Z.baseName.trim()===""||Z.baseName==="Unknown"));if(pe&&!H){Q(pe.id),requestAnimationFrame(()=>{requestAnimationFrame(()=>{if(M.current){const Z=I.findIndex(J=>J.instances.some(se=>se.id===pe.id));if(Z>=0){const J=je+Z*(P+je);de(J,600,"new-custom-adversary")}}})});break}}},100)},[x,be,P,de,H]),te=f.useCallback(g=>{Q(g)},[]),ge=f.useCallback(()=>{Q(null)},[]),ue=f.useCallback(async(g,R)=>{var W,Y;if(R){const I=e.find(pe=>pe.id===R);if((I==null?void 0:I.source)==="Homebrew"||(I==null?void 0:I.isCustom)){const pe=I==null?void 0:I.customContentId,Z=I==null?void 0:I.baseName,J=pe?(W=c==null?void 0:c.adversaries)==null?void 0:W.find(se=>se.id===pe):(Y=c==null?void 0:c.adversaries)==null?void 0:Y.find(se=>se.baseName===Z&&(se.source==="Homebrew"||se.isCustom));if(J){const se={...g,name:g.baseName||g.name};h(J.id,se);const Ce=g.baseName||(I==null?void 0:I.baseName);e.forEach(Ae=>{(Ae.customContentId===pe||Ae.baseName===Ce&&(Ae.source==="Homebrew"||Ae.isCustom))&&r(Ae.id,{...g,customContentId:J.id})})}else{const se={...g,name:g.baseName||g.name},Ce=n(se),Ae=g.baseName||(I==null?void 0:I.baseName);e.forEach(Re=>{Re.baseName===Ae&&(Re.source==="Homebrew"||Re.isCustom)&&r(Re.id,{...g,customContentId:Ce})})}}else{const pe=I==null?void 0:I.baseName,Z=e.filter(Ce=>{const Ae=Ce.baseName===pe,Re=!Ce.source||Ce.source!=="Homebrew"&&!Ce.isCustom;return Ae&&Re}),J={...g,name:g.baseName||g.name},se=n(J);Z.forEach(Ce=>{s(Ce.id)}),setTimeout(()=>{const Ce=Z.map(()=>({...g,source:"Homebrew",isCustom:!0,customContentId:se,hp:0,stress:0}));Ce.length>0&&m(Ce)},0)}Q(null)}else if(H){const I={...g,name:g.baseName||g.name},ne=n(I),pe=x({...g,source:"Homebrew",isCustom:!0,customContentId:ne});return Q(null),pe}else{const I={...g,name:g.baseName||g.name},ne=n(I);return x({...g,source:"Homebrew",isCustom:!0,customContentId:ne})}},[H,e,c,x,r,n,h,m,s]),ke=f.useCallback(()=>{const g={};return e.forEach(R=>{var Y;const W=R.baseName||((Y=R.name)==null?void 0:Y.replace(/\s+\(\d+\)$/,""))||R.name;g[W]||(g[W]={type:"adversary",item:R,quantity:0}),g[W].quantity+=1}),Object.values(g)},[e])(),ze=tr(ke),Pe=Ut(F)+ze,Ue=er(ke,F),$e=f.useRef(null),et=f.useCallback(g=>{$e.current&&clearTimeout($e.current),$e.current=setTimeout(()=>{const R=g.target;R&&R.style.scrollSnapType==="none"&&(R.style.scrollSnapType="x mandatory")},150)},[]);return t.jsxs("div",{className:"app dashboard-root",style:{"--dashboard-gap":`${je}px`},onClick:g=>{g.target,g.currentTarget},children:[t.jsx(dn,{fearValue:(i==null?void 0:i.value)||0,onUpdateFear:p,isBrowserOpen:re!==null,onToggleBrowser:()=>{re!==null?ee():O(Le.length)}}),t.jsxs("div",{className:"dashboard-main",children:[t.jsx(cn,{isOpen:re!==null,columnWidth:P,onClose:ee,onCreateCustomAdversary:De,pcCount:F,updatePartySize:u,availableBattlePoints:Pe,spentBattlePoints:Ue,browserActiveTab:D,onTabChange:C,savedEncounters:d,loadEncounter:V,deleteEncounter:B,selectedCustomAdversaryId:v,onSelectCustomAdversary:j,onAddAdversaryFromBrowser:Me}),t.jsx(un,{entityGroups:Le,columnWidth:P,scrollContainerRef:M,onScroll:et,newCards:q,removingCardSpacer:T,spacerShrinking:A,browserOpenAtPosition:re,editingAdversaryId:H,handleSaveCustomAdversary:ue,handleCancelEdit:ge,updateAdversary:r,updateEnvironment:b,updateCountdown:L,adversaries:e,handleEditAdversary:te,createAdversary:x,createAdversariesBulk:m,pcCount:F,smoothScrollTo:de,getEntityGroups:be,deleteAdversary:s,setRemovingCardSpacer:k,setSpacerShrinking:K})]}),t.jsx(on,{isOpen:E,onClose:he,onAddAdversary:g=>{x(g)},onAddAdversariesBulk:g=>{m(g)},onAddEnvironment:g=>{S(g)},onDeleteAdversary:s,onDeleteEnvironment:$,onDeleteCountdown:_,adversaries:e,environments:a,countdowns:o,savedEncounters:d,onSaveEncounter:z,onLoadEncounter:V,onDeleteEncounter:B}),t.jsx(zr,{})]})},Cn=()=>{const{isLoaded:e}=ft();return e?t.jsx(gn,{children:t.jsx(Sn,{})}):t.jsx("div",{className:"app loading-state",children:t.jsx("div",{className:"loading-placeholder","aria-hidden":"true"})})};St.createRoot(document.getElementById("root")).render(t.jsx(Ke.StrictMode,{children:t.jsx(Nr,{children:t.jsx(Cn,{})})}));
